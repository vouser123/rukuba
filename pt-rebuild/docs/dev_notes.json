{
  "metadata": {
    "schema_version": "1.6.0",
    "last_updated": "2026-03-02"
  },
  "enums": {
    "priority_levels": [
      {
        "value": "P0",
        "definition": "Critical: production-breaking or patient-safety/security risk; address immediately."
      },
      {
        "value": "P1",
        "definition": "High: major functionality degraded or high regression risk; schedule next."
      },
      {
        "value": "P2",
        "definition": "Normal: meaningful improvement or bugfix; prioritize with roadmap context."
      },
      {
        "value": "P3",
        "definition": "Low: polish, cleanup, or non-urgent enhancement."
      }
    ],
    "risk_levels": [
      {
        "value": "high",
        "definition": "Likely to cause data loss, auth bypass, or severe workflow failure if wrong."
      },
      {
        "value": "medium",
        "definition": "Could disrupt workflows or require manual recovery; moderate blast radius."
      },
      {
        "value": "low",
        "definition": "Limited impact; straightforward rollback/recovery expected."
      }
    ],
    "status_values": [
      {
        "value": "open",
        "definition": "Tracked and ready for intake/execution."
      },
      {
        "value": "in_progress",
        "definition": "Actively being implemented or investigated."
      },
      {
        "value": "blocked",
        "definition": "Cannot proceed pending dependency/decision/access."
      },
      {
        "value": "done",
        "definition": "Completed and close-looped with dated entry."
      }
    ],
    "tag_vocabulary": [
      {
        "value": "ui",
        "definition": "Interface/UX behavior and rendering."
      },
      {
        "value": "ios",
        "definition": "Apple device or Safari-specific behavior."
      },
      {
        "value": "pwa",
        "definition": "Progressive web app install/offline shell concerns."
      },
      {
        "value": "offline",
        "definition": "Offline queueing/sync and local persistence paths."
      },
      {
        "value": "supabase",
        "definition": "Supabase platform, SQL, RLS, or client usage."
      },
      {
        "value": "auth",
        "definition": "Authentication/authorization concerns."
      },
      {
        "value": "sync",
        "definition": "Sync pipeline and idempotent mutation handling."
      },
      {
        "value": "data-model",
        "definition": "Schema, relationships, or record-shape correctness."
      },
      {
        "value": "api",
        "definition": "Serverless endpoint logic and request/response behavior."
      },
      {
        "value": "performance",
        "definition": "Latency, throughput, or resource-usage optimization."
      },
      {
        "value": "reliability",
        "definition": "Fault tolerance, retries, and consistency guarantees."
      },
      {
        "value": "security",
        "definition": "Access control, privacy, and exploit prevention."
      },
      {
        "value": "migration",
        "definition": "Database/data migration planning and execution."
      },
      {
        "value": "docs",
        "definition": "Documentation or workflow process updates."
      },
      {
        "value": "cleanup",
        "definition": "Refactors, debt paydown, and housekeeping."
      },
      {
        "value": "email",
        "definition": "Notification or email delivery behavior."
      },
      {
        "value": "lcp",
        "definition": "Largest Contentful Paint and first-render metrics."
      },
      {
        "value": "notifications",
        "definition": "In-app or push notification behavior."
      }
    ],
    "scope_values": [
      {
        "value": "current",
        "definition": "Applies to the current deployment. Default when field is absent."
      },
      {
        "value": "deferred",
        "definition": "Valid concern but not applicable at current deployment scale or configuration. See reactivate_when for trigger condition."
      }
    ],
    "agent_values": {
      "field_type": "array — one or more of the values below. Required on all open items.",
      "values": [
        {
          "value": "codex",
          "definition": "Task is suitable for Codex: spec is complete, implementation is mechanical or pattern-matching, no design decisions required before coding."
        },
        {
          "value": "claude",
          "definition": "Task requires Claude: spec is incomplete, involves investigation, architectural judgment, or design decisions before coding."
        },
        {
          "value": "unassigned",
          "definition": "Agent not yet determined. Surface for triage before execution."
        }
      ],
      "note": "Use [\"codex\", \"claude\"] when either agent can handle the task. Never use an empty array — use [\"unassigned\"] if unsure."
    },
    "reactivate_triggers": [
      {
        "value": "deployment_scope_change",
        "definition": "Re-evaluate when the user base or deployment model changes (e.g. adding users beyond the current two-person setup). Requires explicit human decision — no automatic condition check."
      },
      {
        "value": "query_volume_sufficient",
        "definition": "Re-evaluate when the app has sustained real-user query traffic sufficient to make index usage data meaningful."
      },
      {
        "value": "api_capacity_available",
        "definition": "Re-evaluate when Vercel function slot count is no longer a constraint (e.g. plan upgrade or function consolidation)."
      }
    ]
  },
  "open_items": [
    {
      "id": "DN-041",
      "status": "resolved",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": ["claude"],
      "tags": ["migration", "ui"],
      "file": "pt-rebuild/pages/program.js, pt-rebuild/pages/program.module.css, pt-rebuild/lib/pt-editor.js, pt-rebuild/components/ExerciseForm.js, pt-rebuild/components/ExerciseFormCore.js, pt-rebuild/components/ExerciseFormCues.js, pt-rebuild/components/ExerciseFormLifecycle.js, pt-rebuild/components/ExerciseForm.module.css, pt-rebuild/components/NavMenu.js, pt-rebuild/lib/handlers/exercises.js",
      "issue": "Phase 3a: migrate pt_editor exercise management to Next.js at /program. Covers exercise list, add/edit exercises (all 8 form sections), auth guard, NavMenu. Roles editing (Phase 3b) and vocab editor (Phase 3c) are follow-on phases.",
      "resolved": "2026-03-01",
      "context": "Page file: pages/program.js. Route: /program. URL chosen over /pt (conflicts with vercel.json rewrite), /edit (too generic), /exercises (too narrow). Components split per STRUCTURE_GUIDELINES caps: ExerciseFormCore (sections 1-4), ExerciseFormCues (sections 5, 7, 8), ExerciseFormLifecycle (section 6 — extracted for supersedes support), ExerciseForm (orchestrator). Roles section within form is read-only display in Phase 3a — editing is Phase 3b. API: uses existing /api/exercises, /api/vocab, /api/reference-data — no new API routes. NavMenu label updated to 'Program Editor'. Lifecycle decisions: deprecated = permanently hidden (never shows in list); archived = temporarily set aside (shows with Show archived toggle); lifecycle section extracted to ExerciseFormLifecycle.js to support supersedes dropdown without polluting ExerciseFormCues. Supersedes: DB migration added supersedes_exercise_id column; PUT handler writes bi-directional (supersedes_exercise_id on A, superseded_by_exercise_id + superseded_date on B). Verified on Vercel preview 2026-03-01: 34 exercises load, form populates correctly, Lifecycle & Status section renders with status dropdown (active/archived/deprecated), hint text, effective dates, supersedes dropdown (all other exercises populated, current excluded), superseded-by display. No console errors.",
      "constraints_caveats": "POST/PUT /api/exercises returns raw DB row, not full normalized object — page re-fetches all exercises after save. Do not create new API routes (currently 9/12 Vercel slots used). Supersedes validation: exercise cannot supersede itself (handler returns 400)."
    },
    {
      "id": "DN-039",
      "status": "in_progress",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "docs",
        "reliability"
      ],
      "file": "pt-rebuild/docs/NEXTJS_MIGRATION.md",
      "issue": "Document current Vercel CLI command syntax used for migration verification to avoid repeated failures from outdated flags.",
      "resolved": null,
      "context": "Recent verification work hit CLI syntax changes (e.g., list/inspect/logs flags). Migration file is the most-read current workflow doc and should carry a concise, dated reference.",
      "constraints_caveats": "Keep this as short operational guidance; do not duplicate full CLI manuals."
    },
    {
      "id": "DN-038",
      "status": "in_progress",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "cleanup",
        "docs",
        "reliability"
      ],
      "file": "pt-rebuild/package.json, pt-rebuild/playwright.config.js, pt-rebuild/tests/smoke.spec.js",
      "issue": "Set up Playwright test runner and add a minimal smoke test workflow that can be run from VS Code or terminal.",
      "resolved": null,
      "context": "User installed Playwright VS Code extension and requested Codex to set up dependencies plus a first smoke test.",
      "constraints_caveats": "Keep setup lightweight and avoid hardcoding credentials. Use environment variables for any optional authenticated flow."
    },
    {
      "id": "DN-033",
      "status": "in_progress",
      "priority": "P2",
      "risk": "medium",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "migration",
        "ui"
      ],
      "file": "pt-rebuild/package.json, pt-rebuild/next.config.mjs, pt-rebuild/pages/rehab.js, pt-rebuild/pages/rehab.module.css, pt-rebuild/pages/_app.js, pt-rebuild/lib/rehab-coverage.js, pt-rebuild/lib/supabase.js, pt-rebuild/hooks/useAuth.js, pt-rebuild/components/NavMenu.js, pt-rebuild/components/NavMenu.module.css, pt-rebuild/components/AuthForm.js, pt-rebuild/components/AuthForm.module.css, pt-rebuild/styles/globals.css",
      "issue": "Strangler Fig migration to Next.js (Pages Router). Existing static HTML pages remain untouched; new pages built in Next.js one at a time. Phase 1: scaffolding + shared architecture (lib/supabase.js, hooks/useAuth.js, components/NavMenu.js, components/AuthForm.js) + rehab_coverage migrated to pages/rehab.js.",
      "resolved": null,
      "context": "Phase 1 and Phase 2 complete on nextjs branch. Pre-migration cleanup (DN-035) done: PatientNotes + HistoryList extracted to components/, pt-view.module.css 670L→369L. Phases verified on Vercel preview (https://pt-rehab-git-nextjs-pt-tracker.vercel.app). Phase 1: /rehab — Coverage Analysis. Phase 2: /pt-view — History Dashboard. Components: lib/supabase.js, hooks/useAuth.js, hooks/useMessages.js, components/NavMenu.js, components/AuthForm.js, components/MessagesModal.js, components/ExerciseHistoryModal.js, components/PatientNotes.js, components/HistoryList.js, lib/rehab-coverage.js, lib/pt-view.js, pages/rehab.js, pages/pt-view.js, CSS modules for all. Vanilla JS pages untouched. Phase 3a complete (DN-041): pt_editor → /program. Exercise management (list, add/edit, lifecycle, supersedes) verified on preview 2026-03-01. Phase 3b next: roles editing + dosage management.",
      "constraints_caveats": "Never create pages/index.js until public/index.html is retired. Do not migrate api/ routes. public/rehab_coverage.html kept until pages/rehab.js verified in production. All migration work on nextjs branch — do NOT merge to main until user confirms. Branch strategy: one long-lived nextjs branch, not page-by-page merges."
    },
    {
      "id": "DN-032",
      "status": "open",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "cleanup"
      ],
      "file": "pt-rebuild/public/pt_view.html, pt-rebuild/public/rehab_coverage.html",
      "issue": "Remove dead code left over from DN-006 hamburger refactor: updateUserDisplay() in pt_view.html and updateMenuVisibility() in rehab_coverage.html both reference elements (#userEmail, #ptTrackerLink) that were removed when hamburger panel HTML was extracted to HamburgerMenu.inject(). Both functions silently no-op due to null-checks — no functional impact — but they are dead code.",
      "resolved": null,
      "context": "DN-006 removed hamburger panel HTML from all pages. updateUserDisplay() in pt_view.html and updateMenuVisibility() in rehab_coverage.html were not cleaned up. HamburgerMenu.init() → updateUserDisplay() now handles the user email display. The #ptTrackerLink element no longer exists in any page.",
      "constraints_caveats": "Verify nothing else calls these functions before removing. updateMenuVisibility() in rehab_coverage.html also sets userRole — confirm that logic is fully handled by the HamburgerMenu.init() isAdmin param before deleting."
    },
    {
      "id": "DN-005",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "performance",
        "api"
      ],
      "file": "pt-rebuild/api/users.js",
      "issue": "Push role-based filtering to DB query (`.eq()` etc.) instead of fetching all users then filtering in memory.",
      "resolved": null,
      "context": "Therapists/patients currently fetch full user sets before reducing in app logic.",
      "constraints_caveats": "Behavior parity (who can see which users) must remain identical after query-level filtering."
    },
    {
      "id": "DN-008",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "data-model",
        "migration"
      ],
      "file": "pt-rebuild/supabase/migrations",
      "issue": "Delete `20260220000755_remote_schema.sql.bak` once VS Code Supabase extension confirms no more storage trigger errors.",
      "resolved": null,
      "context": "Created as a backup before stripping the storage-internal trigger lines from the migrations file. Safe to delete once tooling is confirmed clean.",
      "constraints_caveats": "Verify VS Code extension no longer flags the file before deleting."
    },
    {
      "id": "DN-009",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "data-model",
        "migration"
      ],
      "file": "pt-rebuild/supabase",
      "issue": "Drop backup table `exercises_backup_20260221` after confirming exercise ID migration is working correctly in production.",
      "resolved": null,
      "context": "Table was created as a safety net during the atomic migration that remapped 13 non-UUID exercise IDs (ex000X and slug IDs) to proper UUIDs. All 34 exercises and 11 FK constraint tables verified correct post-migration. See dated entry 2026-02-20.",
      "constraints_caveats": "Confirm pt_editor loads/saves exercises correctly and no FK errors appear in logs before dropping."
    },
    {
      "id": "DN-010",
      "status": "open",
      "priority": "P2",
      "risk": "medium",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "performance",
        "supabase",
        "security"
      ],
      "file": "pt-rebuild/supabase",
      "issue": "Resolve duplicate permissive SELECT policies on patient_activity_logs, patient_activity_sets, patient_activity_set_form_data, and vocab_* tables.",
      "resolved": null,
      "context": "Supabase performance advisor flags 9 tables with two SELECT policies for `authenticated` on the same table. Both policies are evaluated per query. The older `_select_own` / `patient_activity_*_select` policies predate the broader `activity_logs_select` / `activity_sets_select` / `set_form_data_select` policies. The broader policies cover all cases the older ones do, plus therapist access. The older narrow ones can likely be dropped — but access behavior must be verified first.",
      "constraints_caveats": "Read both policy bodies carefully before dropping anything. Verify that the broader policy covers every case the narrow one does (patient own access + therapist access + admin access). Do not drop without testing patient and therapist SELECT access in staging."
    },
    {
      "id": "DN-014",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "ui"
      ],
      "file": "pt-rebuild/public/index.html",
      "issue": "History tab on index shows all exercises; when navigating from a specific exercise it should pre-filter to that exercise's history only.",
      "resolved": null,
      "context": "User taps an exercise card, then taps the History tab — expects to see that exercise's history, not the full log across all exercises.",
      "constraints_caveats": "Needs a way to pass exercise context to the History tab (e.g. in-memory state or scroll-to). Should still allow clearing the filter to see full history."
    },
    {
      "id": "DN-012",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "ui"
      ],
      "file": "pt-rebuild/public/index.html",
      "issue": "No way to reorder exercises on the patient index page — currently sorted by program assignment order from the API.",
      "resolved": null,
      "context": "User needs the ability to control the display order of exercises (e.g. by body region, by recency, by custom sort). Currently exercises render in whatever order the server returns them.",
      "constraints_caveats": "Sort preference should persist across sessions (localStorage or user profile). Must not affect the underlying program data, only display order."
    },
    {
      "id": "DN-015",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "ui",
        "auth",
        "reliability"
      ],
      "file": "pt-rebuild/public/index.html,pt-rebuild/public/pt_view.html",
      "issue": "Hamburger menu sometimes shows \"Signed in as -\" (dash) instead of the user's name on page load.",
      "resolved": null,
      "context": "User name is populated after the users API call resolves. On slow loads or when the menu is opened before the API response arrives, the name placeholder \"-\" is visible instead of the real name.",
      "constraints_caveats": "Investigate whether the menu renders before `me` is resolved and whether a re-render or reactive update is needed once the name is available."
    },
    {
      "id": "DN-016",
      "status": "open",
      "priority": "P2",
      "risk": "medium",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "ui",
        "auth",
        "api"
      ],
      "file": "pt-rebuild/api/users.js,pt-rebuild/public",
      "issue": "No user profile editor — users cannot change their own name, email, or password from within the app.",
      "resolved": null,
      "context": "Currently `PATCH /api/users` only accepts `email_notifications_enabled`. A profile editor would allow users to update `first_name`, `last_name`, email (requires Supabase Auth update), and password (requires Supabase Auth password change flow). Admin may also need ability to edit other users' profiles.",
      "constraints_caveats": "Email/password changes must go through Supabase Auth API (`supabase.auth.updateUser()`), not just the `users` table. Need to consider whether therapist can edit patient profiles or only admins can."
    },
    {
      "id": "DN-019",
      "status": "open",
      "priority": "P1",
      "risk": "medium",
      "scope": "deferred",
      "agent": [
        "claude"
      ],
      "reactivate_when": {
        "trigger": "deployment_scope_change",
        "note": "Current deployment has exactly two users (patient + therapist) who are the only valid sender/recipient pair. Relationship enforcement has no attack surface until additional users exist."
      },
      "tags": [
        "security",
        "auth",
        "api",
        "reliability"
      ],
      "file": "pt-rebuild/api/logs.js",
      "issue": "Clinical message creation (`POST /api/logs?type=messages`) validates recipient existence but does not enforce therapist↔patient relationship constraints.",
      "resolved": null,
      "context": "Current logic allows any authenticated caller to target any existing `users.id` as `recipient_id` if RLS permits the insert. The intended messaging model is patient-therapist communication, so relationship checks should mirror assignment rules used elsewhere.",
      "constraints_caveats": "Define and preserve intended matrix explicitly (patient→assigned therapist only; therapist→assigned patient only; admin behavior defined). Verify against current `clinical_messages` RLS policy bodies before tightening endpoint logic."
    },
    {
      "id": "DN-022",
      "status": "open",
      "priority": "P1",
      "risk": "medium",
      "scope": "deferred",
      "agent": [
        "codex"
      ],
      "reactivate_when": {
        "trigger": "deployment_scope_change",
        "note": "Shared-device cross-user leakage only applies when multiple users share a device/browser profile. Current deployment is single-patient, single-therapist on separate devices."
      },
      "tags": [
        "offline",
        "auth",
        "security",
        "reliability"
      ],
      "file": "pt-rebuild/public/index.html",
      "issue": "Offline queue is stored under a global localStorage key (`pt_offline_queue`) and is not cleared/scoped on sign-out, risking cross-user data carryover on shared devices.",
      "resolved": null,
      "context": "Queue load/save are key-based only and `signOut()` only ends Supabase auth session. A subsequent user on the same device/browser profile can inherit prior unsynced sessions.",
      "constraints_caveats": "Preserve offline durability for the same user while preventing cross-account leakage (e.g., scope key by user ID and/or clear queue on auth change with migration strategy)."
    },
    {
      "id": "DN-017",
      "status": "open",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "docs",
        "data-model",
        "supabase"
      ],
      "file": "pt-rebuild/db/schema.sql",
      "issue": "`schema.sql` drifts out of sync with the live database every time a migration is applied — no automated mechanism keeps it current.",
      "resolved": null,
      "context": "`schema.sql` is a manually maintained snapshot. Each migration in `pt-rebuild/db/migrations/` changes the live DB but does not update `schema.sql`. Over time the file becomes unreliable as a reference for the current DB structure.",
      "options": "(A) After each migration, regenerate `schema.sql` using `supabase db dump --schema public > pt-rebuild/db/schema.sql` as a manual step. (B) Treat `schema.sql` as deprecated documentation and rely solely on numbered migration files as source of truth. (C) Add a note in CLAUDE.md reminding agents to update `schema.sql` after applying migrations.",
      "constraints_caveats": "`supabase db dump` requires Supabase CLI and project credentials. Option B is safest but means agents must read all migration files to understand current schema. Option A keeps a single readable file but relies on discipline to run it."
    },
    {
      "id": "DN-011",
      "status": "open",
      "priority": "P3",
      "risk": "low",
      "scope": "deferred",
      "agent": [
        "codex"
      ],
      "reactivate_when": {
        "trigger": "query_volume_sufficient",
        "note": "Index usage data is not meaningful at current low traffic volume. Re-evaluate after sustained real-user query activity."
      },
      "tags": [
        "performance",
        "supabase"
      ],
      "file": "pt-rebuild/supabase",
      "issue": "Evaluate and drop unused indexes once the app has real query traffic.",
      "resolved": null,
      "context": "Supabase performance advisor flagged 13 indexes as unused: idx_patient_programs_assigned_at, idx_patient_programs_assigned_by, idx_patient_programs_archived_at, idx_program_history_patient, idx_program_history_changed_at, idx_patient_program_history_changed_by, idx_clinical_messages_patient, idx_clinical_messages_created_at, idx_clinical_messages_deleted_by, idx_offline_mutations_user, idx_offline_mutations_pending, exercise_pattern_modifiers_exercise_id_idx, exercise_form_parameters_exercise_id_idx, idx_exercise_roles_active.",
      "constraints_caveats": "Indexes may not yet be used because patient data volume is low. Re-check after real patient usage before dropping. Some (e.g. exercise child table indexes) may become useful as exercise count grows."
    }
  ],
  "closed_items": [
    {
      "id": "DN-040",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "ui",
        "docs",
        "reliability"
      ],
      "file": "pt-rebuild/vercel.json, pt-rebuild/pages/rehab.js, pt-rebuild/pages/pt-view.js",
      "issue": "Eliminate recurring favicon console noise by routing /favicon.ico to the existing SVG app icon and aligning Next.js page head tags.",
      "resolved": "2026-03-01",
      "problem": "Preview smoke checks repeatedly logged a console error: GET /favicon.ico 404 on migrated and legacy routes.",
      "root_cause": "The app uses an SVG PWA icon (/icons/icon.svg), but browsers still request /favicon.ico by default when no ICO asset is present at root.",
      "change_made": "Added Vercel rewrite /favicon.ico -> /icons/icon.svg so default browser favicon requests resolve. Also added explicit SVG favicon tags to Next.js pages /rehab and /pt-view for consistency with legacy HTML pages.",
      "files_touched": "pt-rebuild/vercel.json, pt-rebuild/pages/rehab.js, pt-rebuild/pages/pt-view.js, pt-rebuild/docs/dev_notes.json, pt-rebuild/docs/DEV_NOTES.md",
      "validation": "Confirmed rewrite present in vercel.json and favicon tags in both Next.js heads. Requires a fresh deployment before browser console on preview can confirm 404 elimination.",
      "follow_ups": "After deploying this branch, re-run Playwright console check on /index.html, /pt_view.html, /pt_editor.html, and /rehab to confirm favicon 404 is fully removed."
    },
    {
      "id": "DN-037",
      "status": "done",
      "priority": "P1",
      "risk": "high",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "security",
        "supabase",
        "cleanup"
      ],
      "file": "pt-rebuild/lib/db.js, pt-rebuild/db/deploy_vocab.js, pt-rebuild/db/check_users.js, pt-rebuild/db/migrate.js",
      "issue": "Replace service-role-first key resolution with secret-key-first server-side resolution and remove hardcoded admin key material from tracked files.",
      "resolved": "2026-03-01",
      "problem": "Server-side admin clients were configured via legacy service-role env names and a tracked script previously contained hardcoded admin key material.",
      "root_cause": "Older scripts and helper logic predated Supabase secret-key guidance and continued to prefer legacy service-role naming patterns.",
      "change_made": "Updated server-side admin key resolution to prefer `SUPABASE_SECRET_KEY` first, with temporary fallback to `SUPABASE_SERVICE_ROLE_KEY` / `SUPABASE_SERVICE_KEY` for backward compatibility. Removed hardcoded key material from tracked files and updated error messaging to require secret key (or legacy fallback) in `lib/db.js`, `db/deploy_vocab.js`, `db/check_users.js`, and `db/migrate.js`.",
      "files_touched": "pt-rebuild/lib/db.js, pt-rebuild/db/deploy_vocab.js, pt-rebuild/db/check_users.js, pt-rebuild/db/migrate.js, pt-rebuild/docs/dev_notes.json, pt-rebuild/docs/DEV_NOTES.md",
      "validation": "Repo scan confirms no `sb_secret_` literals remain in tracked code files and all admin-key call sites now resolve `SUPABASE_SECRET_KEY` before legacy service-role env vars.",
      "follow_ups": "After Vercel env cleanup is confirmed everywhere, remove legacy fallbacks (`SUPABASE_SERVICE_ROLE_KEY` and `SUPABASE_SERVICE_KEY`) to enforce a single secret-key path."
    },
    {
      "id": "DN-036",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "cleanup",
        "ui"
      ],
      "file": "pt-rebuild/pages/rehab.js, pt-rebuild/pages/rehab.module.css, pt-rebuild/components/CoverageSummary.js, pt-rebuild/components/CoverageMatrix.js, pt-rebuild/components/CoverageCapacity.js, pt-rebuild/components/CoverageExerciseCard.js",
      "issue": "4 inline render helpers in pages/rehab.js exceeded the 40L inline sub-component limit.",
      "resolved": "2026-03-01",
      "problem": "Rehab coverage UI logic was concentrated in oversized inline render helpers (`renderSummary`, `renderMatrix`, `renderCapacity`, `renderExerciseCard`) that violated structure guidelines and made the page hard to maintain.",
      "root_cause": "Phase 1 implementation was written before structure limits were enforced, so view helpers accumulated in `pages/rehab.js` instead of being extracted into cohesive components.",
      "change_made": "Extracted large inline render helpers into dedicated components (`CoverageSummary`, `CoverageMatrix`, `CoverageCapacity`, `CoverageExerciseCard`) with their own CSS modules and prop interfaces for shared callbacks.",
      "files_touched": "pt-rebuild/components/CoverageSummary.js, pt-rebuild/components/CoverageSummary.module.css, pt-rebuild/components/CoverageMatrix.js, pt-rebuild/components/CoverageMatrix.module.css, pt-rebuild/components/CoverageCapacity.js, pt-rebuild/components/CoverageCapacity.module.css, pt-rebuild/components/CoverageExerciseCard.js, pt-rebuild/components/CoverageExerciseCard.module.css, pt-rebuild/pages/rehab.js, pt-rebuild/docs/dev_notes.json, pt-rebuild/docs/DEV_NOTES.md",
      "validation": "Rehab page now imports extracted components and no longer contains the original oversized inline helper blocks. Preview smoke checks on `/rehab` continued to load coverage data and menu interactions without regression.",
      "follow_ups": "Keep `renderFocusGroup` inline unless it exceeds limits or requires reuse; continue Phase 3 migration work without re-introducing large inline render helpers."
    },
    {
      "id": "DN-035",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": ["claude"],
      "tags": ["cleanup", "migration"],
      "file": "pt-rebuild/lib/rehab-coverage.js, pt-rebuild/pages/pt-view.js, pt-rebuild/pages/pt-view.module.css, pt-rebuild/components/PatientNotes.js, pt-rebuild/components/PatientNotes.module.css, pt-rebuild/components/HistoryList.js, pt-rebuild/components/HistoryList.module.css, pt-rebuild/docs/STRUCTURE_GUIDELINES.md",
      "issue": "Pre-migration cleanup: bring STRUCTURE_GUIDELINES.md cap violations into compliance before Phase 3.",
      "resolved": "2026-02-28",
      "problem": "Three files violated STRUCTURE_GUIDELINES.md hard caps: lib/rehab-coverage.js (588L > 450L cap), pages/pt-view.module.css (670L > 500L cap). Two inline components (PatientNotes 46L, HistoryList 64L) also exceeded the 40L inline sub-component limit.",
      "root_cause": "Files were written before STRUCTURE_GUIDELINES.md existed. Caps and inline limits were not enforced during Phase 2 implementation.",
      "change_made": "(1) lib/rehab-coverage.js: added // NOTE: cohesive domain comment documenting that no valid split exists — import layer rules prohibit lib-imports-lib and all functions are tightly interdependent. (2) Extracted PatientNotes inline component to components/PatientNotes.js + components/PatientNotes.module.css. Moved keyword detection computation to page derived data (components cannot import from lib/). (3) Extracted HistoryList inline component to components/HistoryList.js + components/HistoryList.module.css. Dark mode selectors for each component moved with the component. (4) Updated STRUCTURE_GUIDELINES.md: added Guideline Conflicts escalation section, updated Required Fixes table to show completed status.",
      "files_touched": "pt-rebuild/lib/rehab-coverage.js (comment added), pt-rebuild/pages/pt-view.js (removed inline components, added imports, added processedNotes derivation), pt-rebuild/pages/pt-view.module.css (removed PatientNotes + HistoryList CSS sections + dark mode selectors), pt-rebuild/components/PatientNotes.js (new), pt-rebuild/components/PatientNotes.module.css (new), pt-rebuild/components/HistoryList.js (new), pt-rebuild/components/HistoryList.module.css (new), pt-rebuild/docs/STRUCTURE_GUIDELINES.md (conflict escalation section + Required Fixes table updated)",
      "validation": "Line counts after: pt-view.module.css 369L (was 670L, cap 500L ✓), pt-view.js 353L (was 446L, at aim ✓), PatientNotes.js 45L ✓, PatientNotes.module.css 158L ✓, HistoryList.js 77L ✓, HistoryList.module.css 155L ✓. Verified on preview URL: /pt-view loads, PatientNotes renders/collapses/dismisses, HistoryList renders with date groups, dark mode correct, no console errors.",
      "follow_ups": "pages/rehab.module.css (478L) and pages/rehab.js (452L) are within cap but will shrink naturally when rehab inline components are extracted during Phase 3 cleanup."
    },
    {
      "id": "DN-034",
      "status": "done",
      "priority": "P2",
      "risk": "medium",
      "scope": "current",
      "agent": ["claude"],
      "tags": ["migration", "ui"],
      "file": "pt-rebuild/lib/pt-view.js, pt-rebuild/pages/pt-view.js, pt-rebuild/pages/pt-view.module.css, pt-rebuild/hooks/useMessages.js, pt-rebuild/components/MessagesModal.js, pt-rebuild/components/MessagesModal.module.css, pt-rebuild/components/ExerciseHistoryModal.js, pt-rebuild/components/ExerciseHistoryModal.module.css, pt-rebuild/components/NavMenu.js",
      "issue": "Phase 2 of Next.js Strangler Fig migration: pt_view.html → pages/pt-view.js at /pt-view.",
      "resolved": "2026-02-28",
      "problem": "pt_view.html was a ~2,575-line vanilla JS page that needed migrating to Next.js as part of the Strangler Fig migration.",
      "root_cause": "N/A — planned migration phase.",
      "change_made": "Created lib/pt-view.js (pure data functions: fetchLogs, fetchPrograms, fetchUsers, groupLogsByDate, findNeedsAttention, computeSummaryStats, detectKeywords, applyFilters, message CRUD). Created hooks/useMessages.js (30-second polling, send, archive, markRead, localStorage badge timestamps). Created components/MessagesModal.js + .module.css and ExerciseHistoryModal.js + .module.css. Created pages/pt-view.js and pt-view.module.css. Fixed 3 bugs post-build: (1) localStorage SSR guard — typeof window guard in useState initializers; (2) patient detection — DB has no 'patient' role, patient = user with therapist_id !== null; (3) DB user id vs Supabase auth_id mismatch — messages use DB PK (users.id), not auth UUID. Updated NavMenu NAV_PAGES: pt_view href /pt_view.html → /pt-view.",
      "files_touched": "pt-rebuild/lib/pt-view.js (new), pt-rebuild/pages/pt-view.js (new), pt-rebuild/pages/pt-view.module.css (new), pt-rebuild/hooks/useMessages.js (new), pt-rebuild/components/MessagesModal.js (new), pt-rebuild/components/MessagesModal.module.css (new), pt-rebuild/components/ExerciseHistoryModal.js (new), pt-rebuild/components/ExerciseHistoryModal.module.css (new), pt-rebuild/components/NavMenu.js (NAV_PAGES pt_view href), pt-rebuild/docs/NEXTJS_MIGRATION.md (Phase 2 complete + architecture guidelines)",
      "validation": "Verified on preview URL https://pt-rehab-git-nextjs-pt-tracker.vercel.app/pt-view. Checklist: pt_view.html still loads ✓; /pt-view loads with real data (10 days, 16 exercises, 79 sessions) ✓; NavMenu 'Signed in as' + email ✓; Coverage Analysis nav link works without re-login ✓; no console errors ✓; dark mode ✓; patient notes (7, keyword highlighting) ✓; needs attention (10 exercises) ✓; filters expand/collapse + dropdown (34 options) + localStorage persistence ✓; messages modal (7 sent, '✓ Read' status) ✓; exercise history modal from Needs Attention card ✓.",
      "follow_ups": "pt_view.html stays live in public/ until all phases merged to main and verified in production."
    },
    {
      "id": "DN-006",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "ui",
        "ios",
        "pwa",
        "reliability"
      ],
      "file": "pt-rebuild/public/js/hamburger-menu.js,pt-rebuild/public/index.html,pt-rebuild/public/pt_view.html,pt-rebuild/public/pt_editor.html,pt-rebuild/public/js/pt_editor.js,pt-rebuild/public/rehab_coverage.html",
      "issue": "Consolidate hamburger menu into one shared module: hamburger-menu.js injects the full panel HTML, generates nav links dynamically (excluding current page, role-gated), and handles all toggle/user-display logic. Each page reduces to the trigger button only.",
      "resolved": "2026-02-24",
      "problem": "Each of the 4 pages had the full hamburger overlay + panel HTML duplicated inline with inconsistent class names (.user-info vs .hamburger-user-info), different nav link sets, and inline toggleHamburger() reimplementations. Only pt_editor.html used hamburger-menu.js for init; the other three had no shared module at all. Drift was accumulating across pages.",
      "root_cause": "The original hamburger-menu.js only handled binding and user-display — it assumed pages provided the HTML. No shared injection mechanism existed, so each page maintained its own copy. When pages diverged (different badge count, stale links, non-canonical classes), there was no single source to fix.",
      "change_made": "Added NAV_PAGES constant, inject() method (builds and appends overlay + panel to body; idempotent), and renderNavLinks() (excludes current page; hides adminOnly:true entries for patients) to hamburger-menu.js. Updated config with page, isAdmin, and menuItems fields. Updated init() to call inject() before bindHandlers(). Added stopPropagation in handleAction when action is handled to prevent document-level dispatchers from double-firing. Removed hamburger panel HTML from all 4 pages; each page now only keeps the ☰ trigger button. Removed inline toggleHamburger() from index.html, pt_view.html, rehab_coverage.html. Removed hamburger-related dispatcher cases from all pages. Added HamburgerMenu.init() calls with page-specific menuItems (Messages+Sync+Debug for index, Messages for pt_view, Refresh Data for rehab_coverage, none for pt_editor). Added no-op case 'toggle-hamburger' to pt_editor.js handleAction to suppress spurious unknown-action warning from bindPointerHandlers binding the ☰ trigger before inject() runs.",
      "files_touched": "pt-rebuild/public/js/hamburger-menu.js (full rewrite: NAV_PAGES, inject, renderNavLinks, updated config/init/handleAction), pt-rebuild/public/index.html (remove panel HTML + toggleHamburger, fix showMessagesModal, add init), pt-rebuild/public/pt_view.html (remove panel HTML + toggleHamburger, fix signOut, add init), pt-rebuild/public/pt_editor.html (remove panel HTML), pt-rebuild/public/js/pt_editor.js (update init call, add no-op toggle-hamburger case), pt-rebuild/public/rehab_coverage.html (remove panel HTML + toggleHamburger, remove dispatcher cases, add init)",
      "validation": "Deployed to Vercel preview (pt-rehab-git-dn-006-shared-hamburger-pt-tracker.vercel.app). Chrome DevTools MCP verified all 4 pages: hamburger opens/closes, user email populates, nav links correct (no self-link, adminOnly Exercise Editor visible for admin), page-specific items present (Messages/Sync/Debug on index, Messages on pt_view, Refresh Data on rehab_coverage), no JS errors or warnings on any page.",
      "follow_ups": "None."
    },
    {
      "id": "DN-007",
      "status": "done",
      "priority": "P1",
      "risk": "medium",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "performance",
        "ui",
        "ios"
      ],
      "file": "pt-rebuild/public/index.html",
      "issue": "Reduce INP from 800ms mobile average; worst offenders identified from Vercel Speed Insights real-user data.",
      "resolved": "2026-02-24",
      "problem": "Tapping Messages in the hamburger menu produced 3,488ms INP (worst offender in field data). Root cause: showMessagesModal() ran a synchronous chain — toggleHamburger (classList toggles), messagesModal.classList.remove('hidden'), notifyToggle.checked, and loadMessages() innerHTML write — all in one frame before the first await fetch(). Browser could not paint the menu-closed state until all four DOM mutations had been processed together, compressing two layout recalculations (menu close + modal open) into a single blocking frame.",
      "root_cause": "showMessagesModal() had no yield between closing the hamburger menu and opening the messages modal. The combined layout recalculation (display change on menu + unhiding modal tree) happened synchronously in the same frame.",
      "change_made": "Inserted `await new Promise(r => requestAnimationFrame(r))` between toggleHamburger() and messagesModal.classList.remove('hidden') in showMessagesModal(). This yields the browser after the menu-close so it can paint before opening the modal. No other changes to showMessagesModal or loadMessages.",
      "files_touched": "pt-rebuild/public/index.html (showMessagesModal)",
      "validation": "Deploy to Vercel and open hamburger → tap Messages. Menu should close visibly first, then modal opens (two distinct steps). DevTools Performance panel: INP for #hamburgerMenu interaction measurably reduced. Remaining INP offenders (timerMode, logSetModal, sessionNotes) are separate items.",
      "follow_ups": "Other INP offenders remain unaddressed (#timerMode 1,768ms, #messagesModal 1,296ms, #sessionNotes 1,368ms, #logSetModal 632ms). Same rAF yield pattern can be applied to those handlers in a follow-up pass."
    },
    {
      "id": "DN-031",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "ui",
        "ios",
        "pwa"
      ],
      "file": "pt-rebuild/public/index.html",
      "issue": "Phase 2 audio consistency pass: normalize spoken/beep behavior across counter, hold, and duration flows; add pocket mode for eyes-free exercise tracking.",
      "resolved": "2026-02-24",
      "problem": "Multiple audio/speech inconsistencies: (1) iOS speech synthesis froze silently when utterances stacked; (2) no per-tap audio feedback when counting reps, making eyes-free tracking impossible on iOS (no haptic); (3) hold exercises with dosage_type='hold' without hold_seconds modifier fell to duration branch at timer-zero, giving no rep tracking; (4) hold timer announced every rep completion, inconsistent with counter's 5/3/1/0 milestones; (5) pocket mode for eyes-free exercise tracking was entirely absent from the new app.",
      "root_cause": "speakText() never cancelled prior utterances before calling speak(). increaseCounter() had no audio feedback. Timer-zero hold detection checked only pattern_modifiers, not dosage_type, diverging from initTimerMode() detection. Hold speech loop had no milestone filtering. Pocket mode was not ported from the legacy /pt app when pt-rebuild was created.",
      "change_made": "Fix 1: added window.speechSynthesis.cancel() in speakText() before each speak() call. Fix 2: added optional gain param to playBeep() (default 0.5), added soft per-tap beep (440Hz, 80ms, gain=0.25) in increaseCounter(). Fix 3: timer-zero hold detection now checks pattern_modifiers?.includes('hold_seconds') || dosage_type === 'hold', matching initTimerMode(). Fix 4: hold speech normalized to 5/3/1/0 milestones matching counter mode. Fix 5: ported pocket mode — fullscreen overlay with large tap zone, counter and timer support, long-press partial rep log for hold exercises, 200ms refresh interval for live timer display, toggle-pocket-mode and pocket-tap dispatcher cases.",
      "files_touched": "pt-rebuild/public/index.html (speakText, playBeep, increaseCounter, timer-zero hold branch, hold speech milestones, pocket mode CSS/HTML/JS/dispatcher)",
      "validation": "Deploy to Vercel and verify: counter tap tick, milestone speech at 5/3/1/0, hold exercise rep tracking, hold speech milestones, pocket mode open/close/counter-tap/timer-start-pause/long-press. Confirm no speech freeze on rapid taps.",
      "follow_ups": "Update SOUND_TRIGGER_AUDIT.md to reflect the changes made in this pass if a re-audit is needed."
    },
    {
      "id": "DN-001",
      "status": "done",
      "priority": "P0",
      "risk": "medium",
      "tags": [
        "security",
        "supabase",
        "api",
        "auth"
      ],
      "file": "pt-rebuild/api/sync.js",
      "issue": "Use auth-context Supabase client (`getSupabaseWithAuth(req.accessToken)`) instead of anon client.",
      "resolved": "2026-02-20",
      "problem": "`api/sync.js` used the anon Supabase client for patient data inserts, bypassing RLS user context.",
      "root_cause": "`getSupabaseClient()` was used instead of `getSupabaseWithAuth()` — the token was available on `req.accessToken` but not passed to the client.",
      "change_made": "Swapped `getSupabaseClient()` → `getSupabaseWithAuth(req.accessToken)` in `sync.js`.",
      "files_touched": "`pt-rebuild/api/sync.js`",
      "validation": "Code paths verified by inspection. Regression: patients logging own data unaffected (no `patient_id` body field).",
      "follow_ups": "None. DN-001 and DN-002 closed."
    },
    {
      "id": "DN-002",
      "status": "done",
      "priority": "P0",
      "risk": "medium",
      "tags": [
        "security",
        "api",
        "auth"
      ],
      "file": "pt-rebuild/api/logs.js",
      "issue": "Add therapist-to-patient authorization check in `createActivityLog()` when `patient_id` differs from caller.",
      "resolved": "2026-02-20",
      "problem": "`createActivityLog()` in `api/logs.js` allowed any authenticated caller to post an activity log to any arbitrary `patient_id` with no relationship check.",
      "root_cause": "`targetPatientId` was set from the request body `patient_id` without verifying the caller had a therapist relationship to that patient.",
      "change_made": "Added authorization block in `createActivityLog()`: when `patient_id` differs from `req.user.id`, rejects non-therapist/non-admin callers with 403; for therapists, queries `users` table via admin client to confirm `therapist_id` matches, rejects with 403 if not assigned.",
      "files_touched": "`pt-rebuild/api/logs.js`",
      "validation": "Code paths verified by inspection. Therapists logging for assigned patients pass the relationship check. Unassigned callers receive 403.",
      "follow_ups": "None. DN-001 and DN-002 closed."
    },
    {
      "id": "DN-003",
      "status": "done",
      "priority": "P1",
      "risk": "high",
      "tags": [
        "data-model",
        "reliability",
        "sync",
        "api"
      ],
      "file": "pt-rebuild/api/sync.js,pt-rebuild/api/logs.js",
      "issue": "Prevent orphaned logs when sets insert fails (cleanup or transactional behavior).",
      "resolved": "2026-02-21",
      "problem": "When `patient_activity_sets` insert failed after `patient_activity_logs` was already written, the log row was left orphaned with no sets — silent data corruption in clinical records with no error visible to the patient. The same issue existed in both `createActivityLog` (logs.js) and `processActivityLog` (sync.js).",
      "root_cause": "Three-table insert was done in separate sequential statements with no transaction boundary. Cleanup-on-error was considered but rejected: if the log insert succeeds but the cleanup delete also fails, the `client_mutation_id` unique constraint entry persists — the clinical record becomes permanently unrecoverable on retry.",
      "change_made": "Created Postgres function `create_activity_log_atomic` (`SECURITY INVOKER` — all existing RLS policies remain in full effect, no privilege escalation). Function wraps all three inserts in a single implicit PL/pgSQL transaction; any failure rolls back atomically so no orphaned row is ever written and `client_mutation_id` is only committed on full success. Replaced three-step inline insert in `createActivityLog` and two-step insert in `processActivityLog` with `supabase.rpc('create_activity_log_atomic', {...})`. Also: `processActivityLog` in `sync.js` previously never inserted `patient_activity_set_form_data` at all — the RPC now handles all three tables in both code paths.",
      "files_touched": "`pt-rebuild/api/logs.js`, `pt-rebuild/api/sync.js`, `pt-rebuild/db/migrations/013_create_activity_log_rpc.sql` (new)",
      "validation": "Migration applied via Supabase MCP. Function confirmed in DB (`SECURITY_TYPE: INVOKER`). Deployment `dpl_AhHBKZ9xpiaxfeJG4v9qb3QZoj9b` READY (commit cd566b5). Existing log history loads correctly in app.",
      "follow_ups": "None."
    },
    {
      "id": "DN-004",
      "status": "done",
      "priority": "P1",
      "risk": "high",
      "tags": [
        "data-model",
        "reliability",
        "api"
      ],
      "file": "pt-rebuild/api/logs.js",
      "issue": "Form data is matched to sets by array index instead of `set_number` in create/update flows.",
      "resolved": "2026-02-21",
      "problem": "Form data (e.g. band resistance, weight) was matched to sets by array index position; if Supabase returned inserted rows in a different order than submitted, form parameters would attach to the wrong clinical set with no error raised.",
      "root_cause": "Array-index matching assumed Supabase preserves insert-order in responses, which is not guaranteed.",
      "change_made": "Form data is now matched to sets by `set_number` captured from each set's `RETURNING id` clause — not by array index. Fixed `updateActivityLog` array-index form data matching with a `set_number`-keyed Map lookup. Added `set_number` validation to `createActivityLog` (consistent with `sync.js`).",
      "files_touched": "`pt-rebuild/api/logs.js`, `pt-rebuild/api/sync.js`",
      "validation": "Covered by DN-003 validation (same migration and deployment). Existing log history loads correctly with correct set-to-form-data associations.",
      "follow_ups": "None."
    },
    {
      "id": "DN-013",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "agent": [
        "codex"
      ],
      "tags": [
        "ui"
      ],
      "file": "pt-rebuild/public/index.html",
      "issue": "History view on index does not show notes; pt_view.html shows notes on log entries but index.html does not.",
      "resolved": "2026-02-23",
      "context": "Notes are already fetched with the activity log data — just not rendered in the index history UI. pt_view.html is the reference implementation for how notes should appear.",
      "constraints_caveats": "Check pt_view.html notes rendering and replicate the same pattern on index.",
      "problem": "The patient index history list did not show session notes even though notes were fetched with activity log records. `pt_view.html` already displayed inline notes, but `index.html` omitted them.",
      "root_cause": "`renderHistory()` in `index.html` rendered date, exercise, set summary, and optional form parameters, but never appended `log.notes` to the history card template.",
      "change_made": "Updated `renderHistory()` in `index.html` to render notes inline when present, using the same quoted-note pattern as `pt_view.html` and `escapeHtml(log.notes)` for safe output. No API, auth, recipient, or interaction flow changes were made.",
      "files_touched": "pt-rebuild/public/index.html, pt-rebuild/docs/dev_notes.json, pt-rebuild/docs/DEV_NOTES.md",
      "validation": "Verified updated history template now includes conditional notes markup (`notesInlineHtml`) and appends it to each session card. Confirmed existing set summary/form parameter rendering remains unchanged. Ran `npm run dev-notes:build` and `npm run dev-notes:check` successfully.",
      "follow_ups": "None."
    },
    {
      "id": "DN-018",
      "status": "done",
      "priority": "P2",
      "risk": "medium",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "resolved": "2026-02-23",
      "tags": [
        "offline",
        "api",
        "reliability"
      ],
      "file": "pt-rebuild/api/sync.js,pt-rebuild/public/js/offline.js,pt-rebuild/public/index.html",
      "issue": "Two competing offline sync systems exist — the active one (localStorage + `/api/logs` per item in index.html) and a dead one (`offline.js` IndexedDB queue + `/api/sync` batch endpoint). `manualSync()` in offline.js is never called; `/api/sync` is reachable but unused by any UI flow.",
      "context": "`offline.js` is imported in index.html and used for IndexedDB read-caching only (exercises, programs, logs). Its queue/sync functionality was never wired up. The active offline pattern is entirely in `syncOfflineQueue()` in index.html using localStorage. `/api/sync` takes up one of Vercel's 12-function free-tier slots.",
      "options": "(A) Remove `/api/sync` and dead offline.js sync code — cleans up confusion, frees function slot, but requires careful audit of what IndexedDB code is safe to remove. (B) Activate `/api/sync` as a proper batch endpoint replacing per-item `/api/logs` calls — significant redesign. (C) Leave as-is but document clearly.",
      "constraints_caveats": "Do not touch index.html IndexedDB hydration code without fully understanding what it caches and whether anything reads from it. This is a full separate project, not a quick cleanup.",
      "problem": "Two competing offline sync systems existed: the active one (localStorage queue + syncOfflineQueue() → POST /api/logs per item in index.html) and a dead one (IndexedDB queue + manualSync() in offline.js → POST /api/sync). manualSync() was never called from any UI flow. /api/sync was reachable but unused, occupying one of 12 Vercel free-tier function slots. The IndexedDB parts of offline.js were legitimately used for read caching (exercises, programs, logs).",
      "root_cause": "The IndexedDB-based sync system was built but never wired into the UI. The localStorage-based system in index.html became the de-facto implementation. Both systems coexisted, creating confusion for agents and risk of accidental reactivation of the dead path.",
      "change_made": "Chose Option A: removed the dead queue/sync code. Deleted api/sync.js entirely (frees one Vercel function slot). Stripped addToQueue, getQueueItems, createAutoExport, manualSync, getQueueCount, getSyncMetadata, setSyncMetadata from offline.js. Removed offline_queue, auto_exports, sync_metadata IndexedDB stores from onupgradeneeded — bumped DB_VERSION from 1 to 2 so the upgrade handler drops those stores from existing browsers. Kept all read-caching code (hydrateCache, getCachedExercises, getCachedPrograms, getCachedLogs) unchanged. Updated file header comment to accurately describe offline.js as a read cache only.",
      "files_touched": "pt-rebuild/api/sync.js (deleted), pt-rebuild/public/js/offline.js (dead queue/sync methods removed, DB_VERSION bumped to 2), pt-rebuild/public/index.html (removed stale getSyncMetadata call in initOfflineManager that caused console error on load)",
      "validation": "Verified all callers of removed methods — none exist in index.html or any other file. Active sync path (syncOfflineQueue in index.html) untouched. Caching methods (getCachedExercises etc.) still present and unchanged. Preview deployment tested: exercises load, Log Set modal works, history loads, Sync Now shows 'Nothing to sync', unsynced badge shows/clears correctly, zero /api/sync calls in network traffic. PR #315 merged to main.",
      "follow_ups": "None."
    },
    {
      "id": "DN-020",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "scope": "current",
      "tags": [
        "api",
        "reliability"
      ],
      "file": "pt-rebuild/api/logs.js",
      "issue": "Type safety bug in message validation — `recipient_id?.trim()` / `body?.trim()` can throw before try/catch when payload fields are non-strings.",
      "resolved": "2026-02-23",
      "context": "Validation currently happens outside the `try` block and assumes string inputs. Malformed JSON payloads (number/object types) can raise a `TypeError` and return an unhandled 500 path instead of a controlled 400 response.",
      "constraints_caveats": "Keep behavior for valid string payloads unchanged; add explicit type checks and ensure error shape remains consistent with existing API contracts.",
      "problem": "`POST /api/logs?type=messages` validated required fields with `recipient_id?.trim()` and `body?.trim()` before entering `try/catch`. Non-string payloads (number/object/null) could throw `TypeError`, resulting in an unhandled 500 path instead of a controlled 400 validation response.",
      "root_cause": "Validation assumed string types and relied on optional chaining with `.trim()`, which does not protect against non-string truthy values (for example objects) that do not implement `trim`.",
      "change_made": "Updated `createMessage()` in `api/logs.js` to use strict type-safe required-field guards: `typeof recipient_id === 'string' && recipient_id.trim().length > 0` and `typeof body === 'string' && body.trim().length > 0`. Kept the existing 400 error shape/message (`Missing required fields: recipient_id, body`), preserved UUID validation and insert/auth logic, and made no frontend/UI changes to recipient selection flows.",
      "files_touched": "pt-rebuild/api/logs.js, pt-rebuild/docs/dev_notes.json, pt-rebuild/docs/DEV_NOTES.md",
      "validation": "Confirmed new guards exist in `createMessage()` and preserve existing error text; verified syntax with `node --check api/logs.js`; ran `npm run dev-notes:build` and `npm run dev-notes:check` successfully.",
      "follow_ups": "DN-019 remains deferred by deployment scope decision (two-user deployment)."
    },
    {
      "id": "DN-021",
      "status": "done",
      "priority": "P2",
      "risk": "medium",
      "scope": "current",
      "tags": [
        "api",
        "reliability",
        "ui"
      ],
      "file": "pt-rebuild/api/roles.js,pt-rebuild/public/js/pt_editor.js,pt-rebuild/vercel.json",
      "issue": "Potential route mismatch for role deletion — frontend calls `DELETE /api/roles/:id`, while deployment routing may only map file-based `/api/roles`.",
      "resolved": "2026-02-23",
      "context": "`pt_editor.js` calls `/api/roles/${roleId}` and `api/roles.js` parses a path suffix from `req.url`, but there is no explicit rewrite for nested `/api/roles/:id` in `vercel.json`.",
      "constraints_caveats": "Confirm behavior in deployed Vercel environment before changing API shape. If needed, support both `DELETE /api/roles?id=...` and path variant to avoid breaking existing clients.",
      "problem": "Dev note flagged that `DELETE /api/roles/:id` might fail in Vercel because there is no explicit rewrite for the nested path in vercel.json — only file-based routing for `/api/roles`.",
      "root_cause": "Investigation revealed this is not a bug. Vercel's file-based routing passes the full request URL to the handler, so `req.url` inside `roles.js` is `/api/roles/<uuid>`. The handler already splits on `/` and takes the last segment, with an explicit guard `roleId !== 'roles'` confirming the author accounted for this. No rewrite is needed.",
      "change_made": "No code change. Closed DN-021 as confirmed-working after code review of `roles.js` handler, `pt_editor.js` call site, and `vercel.json`.",
      "files_touched": "None.",
      "validation": "Code path traced: `req.url.split('?')[0].split('/')` on `/api/roles/abc-123` yields `['', 'api', 'roles', 'abc-123']`; last element is the UUID. Guard `roleId !== 'roles'` correctly rejects bare `/api/roles` DELETE attempts.",
      "follow_ups": "None."
    },
    {
      "id": "DN-026",
      "status": "done",
      "priority": "P1",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "security",
        "supabase",
        "api"
      ],
      "file": "pt-rebuild/db/migrations/015_fix_activity_log_rpc_search_path.sql",
      "issue": "Function public.create_activity_log_atomic has a mutable search_path — Supabase security advisor flag.",
      "resolved": "2026-02-23",
      "context": "Supabase security advisor flagged the RPC function for missing SET search_path, which allows schema injection if an attacker can create objects in a schema earlier in the search path.",
      "problem": "Supabase security advisor flagged `public.create_activity_log_atomic` for having a mutable search_path. Without an explicit SET search_path, a malicious actor who can create objects in a schema earlier in the default search path could potentially redirect function calls to shadow objects.",
      "root_cause": "The function was created without `SET search_path = public, pg_temp` or explicit `SECURITY INVOKER` declaration, leaving search path resolution at runtime rather than function-definition time.",
      "change_made": "Replaced the function with `CREATE OR REPLACE` adding `SECURITY INVOKER` and `SET search_path = public, pg_temp`. No logic changes — identical behavior, locked search path.",
      "files_touched": "pt-rebuild/db/migrations/015_fix_activity_log_rpc_search_path.sql (new). Applied directly to DB via Supabase MCP.",
      "validation": "Migration applied successfully. Function signature and behavior unchanged — existing callers in logs.js and sync.js unaffected.",
      "follow_ups": "None."
    },
    {
      "id": "DN-025",
      "status": "done",
      "priority": "P1",
      "risk": "low",
      "tags": [
        "auth",
        "supabase",
        "ui"
      ],
      "file": "pt-rebuild/public/reset-password.html",
      "issue": "Password reset link always shows 'Invalid or Expired Link' — Supabase client clears the URL hash on createClient(), so the type=recovery check always finds an empty hash.",
      "resolved": "2026-02-23",
      "problem": "Clicking a valid, freshly-issued password reset link on pttracker.app immediately showed 'Invalid or Expired Link'. The Supabase verify endpoint redirected correctly to /reset-password.html, but the page rejected every token.",
      "root_cause": "The Supabase JS client (implicit flow) calls history.replaceState to strip the hash tokens from the URL the moment createClient() is called. The old code read window.location.hash after createClient(), so it always found an empty hash (#) and the type !== 'recovery' guard triggered showInvalid() on every valid link. This was a latent bug present before the pttracker.app domain move — it never worked.",
      "change_made": "Moved the window.location.hash capture to the very top of init(), before fetch('/api/env') and createClient(). The hash is intact at that point; after createClient() processes it, the captured value is still used for the type check.",
      "files_touched": "pt-rebuild/public/reset-password.html",
      "validation": "Code path reviewed: hash is read synchronously before any async calls or client initialization. getSession() after createClient() still returns the recovery session established from the hash tokens.",
      "follow_ups": "None."
    },
    {
      "id": "DN-023",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "tags": [
        "docs",
        "reliability"
      ],
      "file": "pt-rebuild/docs/dev_notes.json,pt-rebuild/docs/DEV_NOTES.md,pt-rebuild/AGENTS.md,pt-rebuild/CLAUDE.md,pt-rebuild/docs/AI_WORKFLOW.md",
      "issue": "Follow-up review requested explicit intake→execute→close-loop proof for the JSON-canonical dev-notes migration; create and close a tracked item documenting the completion.",
      "resolved": "2026-02-22",
      "problem": "Review follow-up asked whether the migration work actually followed the required lifecycle and requested explicit create/close tracking in dev notes.",
      "root_cause": "The prior change migrated formats and guidance but did not include a dedicated DN issue closure entry proving the lifecycle was executed for the migration request itself.",
      "change_made": "Added DN-023 as a tracked and resolved issue in canonical JSON and added this dated entry to close the loop, then regenerated DEV_NOTES.md via the generator.",
      "files_touched": "pt-rebuild/docs/dev_notes.json, pt-rebuild/docs/DEV_NOTES.md",
      "validation": "Ran `npm run dev-notes:build` and `npm run dev-notes:check` successfully; markdown is synchronized with canonical JSON.",
      "follow_ups": "None."
    },
    {
      "id": "DN-024",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "tags": [
        "docs"
      ],
      "file": "pt-rebuild/docs/dev_notes.json,pt-rebuild/docs/DEV_NOTES.md",
      "issue": "Confirm follow-up dev-tracking for JSON-canonical migration review and record validation commands run.",
      "resolved": "2026-02-22",
      "context": "Follow-up request asked whether a dev note was added and whether required generator commands were run.",
      "constraints_caveats": "Keep tracking in canonical JSON and regenerate Markdown artifact only via script.",
      "problem": "Review follow-up asked for explicit confirmation that dev-tracking was updated and required commands were executed.",
      "root_cause": "Previous change set did not include a dedicated dated entry explicitly documenting this follow-up verification step.",
      "change_made": "Added DN-024 in `open_items` as resolved and added this dated entry to close-loop the follow-up request while preserving existing DN sequence and history.",
      "files_touched": "`pt-rebuild/docs/dev_notes.json`, `pt-rebuild/docs/DEV_NOTES.md`",
      "validation": "Ran `npm run dev-notes:build` and `npm run dev-notes:check` successfully after updating canonical JSON.",
      "follow_ups": "None."
    },
    {
      "id": "DN-027",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "docs",
        "cleanup"
      ],
      "file": "pt-rebuild/docs/dev_notes.json,pt-rebuild/scripts/generate-dev-notes.mjs",
      "issue": "Remove redundant  field from dev_notes.json — it duplicates  and is drift-prone.",
      "resolved": "2026-02-23",
      "problem": "All open_items in dev_notes.json carried a 'checkbox' field ('open'/'done') that duplicated the 'status' field. The generator already derived checkbox state from 'status' and 'resolved', making the field pure noise. It was also drift-prone — proven when DN-018 had mismatched checkbox/status values after a partial update.",
      "root_cause": "The field was originally added as a user-facing display marker before the JSON schema matured. Once 'status' became the canonical source of truth, 'checkbox' became redundant but was never cleaned.",
      "change_made": "Removed 'checkbox' from all 26 items in open_items. Updated generate-dev-notes.mjs to derive checked state from 'status === done || Boolean(resolved)' only. Bumped schema_version to 1.4.0.",
      "files_touched": "pt-rebuild/docs/dev_notes.json (26 items updated, schema 1.3.0 → 1.4.0), pt-rebuild/scripts/generate-dev-notes.mjs (checkbox fallback removed from renderOpenItem)",
      "validation": "Ran dev-notes:build — output identical structure, all checkboxes render correctly from status/resolved alone.",
      "follow_ups": "None."
    },
    {
      "id": "DN-028",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "scope": "current",
      "agent": [
        "claude"
      ],
      "tags": [
        "docs",
        "cleanup"
      ],
      "file": "pt-rebuild/docs/dev_notes.json,pt-rebuild/scripts/generate-dev-notes.mjs,pt-rebuild/AGENTS.md",
      "issue": "Separate open_items into open_items (active work queue) and closed_items (done) to reduce agent token cost and eliminate noise.",
      "resolved": "2026-02-23",
      "problem": "open_items mixed active (open/in_progress/blocked) and done items in one array. At schema 1.4.0, 13 of 27 items were done — 50% noise for agents loading the work queue. Ratio worsens over time.",
      "root_cause": "Original schema had no closed_items array. Done items accumulated in open_items with no mechanism to move them out.",
      "change_made": "Script split open_items by status: open/in_progress/blocked stay in open_items; done moves to new closed_items array. Generator updated to validate and render both sections separately. AGENTS.md updated with lifecycle rules for all status values. Schema bumped to 1.5.0.",
      "files_touched": "pt-rebuild/docs/dev_notes.json (split into open_items + closed_items, schema 1.4.0 -> 1.5.0), pt-rebuild/scripts/generate-dev-notes.mjs (validate + render closed_items), pt-rebuild/AGENTS.md (lifecycle rules updated)",
      "validation": "dev-notes:build and dev-notes:check both pass. open_items contains only actionable statuses. closed_items contains all done items.",
      "follow_ups": "None."
    },
    {
      "id": "LE-001",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "tags": [
        "docs",
        "api"
      ],
      "file": "pt-rebuild/docs/API.md",
      "issue": "API docs aligned to post-consolidation route model",
      "resolved": "2026-02-18",
      "problem": "API documentation still mixed pre-consolidation assumptions (12-slot snapshot and debug endpoint presence) with post-change behavior, creating ambiguity for future edits and endpoint work.",
      "root_cause": "Wrapper consolidation and `api/debug.js` removal were implemented after the original slot strategy memo and guide were written, but docs were not fully synchronized in one pass.",
      "change_made": "Updated API strategy memo to add an implementation status section, revise inventory to 9 current API files, mark wrapper consolidation/debug removal as completed, and note query/body id routing for programs/exercises updates. Updated development guide API surface text to reflect current methods and query/body id usage, and removed stale script reference.",
      "files_touched": "`pt-rebuild/docs/API_SLOT_STRATEGY_2026-02-17.md`, `pt-rebuild/docs/DEVELOPMENT.md`",
      "validation": "Re-ran `rg` checks for `/api/programs/`, `/api/exercises/`, and `/api/debug` app callsites (none remaining in `pt-rebuild/public`); verified docs now state 9-file inventory and no debug route listing.",
      "follow_ups": "If a dedicated messages endpoint is introduced later, update both docs in the same change set and add migration notes for callsite contract changes."
    },
    {
      "id": "LE-002",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "tags": [
        "docs"
      ],
      "file": "pt-rebuild/docs/DEV_NOTES.md",
      "issue": "DEV_NOTES converted to AI-optimized ops format",
      "resolved": "2026-02-18",
      "problem": "Active TODOs, risk context, and workflow guidance were split across legacy sections, making agent handoff and consistent triage harder.",
      "root_cause": "Historical notes evolved with mixed styles (`Remaining Work`, freeform notes, and legacy prose) and no single machine-stable open-work section.",
      "change_made": "Added canonical top-of-file ops sections (`How to Use`, priority/risk/status enums, tag vocabulary, entry schema, migration approach), moved active outstanding work into `Open Items` (`DN-001` to `DN-006`), removed duplicated legacy `Remaining Work` block, and preserved historical entries under `Legacy Entries (Pre-Format)`. Added prose `Context` and `Constraints/Caveats` per open item for cross-agent compatibility (including Claude Code). Aligned guidance docs to the new behavior (`AGENTS.md`, `CLAUDE.md`, `DEV_PRACTICES.md`).",
      "files_touched": "`pt-rebuild/docs/DEV_NOTES.md`, `pt-rebuild/docs/DEV_PRACTICES.md`, `pt-rebuild/AGENTS.md`, `pt-rebuild/CLAUDE.md`",
      "validation": "Verified `Open Items` now contains the previously active unresolved items with preserved priority and explicit risk; verified guidance references now point to `Open Items` + schema-based dated entries; confirmed legacy historical content remains intact.",
      "follow_ups": "Keep future updates schema-compliant and close-loop `Open Items` whenever tracked work is completed."
    },
    {
      "id": "LE-003",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "tags": [
        "cleanup",
        "api"
      ],
      "file": "pt-rebuild/index.html",
      "issue": "Removed redundant client-side form parameter backfill from index.html",
      "resolved": "2026-02-18",
      "problem": "`loadData()` in `index.html` made a second serial fetch to `/api/exercises` whenever any exercise in the program had an empty `form_parameters_required` array, blocking LCP and contributing to 8.4s LCP on mobile.",
      "root_cause": "The backfill (commit `a7efd59`, 2026-01-30) was added as a workaround for RLS silently blocking patients from reading `exercise_form_parameters` via nested Supabase joins. A server-side fix (commit `4fc6973`, 78 minutes earlier) using an admin-client fetch in `programs.js` already resolved the same issue authoritatively. The client-side backfill was never removed after the server fix was confirmed working.",
      "change_made": "Removed the `missingFormParams` block (28 lines) from `loadData()` in `index.html`. The programs API already returns correct `form_parameters_required` for all exercises via the admin client fetch in `lib/handlers/programs.js` (lines 219-235). Verified live: 12 of 33 exercises return form parameters correctly, band resistance defaults to last used value, logging modal renders all required fields.",
      "files_touched": "`pt-rebuild/public/index.html`",
      "validation": "Confirmed `/api/programs` response contains correct `form_parameters_required` for all exercises with parameters. Opened Log Set modal for Ankle Inversion (TheraBand) — band_resistance field present, populated from history, defaulting to last used value (\"black\"). No regressions.",
      "follow_ups": "None."
    },
    {
      "id": "LE-004",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "tags": [
        "ui",
        "ios"
      ],
      "file": "pt-rebuild/index.html",
      "issue": "Timer audio cues aligned for duration/hold and >10s start/pause voice",
      "resolved": "2026-02-18",
      "problem": "`duration_seconds` timer flow diverged from `hold_seconds` behavior by announcing \"Time\" at completion, and long timers lacked explicit start/pause voice cues.",
      "root_cause": "Duration completion branch in `startTimer()` had a duration-specific speech fallback, and timer controls had no threshold-gated voice announcements for start/pause actions.",
      "change_made": "Updated duration completion speech to use `Set complete` so duration/hold share the same near-zero cue flow (countdown beeps at `3/2/1` and completion triple-beep at `0`). Added voice announcements for `Start` and `Pause` when `timerState.targetSeconds > 10`. Added `pauseTimer(announce = true)` parameter so auto-pause at completion and reset call `pauseTimer(false)` and do not produce extra pause announcements.",
      "files_touched": "`pt-rebuild/public/index.html`",
      "validation": "Verified timer logic in `startTimer()`/`pauseTimer()`/`resetTimer()` now includes `speakText('Start')` and `speakText('Pause')` only for targets over 10s, keeps auto-complete and reset silent for pause voice, and retains existing countdown/completion beep behavior.",
      "follow_ups": "Optional UX decision: keep `Set complete` spoken for duration completion, or switch completion to sound-only for both duration and hold for strict audio parity."
    },
    {
      "id": "LE-005",
      "status": "done",
      "priority": "P2",
      "risk": "medium",
      "tags": [
        "ui"
      ],
      "file": "pt-rebuild/pt_editor/index.html",
      "issue": "PT Editor archived exercise visibility toggles for Edit/Roles/Dosage selectors",
      "resolved": "2026-02-19",
      "problem": "Archived exercises were always shown in PT Editor selection dropdowns, making active workflows noisier and increasing risk of picking archived items unintentionally.",
      "root_cause": "Dropdown population/filtering logic used `allExercises` directly without lifecycle-based filtering or any user-controlled archived visibility toggle.",
      "change_made": "Added a `Show Archived` checkbox to the exercise edit selector panel and refactored dropdown filtering/population for all three selectors (Edit, Roles, Dosage) to hide archived by default, include archived only when requested, and show archived items in a separate `Archived Exercises` section below active items. Implemented live re-render on search and toggle changes without page reload.",
      "files_touched": "`pt-rebuild/public/pt_editor.html`, `pt-rebuild/public/js/pt_editor.js`",
      "validation": "Verified filtering flow in code paths for `loadExercises()`, `filterExercises()`, roles/dosage search handlers, and shared dropdown render helper now consistently applies lifecycle filtering and immediate re-render behavior.",
      "follow_ups": "If therapists want independent archived visibility controls per section later, split the single toggle into scoped controls while preserving current default-hidden safety behavior."
    },
    {
      "id": "LE-006",
      "status": "done",
      "priority": "P2",
      "risk": "medium",
      "tags": [
        "ui",
        "api"
      ],
      "file": "pt-rebuild/pt_editor/index.html",
      "issue": "pt_editor date fields blank when editing existing exercises",
      "resolved": "2026-02-19",
      "problem": "`added_date` and `updated_date` fields were blank when opening an exercise for editing, even when values existed in the database.",
      "root_cause": "Values are stored as full ISO 8601 timestamps (e.g. `2026-02-20T00:00:00.000Z`) but `<input type=\"date\">` requires `YYYY-MM-DD` format. Browser silently rejected the value, leaving fields blank.",
      "change_made": "Added `toDateInput()` helper that converts any valid date value to `YYYY-MM-DD` using `new Date().toISOString().split('T')[0]`. Applied to both `addedDate` and `updatedDate` fields in `loadExerciseForEdit()`.",
      "files_touched": "`pt-rebuild/public/js/pt_editor.js`",
      "validation": "Cherry-picked from branch `claude/review-public-directory-I9eT4` (commit 37c15d1). Date fields now populate correctly when editing.",
      "follow_ups": "None."
    },
    {
      "id": "LE-007",
      "status": "done",
      "priority": "P1",
      "risk": "high",
      "tags": [
        "data-model",
        "migration"
      ],
      "file": "pt-rebuild/db/migrations/",
      "issue": "Exercise IDs: bug fix + data migration to proper UUID format",
      "resolved": "2026-02-20",
      "problem": "13 of 34 exercises had non-UUID IDs. 9 had sequential `ex000X` IDs from the original Firebase migration (Jan 18). 4 had slug IDs like `passive-great-toe-plantarflexion-stretch` added Jan 28 – Feb 3 via `pt_editor`. All 13 had linked records across 11 child tables that had to be preserved.",
      "root_cause": "`generateExerciseId(name)` in `pt_editor.js` slugified the canonical name instead of generating a UUID. The 9 `ex000X` IDs were grandfathered from Firebase. The 4 slug IDs were created when exercises were manually added through the editor after the Firebase migration.",
      "change_made": "1. **Bug fix** — Replaced `generateExerciseId(name)` body to use `crypto.randomUUID()` (native browser API, no vendor dependency). Removed the vendored `ulid.js` library that was briefly added.\n  2. **Display field** — Added a read-only Exercise ID display field in `pt_editor.html` above the Canonical Name field (both add and edit modes). Pre-generates a UUID when adding; shows existing ID when editing. Field is monospace, readonly, not user-editable.\n  3. **JS wiring** — `loadExerciseForEdit()` populates `exerciseIdDisplay` from `exercise.id`. `clearForm()` pre-generates a fresh UUID into `exerciseIdDisplay`. `collectFormData()` reads from `exerciseIdDisplay` instead of calling `generateExerciseId(canonicalName)`.\n  4. **Data migration** — Applied atomic migration `20260221000001_fix_exercise_ids.sql` via Supabase MCP: dropped all 11 FK constraints, updated all 13 bad IDs in `exercises` and all child tables (using a temp mapping table), re-added FK constraints with original ON DELETE behavior. Backup table `exercises_backup_20260221` preserved.",
      "files_touched": "`pt-rebuild/public/js/pt_editor.js`, `pt-rebuild/public/pt_editor.html`, `pt-rebuild/supabase/migrations/20260221000001_fix_exercise_ids.sql`, `pt-rebuild/db/migrations/012_fix_exercise_ids.sql`",
      "validation": "34 exercises total (unchanged). 0 old IDs remaining in `exercises`. All 11 FK constraints restored. Backup table `exercises_backup_20260221` contains 34 rows.",
      "follow_ups": "Drop `exercises_backup_20260221` after confirming app behavior is correct in production."
    },
    {
      "id": "LE-008",
      "status": "done",
      "priority": "P0",
      "risk": "medium",
      "tags": [
        "security",
        "api",
        "auth"
      ],
      "file": "pt-rebuild/api/sync.js,pt-rebuild/api/logs.js",
      "issue": "P0 security: auth client in sync.js + therapist-patient authorization in logs.js",
      "resolved": "2026-02-20",
      "problem": "(1) `api/sync.js` used the anon Supabase client for patient data inserts, bypassing RLS user context. (2) `createActivityLog()` in `api/logs.js` allowed any authenticated caller to post an activity log to any arbitrary `patient_id` with no relationship check.",
      "root_cause": "(1) `getSupabaseClient()` was used instead of `getSupabaseWithAuth()` — the token was available on `req.accessToken` but not passed to the client. (2) `targetPatientId` was set from the request body `patient_id` without verifying the caller had a therapist relationship to that patient.",
      "change_made": "(1) Swapped `getSupabaseClient()` → `getSupabaseWithAuth(req.accessToken)` in `sync.js`. (2) Added authorization block in `createActivityLog()`: when `patient_id` differs from `req.user.id`, rejects non-therapist/non-admin callers with 403; for therapists, queries `users` table via admin client to confirm `therapist_id` matches, rejects with 403 if not assigned.",
      "files_touched": "`pt-rebuild/api/sync.js`, `pt-rebuild/api/logs.js`",
      "validation": "Code paths verified by inspection. Regression: patients logging own data unaffected (no `patient_id` body field). Therapists logging for assigned patients pass the relationship check. Unassigned callers receive 403.",
      "follow_ups": "None. DN-001 and DN-002 closed."
    },
    {
      "id": "LE-009",
      "status": "done",
      "priority": "P2",
      "risk": "low",
      "tags": [
        "performance",
        "supabase"
      ],
      "file": "pt-rebuild/db/migrations/",
      "issue": "RLS auth.uid() initialization plan fix (performance)",
      "resolved": "2026-02-20",
      "problem": "Supabase performance advisor flagged 17 RLS policies across 9 tables for re-evaluating `auth.uid()` once per row instead of once per query.",
      "root_cause": "Policies used bare `auth.uid()` in WHERE conditions. PostgreSQL re-evaluates this for every row scanned. Wrapping in `(select auth.uid())` forces a single evaluation per query.",
      "change_made": "Dropped and recreated 15 affected policies on `patient_activity_logs` (select/update/delete), `patient_activity_sets` (select/update/delete), `patient_activity_set_form_data` (select/update/delete), and all 6 `vocab_*` tables (`_modify` policy on each). Replaced all bare `auth.uid()` with `(SELECT auth.uid())`. Zero behavior change — purely a query planner optimization.",
      "files_touched": "DB only (migration `fix_rls_auth_uid_initplan` applied via Supabase MCP)",
      "validation": "Migration applied successfully. Re-run performance advisor to confirm warnings cleared.",
      "follow_ups": "DN-009 — duplicate permissive SELECT policies still present on patient_activity_logs, patient_activity_sets, patient_activity_set_form_data, and vocab_* tables. Requires careful review before fixing (medium risk). DN-010 — 13 unused indexes flagged; defer until real query traffic confirms they're unneeded."
    },
    {
      "id": "LE-010",
      "status": "done",
      "priority": "P1",
      "risk": "medium",
      "tags": [
        "supabase",
        "migration"
      ],
      "file": "pt-rebuild/db/migrations/",
      "issue": "Supabase migrations file corrupted by storage-internal trigger lines",
      "resolved": "2026-02-20",
      "problem": "VS Code Supabase extension reported errors on `20260220000755_remote_schema.sql`. The file is a full `pg_dump`-style schema export that GPT inserted after truncating `supabase_migrations.schema_migrations`. It contained `drop extension if exists \"pg_net\"` and 5 `CREATE TRIGGER` statements on `storage.objects` / `storage.prefixes` — internal Supabase objects that cannot be created by user migrations.",
      "root_cause": "GPT truncated the migrations table and inserted a single mega-migration row pointing at a full schema dump. The dump included storage-internal triggers at the end that Supabase tooling rejects. The DB itself was unaffected (the migration row was already marked applied), but the local file caused tooling errors.",
      "change_made": "Removed lines 2034–2045 from `pt-rebuild/supabase/migrations/20260220000755_remote_schema.sql` — specifically `drop extension if exists \"pg_net\"` and the 5 `CREATE TRIGGER` statements on `storage.objects` and `storage.prefixes`. No DB changes were needed.",
      "files_touched": "`pt-rebuild/supabase/migrations/20260220000755_remote_schema.sql`",
      "validation": "Verified zero `storage.` and `pg_net` matches remain in the file.",
      "follow_ups": "None — DB was never affected. If the VS Code extension still reports issues, verify the migration row in `supabase_migrations.schema_migrations` is still present and marked applied."
    },
    {
      "id": "LE-011",
      "status": "done",
      "priority": "P1",
      "risk": "medium",
      "tags": [
        "auth",
        "api"
      ],
      "file": "pt-rebuild/api/users.js",
      "issue": "Admin-role user blocked from patient app (programs, sync)",
      "resolved": "2026-02-21",
      "problem": "Admin user (who is also the sole patient) could not see their programs in the patient app, and the offline sync queue was rejected entirely with 403.",
      "root_cause": "(1) `patient_programs` and `patient_program_history` SELECT RLS policies had no admin bypass — they only allowed own `patient_id` or therapist relationship. (2) `/api/sync` used `requirePatient` middleware which rejects any non-`patient` role, blocking the admin user even though they are also a patient.",
      "change_made": "(1) Dropped and recreated `patient_programs_select_own` and `patient_program_history_select` RLS policies to add `OR (EXISTS (SELECT 1 FROM users WHERE auth_id = auth.uid() AND role = 'admin'))`. (2) Changed `sync.js` from `requirePatient` → `requireAuth`; updated comment to reflect that RLS on `patient_activity_logs` still enforces own-`patient_id` inserts. All other exercise/role/vocab write endpoints already allowed admin.",
      "files_touched": "DB (migration `fix_admin_patient_rls`), `pt-rebuild/api/sync.js`",
      "validation": "Migration applied successfully. RLS SELECT policies now include admin bypass. Sync endpoint accepts any authenticated user; RLS still blocks cross-patient inserts.",
      "follow_ups": "None."
    },
    {
      "id": "LE-012",
      "status": "done",
      "priority": "P2",
      "risk": "medium",
      "tags": [
        "email",
        "notifications"
      ],
      "file": "pt-rebuild/api/messages.js",
      "issue": "Email notifications for clinical messages (Resend integration)",
      "resolved": "2026-02-21",
      "problem": "The daily cron (`handleNotify` in `logs.js`) used SendGrid (never configured), sent only a count (no message bodies), had no \"new since last email\" guard (re-sent daily for old unread messages), and had no opt-out support.",
      "root_cause": "Feature was scaffolded but never fully implemented. `SENDGRID_API_KEY` was never set in Vercel.",
      "change_made": "Rewrote `handleNotify` to use Resend API (`RESEND_API_KEY` already configured via Vercel integration). Added `last_notified_at` timestamptz column to track per-user send time. Added `email_notifications_enabled` boolean column (default true) for opt-out. New logic: skip opted-out users, skip if notified within 23 hours, filter to messages newer than `last_notified_at`, skip if no new messages, send HTML email with message bodies + role-based deep link + opt-out footer, update `last_notified_at` on success. Added `PATCH /api/users` handler (own record only, boolean only). Added email notify toggle to messages modal in both `index.html` and `pt_view.html`. Fixed message font sizes (body 14→16px, labels 13→15px, timestamps/buttons 11→13px). Added `font-size: 16px` to compose textarea (prevents iOS auto-zoom).",
      "files_touched": "`pt-rebuild/api/logs.js`, `pt-rebuild/api/users.js`, `pt-rebuild/public/index.html`, `pt-rebuild/public/pt_view.html`; Vercel env vars added: `EMAIL_FROM`, `APP_URL`, `CRON_SECRET`; Supabase migrations: `add_last_notified_at_to_users`, `add_email_notifications_opt_out`",
      "validation": "Triggered cron manually — `{\"sent\":1,\"skipped\":0,\"total\":1}`. DB `last_notified_at` updated for therapist. Re-triggered immediately — `{\"sent\":0,\"skipped\":1,\"total\":1}` (23-hour guard working).",
      "follow_ups": "Remove `SENDGRID_API_KEY` from Vercel if it exists (was never set, but worth confirming)."
    },
    {
      "id": "LE-013",
      "status": "done",
      "priority": "P1",
      "risk": "high",
      "tags": [
        "reliability",
        "api"
      ],
      "file": "pt-rebuild/db/migrations/014_fix_activity_log_rpc_null_form_data.sql",
      "issue": "Regression: exercises without form data failed to log (500) after RPC migration",
      "resolved": "2026-02-21",
      "problem": "Any exercise without form parameters (e.g. Ankle Inversion — Isometric) returned a 500 error immediately after the DN-003/DN-004 RPC migration. Existing offline queue sessions failed to sync.",
      "root_cause": "The client sends `\"form_data\": null` in set objects when an exercise has no form parameters. In Postgres JSONB, `v_set->'form_data'` on a JSON null value returns a JSONB null — not a SQL NULL. The RPC's guard `v_set->'form_data' IS NOT NULL` evaluated to `true` for JSON nulls, causing `jsonb_array_length()` to be called on a non-array type, raising an exception and rolling back the transaction with a 500.",
      "change_made": "Replaced `IS NOT NULL` check with `jsonb_typeof(v_set->'form_data') = 'array'`. This correctly handles `null`, missing key, and empty array without error. Fix applied directly in DB via Supabase MCP (`apply_migration`) — no Vercel deployment required.",
      "files_touched": "DB only — migration `014_fix_activity_log_rpc_null_form_data.sql` (new); `pt-rebuild/db/migrations/014_fix_activity_log_rpc_null_form_data.sql` saved to repo.",
      "validation": "Tested RPC directly with `\"form_data\": null` payload — returned `log_id`, no error. Confirmed Ankle Inversion — Isometric log from offline queue synced correctly: set_count=1, reps=10, seconds=10, side=right, manual_log=true.",
      "follow_ups": "None. Should have tested with a no-form-data exercise before shipping DN-003/DN-004."
    },
    {
      "id": "DN-029",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "tags": [
        "docs",
        "cleanup"
      ],
      "file": "pt-rebuild/docs/dev_notes.json",
      "issue": "Eliminate dated_entries array; consolidate close-loop narratives inline on closed items; convert pre-DN entries to LE-### format; archive legacy_entries to HISTORY.md.",
      "resolved": "2026-02-23",
      "problem": "`dated_entries` array was a second place to store close-loop narratives, separate from the closed items they described. `legacy_entries` was a raw markdown blob in the JSON that was not machine-processable. Both added schema complexity and split narrative context from the items it referenced.",
      "root_cause": "`dated_entries` were introduced before narrative fields existed on closed items. Once closed items had narrative fields (DN-023/DN-024), `dated_entries` became redundant. `legacy_entries` was a transitional holdover from the pre-DN note format.",
      "change_made": "Eliminated `dated_entries` array: DN-linked entries merged as narrative fields directly onto their closed items; non-DN entries converted to LE-### closed items with full narrative fields. Extracted `legacy_entries` to `pt-rebuild/docs/HISTORY.md` archive (read-only, not machine-processed). Updated generator to validate and render LE items; removed all `dated_entries` and `legacy_entries` logic. Updated `AGENTS.md` close-loop instructions to write narratives directly onto closed items. Bumped schema to 1.6.0.",
      "files_touched": "`pt-rebuild/docs/dev_notes.json`, `pt-rebuild/scripts/generate-dev-notes.mjs`, `pt-rebuild/AGENTS.md`, `pt-rebuild/docs/HISTORY.md` (new), `pt-rebuild/docs/dev_notes.schema.json`",
      "validation": "`npm run dev-notes:build` passes with no warnings. All 13 LE items present with full narrative fields. All DN closed items have non-empty narrative fields.",
      "follow_ups": "None."
    },
    {
      "id": "DN-030",
      "status": "done",
      "priority": "P3",
      "risk": "low",
      "tags": [
        "docs",
        "cleanup"
      ],
      "file": "pt-rebuild/AGENTS.md",
      "issue": "Move activity_log_testing_checklist out of dev_notes.json into AGENTS.md where operational guidance belongs.",
      "resolved": "2026-02-23",
      "problem": "The activity log testing checklist was stored as a special key in dev_notes.json and rendered in DEV_NOTES.md. It is procedural/operational guidance, not tracking data — it does not belong in the JSON schema.",
      "root_cause": "When the checklist was added after DN-003/DN-004 regressions, dev_notes.json was used as a convenient place to store it. AGENTS.md — the correct home for agent operational guidance — was not considered at the time.",
      "change_made": "Moved checklist content to AGENTS.md under a new \"Activity Log Testing Checklist\" section. Removed activity_log_testing_checklist key from dev_notes.json. Removed checklist rendering from generate-dev-notes.mjs (variable, ToC entry, and inline render). Schema was already clean (key was not in required).",
      "files_touched": "`pt-rebuild/AGENTS.md`, `pt-rebuild/docs/dev_notes.json`, `pt-rebuild/scripts/generate-dev-notes.mjs`",
      "validation": "`npm run dev-notes:build` and `dev-notes:check` pass. Checklist content confirmed present in AGENTS.md.",
      "follow_ups": "None."
    }
  ]
}
