# PT Tracker Rebuild - Development Notes

This file tracks development progress on the Supabase/Vercel rebuild of the PT tracker app.

## 2026-01-19

- **2026-01-19** — **Progress:** Implemented core tracker features in rebuilt index.html. **What was done:** (1) Added timer mode with countdown display, beeps at 5 seconds and completion, and voice announcements ("5 seconds left", "4", "3", "2", "1", "Time"). Timer counts up to show elapsed time and auto-pauses at target but allows continuing beyond. (2) Created big tappable circle for reps counting (320px diameter, iOS-optimized with scale feedback on tap). Removed +/- buttons in favor of single tap-to-increment interface with undo button. (3) Added voice countdown for reps mode - announces "5 reps left", "4 reps left", etc. when approaching target. (4) Implemented pattern modifier detection to show timer mode for `duration_seconds` and `hold_seconds` exercises, counter mode for standard reps. (5) Created `formatDosage()` function to display exercise prescriptions as "3 × 10 reps", "3 × 30 sec", "20 feet", or "3 × 10 reps (5 sec hold)" based on patient_programs data. (6) Used CSS variables (--counter-color, --counter-bg, --timer-color) for future dark mode support. (7) All interactions use data-action with pointerup events per iOS PWA requirements (no onclick handlers). **Files:** `pt-rebuild/public/index.html`. **Notes:** Timer uses Web Audio API for beeps and Web Speech API for voice - both require user interaction on iOS to initialize. Set data is saved with either reps or seconds based on mode.

- **2026-01-19** — **CRITICAL FIX: Form parameters now use normalized SQL structure.** **Problem:** Initial implementation treated form_params like Firebase JSONB object. Supabase uses normalized table `patient_activity_set_form_data` with one row per parameter (activity_set_id + parameter_name + parameter_value + parameter_unit). **What I did:** (1) Updated API `/api/logs` GET to JOIN form_data table and return `form_data: [{parameter_name, parameter_value, parameter_unit}]` array per set. (2) Updated API POST to INSERT form parameters as separate rows in `patient_activity_set_form_data` table. (3) Fixed frontend `getHistoricalParamValues()` and `getLastUsedParamValue()` to read from `set.form_data` array instead of `set.form_params` object. (4) Fixed frontend `saveLoggedSet()` to send `form_data` as normalized array instead of object. Weight/distance split into value + unit fields. **Files:** `pt-rebuild/api/logs.js`, `pt-rebuild/public/index.html`. **Why critical:** This is the correct normalized SQL approach - "one row one thing" - not like Firebase where everything was nested objects. User was right to be concerned about Firebase-like structure being unsafe in SQL.

- **2026-01-19** — **Remaining work:** (1) Exercise detail/history view - modal showing all activity logs for a specific exercise with set-by-set details. (2) Warning indicators - show "⚠️ X days ago" for exercises not done recently. (3) Terminology fixes - change "Session" to "Activity Log" throughout UI. (4) Test all features on deployed Vercel site - verify form parameters save correctly to normalized tables. **Priority:** Test on deployed site to confirm form parameters actually save/load correctly.

- **2026-01-19** — **Architecture decisions:** (1) No Firebase or JSON fallbacks in rebuild - all data comes from Supabase API endpoints. (2) Server-authoritative - Supabase PostgreSQL is source of truth, client is advisory. (3) CSS prepared for dark mode with variables but implementation deferred. (4) Following iOS PWA patterns from original (data-action, pointerup, no onclick). (5) Pattern modifiers determine UI mode: duration_seconds/hold_seconds show timer, standard exercises show counter. **Constraints:** User has autism and requires "same same same" - app must work identically to original Firebase version. No changes to clinical workflows allowed.

## 2026-01-28

- **2026-01-28** — **Maintenance:** Moved shared exercises/programs handlers into `pt-rebuild/lib/handlers` and updated API route wrappers to point at the shared modules to reduce serverless function duplication. **Docs:** Mirrored `/pt/docs` into `pt-rebuild/public/docs` for rebuild parity and added `pt-rebuild/agent.md` to summarize rebuild-specific guidance.

## 2026-01-28

- **2026-01-28** — **Docs:** Rewrote the public rebuild docs in `pt-rebuild/public/docs` to reflect Supabase/Vercel architecture instead of copying legacy Firebase documentation.

## 2026-01-30

- **2026-01-30** — **API:** Added exercise form parameter names to the programs payload by joining exercise form parameters and normalizing them into `form_parameters_required`, keeping the patient tracker data consistent with exercise metadata. **Files:** `pt-rebuild/lib/handlers/programs.js`.
- **2026-01-30** — **Messages:** Fixed message labeling/undo visibility by aligning client-side comparisons with `users.id` instead of auth IDs, and clarified sender/recipient labels in both patient (`index.html`) and therapist (`pt_view.html`) messaging UIs. **Also:** Ensured hidden messages are actually filtered per-user by excluding `archived_by_sender`/`archived_by_recipient` in the messages API response. **Files:** `pt-rebuild/public/index.html`, `pt-rebuild/public/pt_view.html`, `pt-rebuild/api/logs.js`.

## 2026-01-31

- **2026-01-31** — **Deep dive audit and critical fixes.** **Problems found:** (1) IndexedDB transaction bug - `await tx.complete` doesn't exist, transactions use `.done`. (2) Unsafe destructuring of API responses could crash on undefined. (3) All 13 inline onclick handlers in pt_editor.html unreliable on iOS Safari/PWA. (4) Missing PWA meta tags on pt_editor, pt_view, rehab_coverage. (5) `requireTherapist()` in auth.js missing accessToken attachment. (6) Supabase SDK loaded from CDN caused tracking prevention warnings. **What I did:** (1) Fixed IndexedDB bug in offline.js line 132. (2) Added fallback patterns (`|| []`) to all unsafe destructuring in offline.js, report.js, index.html. (3) Converted all onclick/oninput/onchange handlers to data-action + pointerup pattern with bindPointerHandlers() and bindInputHandlers(). (4) Added PWA meta tags including new `mobile-web-app-capable` standard. (5) Fixed requireTherapist() and added requireTherapistOrAdmin() as separate function. (6) Self-hosted Supabase SDK to `/js/vendor/supabase.min.js` and created GitHub Action `.github/workflows/update-supabase-sdk.yml` to auto-update monthly. **Files:** `offline.js`, `report.js`, `index.html`, `pt_editor.html`, `pt_view.html`, `rehab_coverage.html`, `sw.js`, `lib/auth.js`.

- **2026-01-31** — **Voice announcements and UI improvements.** **What I did:** Added "Working left side" / "Working right side" voice announcement when selecting side for bilateral exercises. Added "All sets complete" announcement when finishing all sets (with flag to prevent repeat announcements). Fixed exercise list to show "Done today" immediately after logging by adding to allHistory array and re-rendering. **Files:** `pt-rebuild/public/index.html`.

- **2026-01-31** — **Cleanup:** Deleted unused files `tracker.html` and `pt_tracker.html` (legacy Firebase version still exists in `/pt`). Updated `sw.js` cache to v6 with correct asset list including self-hosted Supabase SDK.

- **2026-01-31** — **New icon:** Created PT² icon variant (dark grey background #333, white "PT", powder blue superscript "2") to distinguish rebuild from original `/pt` app on iOS home screen. **Files:** `icons/icon.svg`, `manifest.json`.

## 2026-02-01

- **2026-02-01** — **Problem:** Duration timer exercises logged 0 seconds instead of actual elapsed time when timer reached 0. **What I did:** When duration timer hits 0, the code was resetting `timerState.elapsedMs = 0`, so `confirmNextSet()` captured 0 instead of actual time. Fixed by setting `timerState.elapsedMs = timerState.targetSeconds * 1000` when duration completes, preserving the actual elapsed time for logging. **Files:** `pt-rebuild/public/index.html`.

- **2026-02-01** — **Problem:** Form parameters (band_resistance, weight, etc.) and pattern modifiers (hold_seconds, duration_seconds, distance_feet) not displayed in history views. **What I did:** (1) Updated `renderHistory()` in index.html to show sets summary with reps/seconds/distance (e.g., "3 sets: 10r, 10r × 30s") and form params from first set. (2) Updated pt_view.html compact summary to show combined reps×seconds format and form params. (3) Updated pt_view.html expanded set details to include form_data with format "parameter_name: value unit". **Files:** `pt-rebuild/public/index.html`, `pt-rebuild/public/pt_view.html`.

- **2026-02-01** — **Problem:** rehab_coverage.html calling non-existent `/api/users/me` endpoint causing 404 error. **What I did:** Instead of creating new API endpoint (Vercel function limit), added `user_role` field to existing `/api/roles` GET response since auth middleware already loads user role. Updated rehab_coverage.html to extract role from roles response in `loadData()` instead of separate API call. **Files:** `pt-rebuild/api/roles.js`, `pt-rebuild/public/rehab_coverage.html`.

- **2026-02-01** — **Problem:** pt_view.html showing incorrect "Exercises" count (16/16 instead of X/30) and "All exercises up to date" when exercises were overdue. Root cause: (1) `/api/programs` requires `patient_id` but pt_view wasn't passing it. (2) For therapists, `/api/logs` without `patient_id` defaults to therapist's own ID (no logs). **What I did:** (1) Added `viewingPatientId` variable set in `loadCurrentUserProfile()` - for therapists, finds their patient from users list; for patients, uses own ID. (2) Modified `loadData()` to pass `patient_id` to both `/api/logs` and `/api/programs`. (3) Fixed `calculateNeedsAttention()` to get exercise names from `program.exercises?.canonical_name` (nested API structure). **Files:** `pt-rebuild/public/pt_view.html`.

- **2026-02-01** — **Problem:** Therapists and admins could only see their own user record due to restrictive RLS policy `users_select_own`. `/api/users` was returning only 1 user, so therapists couldn't find their assigned patients. **What I did:** (1) Updated `/api/users.js` to use admin Supabase client (bypasses RLS) with application-level filtering: admins see all users, therapists see themselves + patients where `therapist_id` matches their ID, patients see only themselves. (2) Created RLS migration `005_users_rls_policy_update.sql` with new policy `users_select_by_role` that allows therapists to see patients assigned to them and admins to see all users. **Files:** `pt-rebuild/api/users.js`, `pt-rebuild/db/migrations/005_users_rls_policy_update.sql`.

- **2026-02-01** — **Problem:** Archived exercises still appearing in exercise lists across all views. **What I did:** Added filter `.filter(p => !p.exercises?.archived)` when loading programs in pt_view.html. **Files:** `pt-rebuild/public/pt_view.html`.

- **2026-02-01** — **Problem:** rehab_coverage.html showing checkmarks for exercises done >7 days ago instead of warning icons. **What I did:** Updated status icon logic to show ⚠ warning symbol (orange) for exercises either never done or done 7+ days ago, checkmark (green) only for exercises done within 7 days. **Files:** `pt-rebuild/public/rehab_coverage.html`.

## 2026-02-04

- **2026-02-04** — **Problem:** Editing or deleting logged exercises returned 404 errors. The frontend was calling `/api/logs/${id}` with PATCH/DELETE methods, but the API only supported these methods for messages (`type=messages`), not for activity logs. **What I did:** (1) Added `updateActivityLog()` and `deleteActivityLog()` handlers to `/api/logs.js` that handle PATCH and DELETE requests when `id` query parameter is provided. (2) Updated frontend `saveEditSession()` and `deleteSession()` functions to use `/api/logs?id=X` query parameter format instead of path-based `/api/logs/${id}`. The update handler replaces all sets (deletes existing sets and form_data, then inserts new ones). **Files:** `pt-rebuild/api/logs.js`, `pt-rebuild/public/index.html`.

- **2026-02-04** — **Problem:** LOG SET for exercises with `hold_seconds` pattern modifier logged a single REP instead of a complete SET. The modal only asked for reps count, not hold time. **What I did:** (1) Added a second input field (`logSetTimeInput`) to the Log Set modal for entering seconds per rep. (2) Updated `showLogSetModal()` to show the time input and prefill it with target hold time when exercise has `hold_seconds`. (3) Updated `saveLoggedSet()` to detect manual hold entry (when time input is visible) and create a complete SET with both reps and seconds, bypassing the rep-by-rep timer flow. Manual entries are marked with `manual_log: true`. **Files:** `pt-rebuild/public/index.html`.

- **2026-02-04** — **Problem:** Edit Session modal didn't show seconds/time or distance fields for exercises with those pattern modifiers (`hold_seconds`, `duration_seconds`, `distance_feet`). Only showed reps and side. **What I did:** (1) Updated `renderEditSessionSets()` to detect exercise type and show appropriate fields: seconds input for hold/duration exercises, distance input for distance exercises. Labels adapt to context ("Seconds/rep" for hold, "Seconds" for duration). (2) Updated `saveEditSession()` to collect values from `.edit-set-seconds` and `.edit-set-distance` inputs. (3) Updated `addEditSessionSet()` to pre-fill default seconds/distance values based on exercise prescription. (4) Fixed history display format to always show reps/seconds/distance when present using compact format: "10r × 5s", "30s", "20ft". **Files:** `pt-rebuild/public/index.html`.

- **2026-02-04** — **Problem:** Exercise details modal only showed description and pattern, not equipment, muscles, or guidance/cues. Root cause: The `/api/programs` endpoint was trying to select `equipment`, `primary_muscles`, `secondary_muscles`, `guidance` as columns from the `exercises` table, but these don't exist as columns - they're stored in separate related tables (`exercise_equipment`, `exercise_muscles`, `exercise_guidance`). **What I did:** (1) Updated `/api/programs` query to use nested selects for the related tables: `exercise_equipment(equipment_name, is_required)`, `exercise_muscles(muscle_name, is_primary)`, `exercise_guidance(section, content, sort_order)`. (2) Updated `normalizeProgramPatternModifiers()` to transform these nested arrays into the format the frontend expects: `equipment: {required: [...], optional: [...]}`, `primary_muscles: [...]`, `secondary_muscles: [...]`, `guidance: {motor_cues: [...], compensation_warnings: [...], safety_flags: [...], external_cues: [...]}`. **Files:** `pt-rebuild/lib/handlers/programs.js`.

- **2026-02-04** — **Problem:** History display didn't show side information for sided exercises, and side selector wasn't shown if exercise wasn't found in allExercises. **What I did:** (1) Updated history `setsSummary` to append "(L)" or "(R)" for sets with side data. (2) Updated `openEditSessionModal()` to detect `isSided` from either exercise pattern OR presence of side data in existing sets, ensuring side selector appears even if exercise lookup fails. **Files:** `pt-rebuild/public/index.html`.

- **2026-02-04** — **PWA Offline Support Implementation.** **Problem:** App was intended to work offline as a PWA, but data didn't persist to IndexedDB. The `OfflineManager` class existed in `/js/offline.js` but wasn't wired up to `index.html`. **What I did:** (1) Fixed `offline.js` to use proper native IndexedDB patterns (added `_waitForTransaction()` helper, fixed transaction completion handling). (2) Wired up `OfflineManager` in `index.html`: imports module, initializes on app start, sets up online/offline event listeners. (3) Implemented offline-only cache: when offline, loads from IndexedDB; when online, fetches from API directly (no stale-then-refresh pattern which would cause jarring re-renders and scroll position loss). (4) Added auto-sync on reconnection: when coming back online, syncs pending queue items and refreshes cache. (5) Added `updateSyncStatusUI()` function showing sync badge states: red for pending items, gray for offline. (6) Updated `/api/sync.js` to write to `offline_mutations` table for server-side audit. (7) Cache hydration happens in background after successful API load. **Architecture:** Online: API fetch → render once → hydrate cache in background. Offline: IndexedDB cache → render once. Auto-sync: online event → sync pending queue → hydrate cache. **Files:** `pt-rebuild/public/js/offline.js`, `pt-rebuild/public/index.html`, `pt-rebuild/api/sync.js`.

## 2026-02-16

### Security Hardening (Low-Risk Only)

All changes are low-risk, non-breaking hardening. Medium/high-risk items deferred (see Remaining Work below).

- **2026-02-16** — **Removed hardcoded Supabase fallback credentials from `pt_editor.js`.** The client-side editor had `FALLBACK_SUPABASE_URL` and `FALLBACK_SUPABASE_ANON_KEY` constants used when `/api/env` failed. Removed these and replaced with an explicit `throw new Error(...)` so a config failure is visible rather than silently using stale credentials. **Files:** `pt-rebuild/public/js/pt_editor.js`.

- **2026-02-16** — **Restricted `/api/debug` endpoint to admin role only.** Previously any authenticated user could call `GET /api/debug` and see their full user context object. Now returns 403 for non-admins. **Files:** `pt-rebuild/api/debug.js`.

- **2026-02-16** — **Cached admin Supabase client as singleton in `db.js`.** The anon client was already cached, but `getSupabaseAdmin()` created a new `createClient()` instance on every call. Now uses `supabaseAdminClient` singleton matching the anon client pattern. **Files:** `pt-rebuild/lib/db.js`.

- **2026-02-16** — **Added error checks on delete operations in `logs.js` update path.** The `updateActivityLog()` PATCH handler deleted existing sets and form_data before inserting replacements, but never checked the delete results. If deletes failed silently, subsequent inserts would create duplicate sets. Now checks `formDeleteError` and `setsDeleteError` and throws on failure. **Files:** `pt-rebuild/api/logs.js` (lines 357-371).

- **2026-02-16** — **Stripped `error.message` from all 500 responses in production.** 25 instances across 8 API files were leaking internal error details (stack traces, DB error messages) to clients. Changed all to `details: process.env.NODE_ENV === 'development' ? error.message : undefined` so details only appear in dev mode. **Files:** `api/logs.js`, `api/vocab.js`, `api/roles.js`, `api/reference-data.js`, `api/users.js`, `lib/handlers/exercises.js`, `lib/handlers/programs.js`.

- **2026-02-16** — **Deleted dead code files `tracker.js` and `report.js`.** Verified zero HTML references and zero `import` statements across the entire `public/` directory. Removed from `sw.js` STATIC_ASSETS list and bumped service worker cache to v7 to force clients to drop the stale cached copies. **Files:** deleted `public/js/tracker.js`, deleted `public/js/report.js`, `public/sw.js`.

### Read Receipts Feature

- **2026-02-16** — **Added `read_at` timestamp column to `clinical_messages`.** Created migration `011_add_message_read_at.sql` (idempotent with `IF NOT EXISTS`). Column was also added directly to live Supabase DB by user, so migration is documentation/safety net only. Updated `schema.sql` to match live DB (also added `sent_at` column that existed in live DB but was missing from repo schema). **Files:** `db/migrations/011_add_message_read_at.sql`, `db/schema.sql`.

- **2026-02-16** — **Added `supabase_schema.sql` to repo.** User exported live Supabase schema and committed to main. Merged into feature branch. This file is the authoritative reference for live DB state. **Files:** `db/supabase_schema.sql` (from main).

- **2026-02-16** — **Wired up server-side read tracking in `logs.js` `updateMessage()`.** When `PATCH` is called with `{ read: true }`, the handler now also sets `read_at` to the current timestamp — but only on first read (never overwritten, never cleared). The existing `read_by_recipient` boolean still gets set/unset normally. **Files:** `api/logs.js` (lines 661-667).

- **2026-02-16** — **Wired up read receipts in both frontend views.** (1) **Mark as read server-side:** When messages modal opens, `markReceivedMessagesAsRead()` fetches all messages, finds unread ones where current user is the recipient, and fires PATCH `{ read: true }` for each (fire-and-forget, non-blocking). (2) **Display read status on sent messages:** Each sent message now shows "Read [local datetime]" in green (using existing `formatMessageDateTime()` which uses local timezone) or "Delivered" in grey if unread. Read receipt appears bottom-right of the message card. **Files:** `public/index.html`, `public/pt_view.html`.

---

## Remaining Work (For Next Session)

### Priority 0 — Security (Medium Risk, Deferred)

1. **`sync.js` uses anon Supabase client instead of auth-context client.** Line 19 calls `getSupabaseClient()` (anon key) for patient data inserts. Should use `getSupabaseWithAuth(req.accessToken)` so RLS policies enforce access control per user. Risk: if `req.accessToken` is ever invalid, inserts fail where they previously worked — but `requirePatient` middleware guarantees the token. **Files:** `api/sync.js`.

2. **No therapist→patient authorization check in `createActivityLog()`.** Any authenticated user can POST to `/api/logs` with any `patient_id`. Should verify that the therapist has a relationship to the patient (via `therapist_id` in users table) before allowing cross-user logging. Risk: could block legitimate operations if therapist-patient relationships aren't fully populated in DB. **Files:** `api/logs.js` (lines 170-188).

### Priority 1 — Data Integrity (Medium/High Risk, Deferred)

3. **`sync.js` has no cleanup on partial failure.** If the activity log insert succeeds but the sets insert fails, the log is left orphaned with no sets. Should either delete the orphaned log or wrap in a transaction. Risk: cleanup logic could make things worse if the delete also fails (loses idempotency via `client_mutation_id`). **Files:** `api/sync.js` (lines 161-199).

4. **Form data matched to sets by array index, not `set_number`.** In both `createActivityLog()` and `updateActivityLog()`, form_data is associated with sets via array index (`createdSets[i]`). If Supabase returns sets in a different order than submitted, form_data gets attached to wrong sets. **HIGH RISK to change** — current approach works in practice because Supabase returns inserted rows in order. Changing to `set_number` matching could break if clients don't consistently populate `set_number`. **Files:** `api/logs.js` (lines 252-254, 392-405).

5. **`offline.js` `addToQueue()` resolves on `request.onsuccess` instead of `tx.oncomplete`.** The write could still be rolled back after the promise resolves. Should resolve on transaction complete instead. Low-medium risk, unlikely to matter in practice. **Files:** `public/js/offline.js` (lines 184-186).

### Priority 2 — Reliability/Performance (Low Risk, Deferred)

6. **`users.js` fetches all users then filters in memory.** For admins this is fine, but therapists and patients fetch every user in the system just to filter down to 1-2 records. Should add `.eq()` filters at the DB query level per role. **Files:** `api/users.js` (lines 18-41).

### Priority 3 — UI/UX

7. **Hamburger menu consistency across views.** The hamburger menu implementation exists in 4 HTML files (`index.html`, `pt_view.html`, `pt_editor.html`, `rehab_coverage.html`) plus shared `js/hamburger-menu.js` and `css/hamburger-menu.css`. Each page has slightly different menu items and inline event handling. Should audit for consistency: ensure all pages use the shared JS/CSS, have matching menu structure, and follow the same `data-action` + `pointerup` pattern. **Files:** `public/js/hamburger-menu.js`, `public/css/hamburger-menu.css`, all 4 HTML files.

## 2026-02-19

- **2026-02-19** — **Exercise date fields missing from pt_editor edit view.** **Problem:** When selecting an exercise to edit, Added Date and Last Updated fields were always blank despite data existing in the database. **Root causes (two bugs):** (1) Missing HTML elements — the JS tried to populate `#addedDate` and `#updatedDate` inputs but those elements didn't exist in the HTML. The optional chaining (`if (addedDateEl)`) silently skipped them. (2) ISO timestamp vs date input format — the DB stores full ISO timestamps (`2026-01-15T12:34:56.000Z`) but `<input type="date">` requires `YYYY-MM-DD`. The browser silently rejects mismatched formats. **What I did:** (1) Added `#addedDate` and `#updatedDate` readonly inputs to the Lifecycle & Status section, hidden for new exercises, shown when editing. (2) Added `toDateInput()` helper to strip the time portion from ISO timestamps. (3) Fixed lifecycle field mapping — the API returns lifecycle data nested (`exercise.lifecycle.status`) but the JS was referencing flat paths (`exercise.lifecycle_status`), so effective start/end dates also never populated when editing. **Files:** `pt-rebuild/public/pt_editor.html`, `pt-rebuild/public/js/pt_editor.js`.

### Reference: Live DB vs Repo Schema

The file `db/supabase_schema.sql` is the authoritative live DB export. The file `db/schema.sql` is the repo's CREATE TABLE script (used for documentation and fresh deploys). These should be kept in sync. As of 2026-02-16 they match, including the `read_at` and `sent_at` columns on `clinical_messages`.
