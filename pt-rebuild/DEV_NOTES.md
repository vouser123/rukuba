# PT Tracker Rebuild - Development Notes

This file tracks development progress on the Supabase/Vercel rebuild of the PT tracker app.

## 2026-01-19

- **2026-01-19** — **Progress:** Implemented core tracker features in rebuilt index.html. **What was done:** (1) Added timer mode with countdown display, beeps at 5 seconds and completion, and voice announcements ("5 seconds left", "4", "3", "2", "1", "Time"). Timer counts up to show elapsed time and auto-pauses at target but allows continuing beyond. (2) Created big tappable circle for reps counting (320px diameter, iOS-optimized with scale feedback on tap). Removed +/- buttons in favor of single tap-to-increment interface with undo button. (3) Added voice countdown for reps mode - announces "5 reps left", "4 reps left", etc. when approaching target. (4) Implemented pattern modifier detection to show timer mode for `duration_seconds` and `hold_seconds` exercises, counter mode for standard reps. (5) Created `formatDosage()` function to display exercise prescriptions as "3 × 10 reps", "3 × 30 sec", "20 feet", or "3 × 10 reps (5 sec hold)" based on patient_programs data. (6) Used CSS variables (--counter-color, --counter-bg, --timer-color) for future dark mode support. (7) All interactions use data-action with pointerup events per iOS PWA requirements (no onclick handlers). **Files:** `pt-rebuild/public/index.html`. **Notes:** Timer uses Web Audio API for beeps and Web Speech API for voice - both require user interaction on iOS to initialize. Set data is saved with either reps or seconds based on mode.

- **2026-01-19** — **CRITICAL FIX: Form parameters now use normalized SQL structure.** **Problem:** Initial implementation treated form_params like Firebase JSONB object. Supabase uses normalized table `patient_activity_set_form_data` with one row per parameter (activity_set_id + parameter_name + parameter_value + parameter_unit). **What I did:** (1) Updated API `/api/logs` GET to JOIN form_data table and return `form_data: [{parameter_name, parameter_value, parameter_unit}]` array per set. (2) Updated API POST to INSERT form parameters as separate rows in `patient_activity_set_form_data` table. (3) Fixed frontend `getHistoricalParamValues()` and `getLastUsedParamValue()` to read from `set.form_data` array instead of `set.form_params` object. (4) Fixed frontend `saveLoggedSet()` to send `form_data` as normalized array instead of object. Weight/distance split into value + unit fields. **Files:** `pt-rebuild/api/logs.js`, `pt-rebuild/public/index.html`. **Why critical:** This is the correct normalized SQL approach - "one row one thing" - not like Firebase where everything was nested objects. User was right to be concerned about Firebase-like structure being unsafe in SQL.

- **2026-01-19** — **Remaining work:** (1) Exercise detail/history view - modal showing all activity logs for a specific exercise with set-by-set details. (2) Warning indicators - show "⚠️ X days ago" for exercises not done recently. (3) Terminology fixes - change "Session" to "Activity Log" throughout UI. (4) Test all features on deployed Vercel site - verify form parameters save correctly to normalized tables. **Priority:** Test on deployed site to confirm form parameters actually save/load correctly.

- **2026-01-19** — **Architecture decisions:** (1) No Firebase or JSON fallbacks in rebuild - all data comes from Supabase API endpoints. (2) Server-authoritative - Supabase PostgreSQL is source of truth, client is advisory. (3) CSS prepared for dark mode with variables but implementation deferred. (4) Following iOS PWA patterns from original (data-action, pointerup, no onclick). (5) Pattern modifiers determine UI mode: duration_seconds/hold_seconds show timer, standard exercises show counter. **Constraints:** User has autism and requires "same same same" - app must work identically to original Firebase version. No changes to clinical workflows allowed.

## 2026-01-28

- **2026-01-28** — **Maintenance:** Moved shared exercises/programs handlers into `pt-rebuild/lib/handlers` and updated API route wrappers to point at the shared modules to reduce serverless function duplication. **Docs:** Mirrored `/pt/docs` into `pt-rebuild/public/docs` for rebuild parity and added `pt-rebuild/agent.md` to summarize rebuild-specific guidance.

## 2026-01-28

- **2026-01-28** — **Docs:** Rewrote the public rebuild docs in `pt-rebuild/public/docs` to reflect Supabase/Vercel architecture instead of copying legacy Firebase documentation.

## 2026-01-30

- **2026-01-30** — **API:** Added exercise form parameter names to the programs payload by joining exercise form parameters and normalizing them into `form_parameters_required`, keeping the patient tracker data consistent with exercise metadata. **Files:** `pt-rebuild/lib/handlers/programs.js`.
- **2026-01-30** — **Messages:** Fixed message labeling/undo visibility by aligning client-side comparisons with `users.id` instead of auth IDs, and clarified sender/recipient labels in both patient (`index.html`) and therapist (`pt_view.html`) messaging UIs. **Also:** Ensured hidden messages are actually filtered per-user by excluding `archived_by_sender`/`archived_by_recipient` in the messages API response. **Files:** `pt-rebuild/public/index.html`, `pt-rebuild/public/pt_view.html`, `pt-rebuild/api/logs.js`.

## 2026-01-31

- **2026-01-31** — **Deep dive audit and critical fixes.** **Problems found:** (1) IndexedDB transaction bug - `await tx.complete` doesn't exist, transactions use `.done`. (2) Unsafe destructuring of API responses could crash on undefined. (3) All 13 inline onclick handlers in pt_editor.html unreliable on iOS Safari/PWA. (4) Missing PWA meta tags on pt_editor, pt_view, rehab_coverage. (5) `requireTherapist()` in auth.js missing accessToken attachment. (6) Supabase SDK loaded from CDN caused tracking prevention warnings. **What I did:** (1) Fixed IndexedDB bug in offline.js line 132. (2) Added fallback patterns (`|| []`) to all unsafe destructuring in offline.js, report.js, index.html. (3) Converted all onclick/oninput/onchange handlers to data-action + pointerup pattern with bindPointerHandlers() and bindInputHandlers(). (4) Added PWA meta tags including new `mobile-web-app-capable` standard. (5) Fixed requireTherapist() and added requireTherapistOrAdmin() as separate function. (6) Self-hosted Supabase SDK to `/js/vendor/supabase.min.js` and created GitHub Action `.github/workflows/update-supabase-sdk.yml` to auto-update monthly. **Files:** `offline.js`, `report.js`, `index.html`, `pt_editor.html`, `pt_view.html`, `rehab_coverage.html`, `sw.js`, `lib/auth.js`.

- **2026-01-31** — **Voice announcements and UI improvements.** **What I did:** Added "Working left side" / "Working right side" voice announcement when selecting side for bilateral exercises. Added "All sets complete" announcement when finishing all sets (with flag to prevent repeat announcements). Fixed exercise list to show "Done today" immediately after logging by adding to allHistory array and re-rendering. **Files:** `pt-rebuild/public/index.html`.

- **2026-01-31** — **Cleanup:** Deleted unused files `tracker.html` and `pt_tracker.html` (legacy Firebase version still exists in `/pt`). Updated `sw.js` cache to v6 with correct asset list including self-hosted Supabase SDK.

- **2026-01-31** — **New icon:** Created PT² icon variant (dark grey background #333, white "PT", powder blue superscript "2") to distinguish rebuild from original `/pt` app on iOS home screen. **Files:** `icons/icon.svg`, `manifest.json`.

## 2026-02-01

- **2026-02-01** — **Problem:** Duration timer exercises logged 0 seconds instead of actual elapsed time when timer reached 0. **What I did:** When duration timer hits 0, the code was resetting `timerState.elapsedMs = 0`, so `confirmNextSet()` captured 0 instead of actual time. Fixed by setting `timerState.elapsedMs = timerState.targetSeconds * 1000` when duration completes, preserving the actual elapsed time for logging. **Files:** `pt-rebuild/public/index.html`.

- **2026-02-01** — **Problem:** Form parameters (band_resistance, weight, etc.) and pattern modifiers (hold_seconds, duration_seconds, distance_feet) not displayed in history views. **What I did:** (1) Updated `renderHistory()` in index.html to show sets summary with reps/seconds/distance (e.g., "3 sets: 10r, 10r × 30s") and form params from first set. (2) Updated pt_view.html compact summary to show combined reps×seconds format and form params. (3) Updated pt_view.html expanded set details to include form_data with format "parameter_name: value unit". **Files:** `pt-rebuild/public/index.html`, `pt-rebuild/public/pt_view.html`.

- **2026-02-01** — **Problem:** rehab_coverage.html calling non-existent `/api/users/me` endpoint causing 404 error. **What I did:** Instead of creating new API endpoint (Vercel function limit), added `user_role` field to existing `/api/roles` GET response since auth middleware already loads user role. Updated rehab_coverage.html to extract role from roles response in `loadData()` instead of separate API call. **Files:** `pt-rebuild/api/roles.js`, `pt-rebuild/public/rehab_coverage.html`.
