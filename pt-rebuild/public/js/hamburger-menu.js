/**
 * Shared Hamburger Menu Component
 *
 * Provides consistent hamburger menu functionality across all PT Tracker pages.
 * Uses data-action pattern for iOS Safari/PWA compatibility.
 *
 * Design: inject() generates the full overlay + panel HTML so each page only
 * needs the ‚ò∞ trigger button. Page-specific items are passed as menuItems config.
 * Nav links are auto-generated by renderNavLinks() based on current page and role.
 *
 * Usage:
 * 1. Add the hamburger trigger button: <button data-action="toggle-hamburger">‚ò∞</button>
 * 2. Include this script: <script src="/js/hamburger-menu.js"></script>
 * 3. After auth resolves, call HamburgerMenu.init({ currentUser, signOutFn, page, isAdmin, menuItems, onAction })
 */

/** All navigable pages. adminOnly:true hides the link for patient-role users. */
const NAV_PAGES = [
    { id: 'index',          href: 'index.html',          label: 'üì± PT Tracker',       adminOnly: false },
    { id: 'pt_view',        href: 'pt_view.html',        label: 'üìä View History',      adminOnly: false },
    { id: 'pt_editor',      href: 'pt_editor.html',      label: '‚úèÔ∏è Exercise Editor',  adminOnly: true  },
    { id: 'rehab_coverage', href: '/rehab',              label: 'üìà Coverage Analysis', adminOnly: false },
];

const HamburgerMenu = {
    config: {
        currentUser: null,
        signOutFn: null,
        onAction: null,
        showTrackerLink: null, // deprecated ‚Äî no-op after DN-006
        page: null,            // current page id for nav link generation (e.g. 'index')
        isAdmin: false,        // true for therapist/admin users
        menuItems: [],         // page-specific action items (rendered above Reload/Sign Out)
    },

    /**
     * Initialize the hamburger menu component.
     * Injects panel HTML, binds events, fills user display, and renders nav links.
     * Safe to call multiple times (inject is idempotent; bindHandlers skips already-bound elements).
     * @param {Object} options - Configuration options
     * @param {Object} options.currentUser - Supabase user object with .email
     * @param {Function} options.signOutFn - Called on sign-out action
     * @param {string} options.page - Current page id (one of NAV_PAGES ids)
     * @param {boolean} options.isAdmin - True for therapist/admin users
     * @param {Array} options.menuItems - Page-specific items: [{action, icon, label, badge?, badge2?}]
     * @param {Function} options.onAction - Custom action handler; return true to suppress default
     */
    init(options = {}) {
        this.config = { ...this.config, ...options };
        this.inject();                  // 1. Build DOM first (idempotent)
        this.bindHandlers();            // 2. Bind events (elements now exist)
        this.updateUserDisplay();       // 3. Fill user email
        if (this.config.page) {
            this.renderNavLinks(this.config.page, this.config.isAdmin); // 4. Nav links
        }
    },

    /**
     * Inject the full hamburger overlay and panel HTML into the DOM.
     * Pages only need the ‚ò∞ trigger button; all panel HTML is generated here.
     * Idempotent ‚Äî skips if #hamburgerMenu already exists in the DOM.
     */
    inject() {
        if (document.getElementById('hamburgerMenu')) return;

        // Full-screen overlay (dims background, tap to close)
        const overlay = document.createElement('div');
        overlay.className = 'hamburger-overlay';
        overlay.id = 'hamburgerOverlay';
        overlay.dataset.action = 'toggle-hamburger';

        // Menu panel
        const menu = document.createElement('div');
        menu.className = 'hamburger-menu';
        menu.id = 'hamburgerMenu';
        menu.innerHTML = `
            <div class="hamburger-header">
                <h3>Menu</h3>
                <button class="hamburger-close" data-action="toggle-hamburger">Close</button>
            </div>
            <div class="user-info">
                <div class="user-label">Signed in as</div>
                <div class="user-email" id="userEmail">-</div>
            </div>
            <div id="hamburgerNavLinks"></div>
            <div id="hamburgerPageItems"></div>
            <div class="hamburger-item" data-action="reload">
                <span class="hamburger-icon">üîÑ</span>
                <span>Reload</span>
            </div>
            <div class="hamburger-item" data-action="sign-out">
                <span class="hamburger-icon">üö™</span>
                <span>Sign Out</span>
            </div>
        `;

        // Render page-specific action items (Messages, Sync, Debug, Refresh Data, etc.)
        const pageItemsEl = menu.querySelector('#hamburgerPageItems');
        for (const item of (this.config.menuItems || [])) {
            const div = document.createElement('div');
            div.className = 'hamburger-item';
            div.dataset.action = item.action;
            const hasRelativeIcon = !!(item.badge || item.badge2);
            div.innerHTML = `
                <span class="hamburger-icon"${hasRelativeIcon ? ' style="position: relative;"' : ''}>
                    ${item.icon}
                    ${item.badge  ? `<span id="${item.badge}"  class="messages-badge hidden"></span>` : ''}
                    ${item.badge2 ? `<span id="${item.badge2}" class="sent-badge hidden"></span>`    : ''}
                </span>
                <span>${item.label}</span>
            `;
            pageItemsEl.appendChild(div);
        }

        // Fixed-position elements ‚Äî DOM order doesn't matter for layout
        document.body.appendChild(overlay);
        document.body.appendChild(menu);
    },

    /**
     * Toggle hamburger menu visibility.
     */
    toggle() {
        const overlay = document.getElementById('hamburgerOverlay');
        const menu = document.getElementById('hamburgerMenu');
        if (overlay && menu) {
            overlay.classList.toggle('active');
            menu.classList.toggle('active');
        }
    },

    /**
     * Close the hamburger menu.
     */
    close() {
        const overlay = document.getElementById('hamburgerOverlay');
        const menu = document.getElementById('hamburgerMenu');
        if (overlay) overlay.classList.remove('active');
        if (menu) menu.classList.remove('active');
    },

    /**
     * Update user email display in hamburger menu.
     */
    updateUserDisplay() {
        const emailEl = document.getElementById('userEmail');
        const user = this.config.currentUser;
        if (emailEl && user) {
            emailEl.textContent = user.email || 'Unknown';
        }
    },

    /**
     * Dynamically generate nav links for the hamburger menu.
     * Excludes the current page; respects adminOnly per NAV_PAGES entry.
     * Inserts anchor elements into #hamburgerNavLinks.
     * @param {string} currentPageId - One of the NAV_PAGES ids (e.g. 'index')
     * @param {boolean} isAdmin - True if user is therapist or admin
     */
    renderNavLinks(currentPageId, isAdmin) {
        const container = document.getElementById('hamburgerNavLinks');
        if (!container) return;
        container.innerHTML = '';
        for (const page of NAV_PAGES) {
            if (page.id === currentPageId) continue;     // skip current page
            if (page.adminOnly && !isAdmin) continue;    // hide gated pages for patients
            const a = document.createElement('a');
            a.href = page.href;
            a.className = 'hamburger-item';
            a.textContent = page.label;
            container.appendChild(a);
        }
    },

    /**
     * Bind iOS-safe pointer event handlers to elements with data-action attributes.
     * iOS Safari/PWA does not reliably trigger onclick on dynamically created elements.
     * Skips elements already bound (safe to call multiple times).
     * @param {HTMLElement} root - Root element to search (default: document)
     */
    bindHandlers(root = document) {
        const actionElements = root.querySelectorAll('[data-action]');

        actionElements.forEach(el => {
            if (el.dataset.hamburgerBound) return;
            el.dataset.hamburgerBound = 'true';

            el.addEventListener('pointerup', (e) => this.handleAction(e));
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.handleAction(e);
                }
            });
        });
    },

    /**
     * Handle data-action events from pointer/keyboard interactions.
     * Checks custom onAction handler first; falls back to built-in defaults.
     * Stops event propagation when an action is handled, preventing document-level
     * dispatchers from double-firing for hamburger actions.
     * @param {Event} e - The triggering event
     */
    handleAction(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        let handled = false;

        // Check for custom handler first
        if (this.config.onAction) {
            handled = this.config.onAction(action, target, e);
        }

        if (!handled) {
            // Default handlers for common actions
            switch (action) {
                case 'toggle-hamburger':
                    this.toggle();
                    handled = true;
                    break;
                case 'sign-out':
                    this.close();
                    if (this.config.signOutFn) {
                        this.config.signOutFn();
                    }
                    handled = true;
                    break;
                case 'reload':
                    this.close();
                    location.reload();
                    handled = true;
                    break;
            }
        }

        // Stop propagation only for handled actions ‚Äî prevents document-level
        // dispatchers from double-handling the same event.
        if (handled) e.stopPropagation();
    }
};

// Export for module systems
if (typeof module !== 'undefined' && module.exports) {
    module.exports = HamburgerMenu;
}
