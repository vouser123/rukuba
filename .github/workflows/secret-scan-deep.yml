name: Secret Scan (Deep)

on:
  schedule:
    - cron: '30 6 * * 1' # Weekly Monday 06:30 UTC
  workflow_dispatch:

jobs:
  gitleaks-history-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks history scan (report only)
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest \
            git /repo \
            --no-banner --no-color --redact --exit-code 0 \
            --report-format json \
            --report-path /repo/gitleaks-history-report.json

          count=$(jq 'length' gitleaks-history-report.json)
          echo "gitleaks_history_findings=$count"
          if [ "$count" -gt 0 ]; then
            echo "::warning::Gitleaks history findings (review report artifact): $count"
          fi

      - name: Upload Gitleaks report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-history-report
          path: gitleaks-history-report.json

  trufflehog-verified-history:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog verified scan (full git history)
        shell: bash
        run: |
          set -euo pipefail
          set +e
          docker run --rm -v "$PWD:/repo" trufflesecurity/trufflehog:latest \
            git file:///repo \
            --results=verified \
            --no-update \
            --fail \
            --json > /tmp/trufflehog-history-verified.json
          status=$?
          set -e

          count=$(grep -c '^{' /tmp/trufflehog-history-verified.json || true)
          echo "verified_history_findings=$count"

          if [ "$count" -gt 0 ]; then
            echo "::error::TruffleHog verified history findings: $count"
          fi

          if [ "$status" -ne 0 ]; then
            exit 1
          fi
