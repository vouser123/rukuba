name: Secret Scan (Fast)

on:
  pull_request:
  push:
    branches:
      - main
      - nextjs

jobs:
  gitleaks-strict:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Gitleaks strict scan (working tree)
        run: |
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest \
            dir /repo \
            --config /repo/.gitleaks-strict.toml \
            --no-banner --no-color --redact --exit-code 1

  trufflehog-verified:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run TruffleHog verified scan (working tree)
        shell: bash
        run: |
          set -euo pipefail
          set +e
          docker run --rm -v "$PWD:/repo" trufflesecurity/trufflehog:latest \
            filesystem /repo \
            --exclude-paths=/repo/.trufflehog-exclude-paths.txt \
            --results=verified \
            --no-update \
            --fail \
            --json > /tmp/trufflehog-verified.json
          status=$?
          set -e

          count=$(grep -c '^{' /tmp/trufflehog-verified.json || true)
          echo "verified_findings=$count"

          if [ "$count" -gt 0 ]; then
            echo "::error::TruffleHog verified findings: $count"
          fi

          if [ "$status" -ne 0 ]; then
            exit 1
          fi
