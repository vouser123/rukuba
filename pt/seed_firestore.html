<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Shared Data Seeder</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 24px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        h1 {
            font-size: 22px;
            margin: 0 0 12px;
        }

        .status {
            margin: 16px 0;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            font-size: 14px;
            white-space: pre-wrap;
        }

        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .auth-panel {
            margin-top: 16px;
            padding: 16px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .auth-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .auth-grid label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .auth-grid input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
            font-size: 13px;
        }

        .options label {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-primary {
            background: var(--ios-blue);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            min-height: 44px;
            -webkit-appearance: none;
            appearance: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .hint {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PT Shared Data Seeder</h1>
        <p class="hint">
            This tool seeds Firestore collection <strong>pt_shared</strong> with the latest JSON files
            in this repo. You must be signed in for writes to succeed.
        </p>
        <div class="hint">
            <strong>Recommended order:</strong>
            <ol style="margin: 8px 0 0 18px; padding: 0;">
                <li><strong>Sign in</strong> with a Firebase account that has write access.</li>
                <li><strong>Seed Shared Data</strong> to update <code>pt_shared</code> from JSON sources.</li>
                <li><strong>Migrate PT Dosage → Runtime</strong> if you want shared dosage values copied into user runtime data.</li>
                <li><strong>Reload Status</strong> to confirm auth and status changes.</li>
            </ol>
        </div>
        <div class="actions">
            <button class="btn-primary" id="seed-btn">Seed Shared Data</button>
            <button class="btn-primary" id="migrate-btn">Migrate PT Dosage → Runtime</button>
            <button class="btn-secondary" id="reload-btn">Reload Status</button>
        </div>
        <div class="options">
            <label>
                <input type="checkbox" id="overwrite-dosage">
                Overwrite existing dosage values in runtime
            </label>
            <label>
                <input type="checkbox" id="record-history" checked>
                Record migration entries in exercise history
            </label>
        </div>
        <div class="auth-panel">
            <strong>Login</strong>
            <div class="hint">
                Sign in with a Firebase-authenticated account before seeding. Use this page for admin actions only.
            </div>
            <div class="auth-grid" id="auth-credential-fields"></div>
            <div class="actions">
                <button class="btn-primary" id="auth-reveal-btn">Sign In</button>
                <button class="btn-secondary" id="logout-btn">Sign Out</button>
            </div>
            <div class="hint" id="auth-status">Waiting for auth…</div>
        </div>
        <div class="status" id="status">Waiting for auth…</div>
    </div>

    <script type="module">
        import {
            auth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            setPersistence,
            browserLocalPersistence
        } from './firebase.js';
        import { seedSharedFromJsonSources, migrateSharedDosageToRuntime } from './shared/firestore_shared_data.js';

        const statusEl = document.getElementById('status');
        const authStatusEl = document.getElementById('auth-status');
        const seedBtn = document.getElementById('seed-btn');
        const migrateBtn = document.getElementById('migrate-btn');
        const reloadBtn = document.getElementById('reload-btn');
        const overwriteDosageToggle = document.getElementById('overwrite-dosage');
        const recordHistoryToggle = document.getElementById('record-history');
        const authRevealBtn = document.getElementById('auth-reveal-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authFieldsContainer = document.getElementById('auth-credential-fields');
        let authEmailInput = null;
        let authPasswordInput = null;

        let currentUser = null;

        function setStatus(message) {
            statusEl.textContent = message;
        }

        function setButtonsEnabled(enabled) {
            seedBtn.disabled = !enabled;
            seedBtn.style.opacity = enabled ? '1' : '0.6';
            migrateBtn.disabled = !enabled;
            migrateBtn.style.opacity = enabled ? '1' : '0.6';
        }

        function describeAuthState(user) {
            if (!user) {
                return 'Not signed in. Use Sign In to authenticate before seeding.';
            }
            return `Signed in as ${user.email || user.uid}. Ready for Firebase updates.`;
        }

        function ensureAuthCredentialFields() {
            if (!authFieldsContainer || authFieldsContainer.childElementCount > 0) return;
            // Create credential inputs only after explicit user action to avoid iOS PWA autofill prompts.
            const emailField = document.createElement('div');
            const emailLabel = document.createElement('label');
            emailLabel.setAttribute('for', 'auth-email');
            emailLabel.textContent = 'Email';
            const emailInput = document.createElement('input');
            emailInput.id = 'auth-email';
            emailInput.type = 'email';
            emailInput.autocomplete = 'email';
            emailInput.placeholder = 'you@example.com';
            emailField.appendChild(emailLabel);
            emailField.appendChild(emailInput);

            const passwordField = document.createElement('div');
            const passwordLabel = document.createElement('label');
            passwordLabel.setAttribute('for', 'auth-password');
            passwordLabel.textContent = 'Password';
            const passwordInput = document.createElement('input');
            passwordInput.id = 'auth-password';
            passwordInput.type = 'password';
            passwordInput.autocomplete = 'current-password';
            passwordInput.placeholder = '••••••••';
            passwordField.appendChild(passwordLabel);
            passwordField.appendChild(passwordInput);

            const loginActions = document.createElement('div');
            loginActions.className = 'actions';
            const loginButton = document.createElement('button');
            loginButton.className = 'btn-primary';
            loginButton.id = 'login-btn';
            loginButton.textContent = 'Sign In';
            loginActions.appendChild(loginButton);

            authFieldsContainer.appendChild(emailField);
            authFieldsContainer.appendChild(passwordField);
            authFieldsContainer.appendChild(loginActions);

            authEmailInput = emailInput;
            authPasswordInput = passwordInput;

            loginButton.addEventListener('click', handleLoginSubmit);
            passwordInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleLoginSubmit();
                }
            });
        }

        function clearAuthCredentialFields() {
            if (!authFieldsContainer) return;
            // Remove credential inputs once auth is complete so they are not mounted on navigation.
            authFieldsContainer.innerHTML = '';
            authEmailInput = null;
            authPasswordInput = null;
        }

        async function handleSeed() {
            if (!currentUser) {
                setStatus('Sign in required before seeding.');
                return;
            }
            setStatus('Seeding Firestore from JSON sources…');
            setButtonsEnabled(false);
            try {
                await seedSharedFromJsonSources();
                setStatus('✅ Seed complete. Shared documents updated.');
            } catch (error) {
                console.error('Seed failed:', error);
                setStatus(`❌ Seed failed: ${error.message}`);
            } finally {
                setButtonsEnabled(true);
            }
        }

        async function handleDosageMigration() {
            if (!currentUser) {
                setStatus('Sign in required before migrating dosage.');
                return;
            }
            setStatus('Migrating PT dosage from shared library to runtime…');
            setButtonsEnabled(false);
            try {
                const result = await migrateSharedDosageToRuntime({
                    userId: currentUser.uid,
                    overwriteExisting: overwriteDosageToggle.checked,
                    recordHistory: recordHistoryToggle.checked
                });
                const summary = [
                    `✅ Migration complete for ${currentUser.uid}.`,
                    `Shared exercises with dosage: ${result.total}`,
                    `Updated runtime entries: ${result.updated}`,
                    `Skipped (already had dosage): ${result.skipped}`,
                    result.skippedNoLibrary
                        ? `Skipped (no runtime library found): ${result.skippedNoLibrary}`
                        : null
                ].filter(Boolean).join('\n');
                setStatus(summary);
            } catch (error) {
                console.error('Migration failed:', error);
                setStatus(`❌ Migration failed: ${error.message}`);
            } finally {
                setButtonsEnabled(true);
            }
        }

        async function handleLoginSubmit() {
            if (!authEmailInput || !authPasswordInput) {
                authStatusEl.textContent = 'Tap Sign In to enter credentials.';
                return;
            }
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value;
            if (!email || !password) {
                authStatusEl.textContent = 'Email and password are required.';
                return;
            }
            authStatusEl.textContent = 'Signing in…';
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                authStatusEl.textContent = 'Signed in successfully.';
                clearAuthCredentialFields();
            } catch (error) {
                console.error('Sign in failed:', error);
                authStatusEl.textContent = `Sign in failed: ${error.message}`;
            }
        }

        seedBtn.addEventListener('click', handleSeed);
        migrateBtn.addEventListener('click', handleDosageMigration);
        reloadBtn.addEventListener('click', () => {
            setStatus(describeAuthState(currentUser));
        });
        authRevealBtn.addEventListener('click', () => {
            ensureAuthCredentialFields();
            if (authEmailInput) {
                authEmailInput.focus();
            }
        });
        logoutBtn.addEventListener('click', async () => {
            authStatusEl.textContent = 'Signing out…';
            try {
                await signOut(auth);
                authStatusEl.textContent = 'Signed out.';
                clearAuthCredentialFields();
            } catch (error) {
                console.error('Sign out failed:', error);
                authStatusEl.textContent = `Sign out failed: ${error.message}`;
            }
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            setStatus(describeAuthState(user));
            authStatusEl.textContent = describeAuthState(user);
            setButtonsEnabled(!!user);
        });
    </script>
</body>
</html>
