<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Rehab Coverage</title>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* Coverage-specific overrides */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        body {
            padding: 8px;
            padding-bottom: 60px;
            line-height: 1.3;
        }

        #coverage-content {
            max-width: 100%;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-btn {
            background: var(--bg-secondary);
            color: var(--ios-blue);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-family: inherit;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
        }

        .header-btn:active {
            opacity: 0.7;
        }

        /* Region Accordion */
        .region-section {
            margin-bottom: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }

        .region-header {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            max-width: 100%;
        }

        .region-header:active {
            opacity: 0.8;
        }

        .region-header h2 {
            font-size: 16px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .region-chevron {
            font-size: 16px;
            transition: transform 0.2s;
        }

        .region-section.expanded .region-chevron {
            transform: rotate(90deg);
        }

        .region-content {
            display: none;
            padding: 6px 0;
        }

        .region-section.expanded .region-content {
            display: block;
        }

        /* Capacity Row */
        .capacity-row {
            background: var(--bg-tertiary);
            padding: 8px 10px;
            margin: 6px 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            max-width: 100%;
            overflow-x: hidden;
        }

        .capacity-header {
            cursor: pointer;
        }

        .capacity-header:active {
            opacity: 0.8;
        }

        .capacity-header.no-pointer {
            cursor: default;
        }

        .capacity-name {
            font-size: 14px;
            font-weight: 500;
            text-transform: capitalize;
            flex: 1;
        }

        .capacity-term {
            color: var(--ios-blue);
            font-size: 13px;
            margin-left: 6px;
        }


        .capacity-chevron {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s;
            margin-left: 8px;
        }

        .capacity-row.expanded .capacity-chevron {
            transform: rotate(90deg);
        }

        /* Focus Rows */
        .focus-list {
            display: none;
            margin-top: 6px;
            padding-left: 10px;
            border-left: 2px solid var(--border-color);
        }

        .capacity-row.expanded .focus-list {
            display: block;
        }

        .focus-term {
            color: var(--ios-blue);
            font-size: 12px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--ios-blue);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .modal-close:active {
            opacity: 0.7;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .vocab-section {
            margin-bottom: 20px;
        }

        .vocab-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--ios-blue);
            text-transform: capitalize;
        }

        .vocab-item {
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .vocab-term {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: capitalize;
        }

        .vocab-def {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .exercise-item {
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .exercise-item:active {
            opacity: 0.8;
        }

        .exercise-name {
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .exercise-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .back-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ios-blue);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .back-button:active {
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(255, 69, 58, 0.1);
            border: 1px solid var(--ios-red);
            color: var(--ios-red);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        /* Slide-out Menu */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 9998;
        }

        .menu-overlay.active {
            display: block;
        }

        .slide-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: min(300px, 80vw);
            height: 100%;
            background: var(--bg-secondary);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.5);
        }

        .slide-menu.active {
            right: 0;
        }

        .menu-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-title {
            font-size: 20px;
            font-weight: 600;
        }

        .menu-close {
            background: none;
            border: none;
            color: var(--ios-blue);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .menu-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:active {
            background: var(--bg-tertiary);
        }

        .menu-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item-text {
            font-size: 16px;
        }

        /* Roles Editor Modal */
        .roles-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .roles-editor-modal.active {
            display: flex;
        }

        .roles-editor-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-size: 20px;
            font-weight: 600;
        }

        .editor-close {
            background: none;
            border: none;
            color: var(--ios-blue);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .editor-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--ios-blue);
        }

        /* Roles Editor Components */
        .role-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .role-details {
            flex: 1;
        }

        .role-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Rehab Coverage</h1>
        <button class="header-btn" onclick="toggleMenu()">‚ò∞</button>
    </div>

    <!-- Slide-out Menu -->
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>
    <div class="slide-menu" id="slide-menu">
        <div class="menu-header">
            <div class="menu-title">Menu</div>
            <button class="menu-close" onclick="toggleMenu()">Close</button>
        </div>
        <div class="menu-item" onclick="location.reload()">
            <div class="menu-item-icon">üîÑ</div>
            <div class="menu-item-text">Reload</div>
        </div>
        <div class="menu-item" onclick="toggleDebug(); toggleMenu();">
            <div class="menu-item-icon">üêõ</div>
            <div class="menu-item-text">Debug Info</div>
        </div>
        <div class="menu-item" onclick="openVocabulary(); toggleMenu();">
            <div class="menu-item-icon">üìö</div>
            <div class="menu-item-text">Vocabulary</div>
        </div>
        <div class="menu-item" onclick="openRolesEditor()">
            <div class="menu-item-icon">‚úèÔ∏è</div>
            <div class="menu-item-text">Edit Roles</div>
        </div>
        <div class="menu-item" onclick="exportAllData()">
            <div class="menu-item-icon">üíæ</div>
            <div class="menu-item-text">Export All Data</div>
        </div>
        <div class="menu-item" onclick="importData()">
            <div class="menu-item-icon">üì•</div>
            <div class="menu-item-text">Import Data</div>
        </div>
        <div class="menu-item" onclick="goBack()">
            <div class="menu-item-icon">‚Üê</div>
            <div class="menu-item-text">Back to PT Tracker</div>
        </div>
    </div>

    <!-- Roles Editor Modal -->
    <div class="roles-editor-modal" id="roles-editor">
        <div class="roles-editor-content">
            <div class="editor-header">
                <div class="editor-title">Edit Roles</div>
                <button class="editor-close" onclick="closeRolesEditor()">Done</button>
            </div>
            <div class="editor-body" id="editor-body">
                <!-- Content filled by JavaScript -->
            </div>
        </div>
    </div>

    <div id="debug-panel" style="display: none; background: var(--bg-secondary); padding: 12px; margin-bottom: 16px; border-radius: 8px; border: 1px solid var(--ios-yellow); font-size: 11px; font-family: monospace;">
        <div style="font-weight: 600; margin-bottom: 8px; color: var(--ios-yellow);">Debug Info</div>
        <div id="debug-content"></div>
    </div>

    <div id="coverage-content" class="loading">Loading...</div>

    <!-- Vocabulary Modal -->
    <div id="vocab-modal" class="modal" onclick="if(event.target === this) closeVocabulary()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Vocabulary</div>
                <button class="modal-close" onclick="closeVocabulary()">Done</button>
            </div>
            <div class="modal-body" id="vocab-content"></div>
        </div>
    </div>

    <!-- Term Definition Modal -->
    <div id="term-modal" class="modal" onclick="if(event.target === this) closeTermDefinition()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="term-modal-title"></div>
                <button class="modal-close" onclick="closeTermDefinition()">Close</button>
            </div>
            <div class="modal-body" id="term-modal-content"></div>
        </div>
    </div>

    <button class="back-button" onclick="goBack()">‚Üê Back to PT Tracker</button>

    <script>
        // Global data stores
        let schema = null;
        let rolesData = null;
        let vocabulary = null;
        let exerciseLibrary = null;
        let sessionHistory = null;

        // Derived lists (runtime only - NO HARDCODED ENUMS)
        let regions = [];
        let capacities = [];
        let contributions = [];

        // Initialize
        async function init() {
            try {
                // Load all data files
                await Promise.all([
                    loadSchema(),
                    loadRoles(),
                    loadVocabulary(),
                    loadExerciseLibrary(),
                    loadSessionHistory()
                ]);

                // Derive enums from schema
                deriveEnums();

                // Render coverage view
                renderCoverageView();
            } catch (error) {
                document.getElementById('coverage-content').innerHTML =
                    `<div class="error">Error loading data: ${error.message}</div>`;
                console.error('Init error:', error);
            }
        }

        async function loadSchema() {
            const response = await fetch('schema/exercise_roles.schema.json');
            if (!response.ok) throw new Error(`Schema fetch failed: ${response.status}`);
            schema = await response.json();
            console.log('[Schema] Loaded:', schema);
        }

        async function loadRoles() {
            const response = await fetch('exercise_roles.json');
            if (!response.ok) throw new Error(`Roles fetch failed: ${response.status}`);
            rolesData = await response.json();
            console.log('[Roles] Loaded:', Object.keys(rolesData.exercise_roles || {}).length, 'exercises with roles');

            // Debug: Show sample role exercise IDs
            const roleExerciseIds = Object.keys(rolesData.exercise_roles || {});
            if (roleExerciseIds.length > 0) {
                console.log('[Roles] Sample exercise IDs:', roleExerciseIds.slice(0, 5));
            }
        }

        async function loadVocabulary() {
            const response = await fetch('exercise_roles_vocabulary.json');
            if (!response.ok) throw new Error(`Vocabulary fetch failed: ${response.status}`);
            vocabulary = await response.json();

            // Validate schema version match
            if (vocabulary.schema_version && schema.schema_version) {
                if (vocabulary.schema_version !== schema.schema_version) {
                    throw new Error(`Schema version mismatch! Vocabulary: ${vocabulary.schema_version}, Schema: ${schema.schema_version}`);
                }
            }
        }

        async function loadExerciseLibrary() {
            const response = await fetch('exercise_library.json');
            if (!response.ok) throw new Error(`Library fetch failed: ${response.status}`);
            const data = await response.json();
            exerciseLibrary = data.exercises || [];
            console.log('[Library] Loaded:', exerciseLibrary.length, 'exercises');
        }

        function loadSessionHistory() {
            // Load from PT Tracker localStorage (uses 'pt_tracker_data' key, NOT 'session_history')
            const historyJSON = localStorage.getItem('pt_tracker_data');
            sessionHistory = historyJSON ? JSON.parse(historyJSON) : [];
            console.log('[History] Loaded:', sessionHistory.length, 'sessions');

            // Debug: Show ALL unique exercise IDs in session history
            if (sessionHistory.length > 0) {
                const uniqueIds = [...new Set(sessionHistory.map(s => s.exerciseId))];
                console.log('[History] Unique exercise IDs in session history:', uniqueIds);
                console.log('[History] Sample session objects:', sessionHistory.slice(0, 3));
            } else {
                console.warn('[History] NO SESSION HISTORY FOUND! localStorage key "pt_tracker_data" is empty or missing.');
            }
        }

        function deriveEnums() {
            // Extract enums from schema - NO HARDCODING
            // Schema uses 'definitions' (not $defs)
            if (!schema || !schema.definitions || !schema.definitions.role) {
                throw new Error('Schema not properly loaded or missing definitions.role');
            }
            const roleSchema = schema.definitions.role;
            regions = roleSchema.properties.region.enum || [];
            capacities = roleSchema.properties.capacity.enum || [];
            contributions = roleSchema.properties.contribution.enum || [];
            console.log('[Enums] Derived:', { regions, capacities, contributions });
        }

        // Get unique focuses for a (region, capacity) pair
        function getFocuses(region, capacity) {
            const focuses = new Set();
            // Data structure: rolesData.exercise_roles[exerciseId].roles[]
            Object.keys(rolesData.exercise_roles).forEach(exerciseId => {
                const exerciseData = rolesData.exercise_roles[exerciseId];
                exerciseData.roles.forEach(role => {
                    if (role.region === region && role.capacity === capacity && role.focus) {
                        focuses.add(role.focus);
                    }
                });
            });
            return Array.from(focuses);
        }

        // Get all exercises for a (region, capacity, focus) bucket with their status
        function getExercisesForBucket(region, capacity, focus = null) {
            const exercises = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Find all exercises with matching roles
            Object.keys(rolesData.exercise_roles).forEach(exerciseId => {
                const exerciseData = rolesData.exercise_roles[exerciseId];
                exerciseData.roles.forEach(role => {
                    if (role.region !== region || role.capacity !== capacity) return;

                    // Check focus match
                    if (focus === null) {
                        if (role.focus) return; // Skip focused roles when looking for general
                    } else {
                        if (role.focus !== focus) return; // Skip if focus doesn't match
                    }

                    // Find most recent session for this exercise
                    const sessions = sessionHistory.filter(s => {
                        const match = s.exerciseId === exerciseId;
                        if (!match && exerciseId.startsWith('01K')) {
                            // Debug ULID exercises only
                            console.log(`[Match] Checking ${exerciseId.substring(0, 10)}... vs session ${s.exerciseId?.substring(0, 10)}... = ${match}`);
                        }
                        return match;
                    });
                    sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const lastSession = sessions[0];

                    const exerciseInfo = {
                        id: exerciseId,
                        name: exerciseData.name || exerciseId,
                        contribution: role.contribution,
                        focus: role.focus || null,
                        done: !!lastSession,
                        lastDate: lastSession ? new Date(lastSession.date) : null,
                        daysSince: lastSession ? Math.floor((today - new Date(lastSession.date)) / (1000 * 60 * 60 * 24)) : null
                    };

                    // Avoid duplicates (exercise might have multiple roles for same bucket)
                    if (!exercises.find(e => e.id === exerciseId)) {
                        exercises.push(exerciseInfo);
                    }
                });
            });

            // Sort: done exercises first (by recency), then not done (by name)
            exercises.sort((a, b) => {
                if (a.done && !b.done) return -1;
                if (!a.done && b.done) return 1;
                if (a.done && b.done) return a.daysSince - b.daysSince;
                return a.name.localeCompare(b.name);
            });

            return exercises;
        }

        // Get unique exercises from array (by ID)
        function getUniqueExercises(exercises) {
            return Array.from(new Set(exercises.map(e => e.id)))
                .map(id => exercises.find(e => e.id === id));
        }

        // Get color for completion percentage
        function getPercentColor(percent, goodThreshold = 70, okThreshold = 40) {
            if (percent >= goodThreshold) return 'var(--ios-green)';
            if (percent >= okThreshold) return 'var(--ios-yellow)';
            return 'var(--ios-red)';
        }

        // Render exercise list for a bucket
        function renderExerciseList(exercises) {
            if (exercises.length === 0) {
                return '<div style="padding: 12px; color: var(--text-secondary); font-size: 13px;">No exercises assigned to this role</div>';
            }

            const contributionColors = {
                high: 'var(--ios-red)',
                medium: 'var(--ios-yellow)',
                low: 'var(--ios-blue)'
            };

            let html = '<div style="padding: 4px 0;">';
            exercises.forEach(ex => {
                const statusIcon = ex.done ? '‚úì' : '‚ö†';
                const statusColor = ex.done ? 'var(--ios-green)' : 'var(--ios-orange)';
                const statusText = ex.done ? `${ex.daysSince}d` : 'not done';
                const contribColor = contributionColors[ex.contribution] || 'var(--text-secondary)';

                html += `
                    <div class="exercise-card border-l-3" style="border-left-color: ${contribColor};">
                        <span class="exercise-card-icon" style="color: ${statusColor};">${statusIcon}</span>
                        <div class="exercise-card-content">
                            <div class="exercise-card-title">${ex.name}</div>
                            <div class="exercise-card-meta">
                                <span class="font-weight-600" style="color: ${contribColor};">${ex.contribution}</span>
                                <span style="margin: 0 4px;">‚Ä¢</span>
                                <span style="color: ${statusColor};">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }


        // Render coverage view
        function renderCoverageView() {
            // Calculate overall stats
            const allExercises = [];
            regions.forEach(region => {
                const capacities = getCapacitiesForRegion(region);
                capacities.forEach(capacity => {
                    const exercises = getExercisesForBucket(region, capacity, null);
                    allExercises.push(...exercises);
                });
            });

            const uniqueExercises = getUniqueExercises(allExercises);

            const totalExercises = uniqueExercises.length;
            const doneExercises = uniqueExercises.filter(e => e.done).length;
            const donePercent = totalExercises > 0 ? Math.round((doneExercises / totalExercises) * 100) : 0;

            // Find most recent session
            let mostRecentDays = null;
            if (sessionHistory.length > 0) {
                const mostRecentTimestamp = Math.max(...sessionHistory.map(s => s.timestamp));
                const daysSince = Math.floor((Date.now() - mostRecentTimestamp) / (1000 * 60 * 60 * 24));
                mostRecentDays = daysSince;
            }

            const recencyColor = mostRecentDays === null ? 'var(--text-secondary)' :
                                 mostRecentDays === 0 ? 'var(--ios-green)' :
                                 mostRecentDays <= 3 ? 'var(--ios-green)' :
                                 mostRecentDays <= 7 ? 'var(--ios-yellow)' : 'var(--ios-red)';
            const recencyText = mostRecentDays === null ? 'No sessions yet' :
                               mostRecentDays === 0 ? 'Today' : `${mostRecentDays}d ago`;

            // Rolling 7-day activity
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentSessions = sessionHistory.filter(s => s.timestamp >= sevenDaysAgo);
            const recentExerciseIds = [...new Set(recentSessions.map(s => s.exerciseId))];
            const recentExercisesInLibrary = uniqueExercises.filter(e => recentExerciseIds.includes(e.id));
            const weeklyDone = recentExercisesInLibrary.length;
            const weeklyPercent = totalExercises > 0 ? Math.round((weeklyDone / totalExercises) * 100) : 0;
            const weeklyColor = getPercentColor(weeklyPercent, 50, 25);
            const overallColor = getPercentColor(donePercent);

            let html = `
                <div class="overview-card">
                    <div class="overview-header">
                        <span class="font-13 font-weight-600 text-secondary">Coverage Overview</span>
                        <span class="font-11" style="color: ${recencyColor};">Last session: ${recencyText}</span>
                    </div>
                    <div class="overview-stats">
                        <span class="overview-percentage" style="color: ${overallColor};">${donePercent}%</span>
                        <div class="flex-1">
                            <div class="font-11 text-secondary mb-2">${doneExercises} of ${totalExercises} exercises done</div>
                            <div class="progress-bar">
                                <div class="progress-fill progress-fill-gradient" style="width: ${donePercent}%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="overview-weekly">
                        <span class="font-11 text-secondary">Last 7 days (rolling)</span>
                        <div class="flex-center gap-6">
                            <span class="font-13 font-weight-600" style="color: ${weeklyColor};">${weeklyDone}/${totalExercises}</span>
                            <span class="font-11" style="color: ${weeklyColor};">(${weeklyPercent}%)</span>
                        </div>
                    </div>
                </div>
            `;

            regions.forEach(region => {
                // Calculate region completion
                const regionExercises = [];
                const capacities = getCapacitiesForRegion(region);
                capacities.forEach(capacity => {
                    const exercises = getExercisesForBucket(region, capacity, null);
                    regionExercises.push(...exercises);
                });
                const regionUniqueExercises = getUniqueExercises(regionExercises);
                const regionTotal = regionUniqueExercises.length;
                const regionDone = regionUniqueExercises.filter(e => e.done).length;
                const regionPercent = regionTotal > 0 ? Math.round((regionDone / regionTotal) * 100) : 0;
                const regionColor = getPercentColor(regionPercent);

                html += `
                    <div class="region-section" id="region-${region}">
                        <div class="region-header" onclick="toggleRegion('${region}')">
                            <h2>${region}</h2>
                            <div class="flex-center gap-8">
                                <span class="font-11 font-weight-600" style="color: ${regionColor};">${regionPercent}%</span>
                                <span class="region-chevron">‚Ä∫</span>
                            </div>
                        </div>
                        <div class="region-content">
                            ${renderRegionCapacities(region)}
                        </div>
                    </div>
                `;
            });

            document.getElementById('coverage-content').innerHTML = html;
        }

        // Get capacities that actually have exercises for this region
        function getCapacitiesForRegion(region) {
            const capacitiesSet = new Set();

            Object.keys(rolesData.exercise_roles).forEach(exerciseId => {
                const exerciseData = rolesData.exercise_roles[exerciseId];
                exerciseData.roles.forEach(role => {
                    if (role.region === region) {
                        capacitiesSet.add(role.capacity);
                    }
                });
            });

            return Array.from(capacitiesSet);
        }

        function renderRegionCapacities(region) {
            let html = '';

            // Only show capacities that have exercises for this region
            const regionCapacities = getCapacitiesForRegion(region);

            if (regionCapacities.length === 0) {
                html += '<div style="padding: 12px; color: var(--text-secondary); font-size: 13px;">No exercises for this region</div>';
                return html;
            }

            regionCapacities.forEach(capacity => {
                const focuses = getFocuses(region, capacity);
                const generalExercises = getExercisesForBucket(region, capacity, null); // No specific focus

                // Also get all focus exercises for overall metrics
                let allExercises = [...generalExercises];
                focuses.forEach(focus => {
                    allExercises = allExercises.concat(getExercisesForBucket(region, capacity, focus));
                });

                // Skip if no exercises at all
                if (allExercises.length === 0) {
                    return; // Skip this capacity
                }

                const hasChevron = focuses.length > 0 || generalExercises.length > 0;

                // Calculate overall metrics
                const doneExercises = allExercises.filter(e => e.done);
                const totalCount = allExercises.length;
                const doneCount = doneExercises.length;

                // Get most recent activity
                let lastActivity = null;
                if (doneExercises.length > 0) {
                    doneExercises.sort((a, b) => a.daysSince - b.daysSince);
                    lastActivity = doneExercises[0].daysSince;
                }

                // Build summary with progress bar and recency indicator
                const doneIcon = doneCount === totalCount ? '‚úì' : (doneCount > 0 ? '‚ö†' : '‚úó');
                const doneColor = doneCount === totalCount ? 'var(--ios-green)' : (doneCount > 0 ? 'var(--ios-yellow)' : 'var(--ios-red)');
                const progress = totalCount > 0 ? (doneCount / totalCount * 100) : 0;

                // Calculate opacity based on recency (fades over 14 days)
                const opacity = lastActivity !== null ? Math.max(0.3, 1 - (lastActivity / 14)) : 0.3;
                const recencyText = lastActivity !== null ? `${lastActivity}d` : '‚Äî';

                const summary = `
                    <div class="flex-center gap-4">
                        <span style="color: ${doneColor}; font-size: 12px;">${doneIcon}</span>
                        <span class="font-11 nowrap">${doneCount}/${totalCount}</span>
                        <div class="progress-bar flex-1" style="min-width: 20px;">
                            <div class="progress-fill" style="width: ${progress}%; background: ${doneColor}; opacity: ${opacity};"></div>
                        </div>
                        <span class="font-11 text-secondary nowrap">${recencyText}</span>
                    </div>
                `;

                html += `
                    <div class="capacity-row ${hasChevron ? '' : 'no-expand'}" id="capacity-${region}-${capacity}">
                        <div class="capacity-header${hasChevron ? '' : ' no-pointer'} flex-center gap-6 flex-wrap" ${hasChevron ? `onclick="toggleCapacity('${region}', '${capacity}')"` : ''}>
                            <div class="flex-center gap-6" style="flex: 0 0 auto;">
                                <span class="capacity-name">${capacity}</span>
                                <span class="capacity-term" onclick="event.stopPropagation(); showTermDefinition('capacity', '${capacity}')" style="flex: 0 0 auto;">‚ìò</span>
                            </div>
                            <div class="flex-1" style="min-width: 0;">${summary}</div>
                            ${hasChevron ? '<span class="capacity-chevron" style="flex: 0 0 auto;">‚Ä∫</span>' : ''}
                        </div>
                        ${hasChevron ? `
                            <div class="focus-list">
                                ${generalExercises.length > 0 ? `
                                    <div class="px-12 py-8 font-13 text-secondary font-weight-500">General</div>
                                    ${renderExerciseList(generalExercises)}
                                ` : ''}
                                ${focuses.length > 0 ? renderFocuses(region, capacity, focuses) : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            return html;
        }

        function renderFocuses(region, capacity, focuses) {
            let html = '';

            focuses.forEach(focus => {
                const focusExercises = getExercisesForBucket(region, capacity, focus);
                const doneCount = focusExercises.filter(e => e.done).length;
                const totalCount = focusExercises.length;

                html += `
                    <div class="m-8 p-8 bg-secondary rounded-md border-l-3" style="border-left-color: var(--ios-blue);">
                        <div class="flex-center gap-6 mb-6 flex-wrap">
                            <span class="font-13 font-weight-600 flex-1" style="text-transform: capitalize; min-width: 0;">${focus.replace(/_/g, ' ')}</span>
                            <div class="flex-center gap-6" style="flex: 0 0 auto;">
                                <span class="focus-term text-blue font-12" onclick="showTermDefinition('focus', '${focus}')" style="cursor: pointer;">‚ìò</span>
                                <span class="font-11 text-secondary nowrap">${doneCount}/${totalCount} done</span>
                            </div>
                        </div>
                        ${renderExerciseList(focusExercises)}
                    </div>
                `;
            });

            return html;
        }

        // Toggle region accordion
        function toggleRegion(region) {
            const section = document.getElementById(`region-${region}`);
            section.classList.toggle('expanded');
        }

        // Toggle capacity accordion
        function toggleCapacity(region, capacity) {
            const row = document.getElementById(`capacity-${region}-${capacity}`);
            row.classList.toggle('expanded');
        }

        // Show vocabulary modal
        function openVocabulary() {
            let html = '';

            // Regions
            html += '<div class="vocab-section"><h3>Regions</h3>';
            Object.keys(vocabulary.region || {}).forEach(term => {
                html += `
                    <div class="vocab-item">
                        <div class="vocab-term">${term.replace(/_/g, ' ')}</div>
                        <div class="vocab-def">${vocabulary.region[term]}</div>
                    </div>
                `;
            });
            html += '</div>';

            // Capacities
            html += '<div class="vocab-section"><h3>Capacities</h3>';
            Object.keys(vocabulary.capacity || {}).forEach(term => {
                html += `
                    <div class="vocab-item">
                        <div class="vocab-term">${term.replace(/_/g, ' ')}</div>
                        <div class="vocab-def">${vocabulary.capacity[term]}</div>
                    </div>
                `;
            });
            html += '</div>';

            // Contributions
            html += '<div class="vocab-section"><h3>Contributions</h3>';
            Object.keys(vocabulary.contribution || {}).forEach(term => {
                html += `
                    <div class="vocab-item">
                        <div class="vocab-term">${term.replace(/_/g, ' ')}</div>
                        <div class="vocab-def">${vocabulary.contribution[term]}</div>
                    </div>
                `;
            });
            html += '</div>';

            // Focus Terms
            html += '<div class="vocab-section"><h3>Focus Terms</h3>';
            Object.keys(vocabulary.focus || {}).forEach(term => {
                html += `
                    <div class="vocab-item">
                        <div class="vocab-term">${term.replace(/_/g, ' ')}</div>
                        <div class="vocab-def">${vocabulary.focus[term]}</div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('vocab-content').innerHTML = html;
            document.getElementById('vocab-modal').classList.add('active');
        }

        function closeVocabulary() {
            document.getElementById('vocab-modal').classList.remove('active');
        }

        // Show term definition inline
        function showTermDefinition(category, term) {
            const definitions = vocabulary[category];
            const definition = definitions && definitions[term];

            document.getElementById('term-modal-title').textContent = term.replace(/_/g, ' ');
            document.getElementById('term-modal-content').innerHTML = definition
                ? `<div class="vocab-def">${definition}</div>`
                : `<div class="vocab-def" style="color: var(--ios-red);">Definition not found (undefined)</div>`;

            document.getElementById('term-modal').classList.add('active');
        }

        function closeTermDefinition() {
            document.getElementById('term-modal').classList.remove('active');
        }


        // Toggle debug panel
        function toggleDebug() {
            const panel = document.getElementById('debug-panel');
            const isVisible = panel.style.display !== 'none';

            if (!isVisible) {
                // Populate debug info
                let debugHtml = '';

                // localStorage inspection
                debugHtml += `<div style="margin-bottom: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">`;
                debugHtml += `<strong>localStorage status:</strong><br>`;
                debugHtml += `<strong>Total keys:</strong> ${localStorage.length}<br>`;
                debugHtml += `<strong>All keys:</strong><br>`;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    const valuePreview = value.length > 50 ? value.substring(0, 50) + '...' : value;
                    debugHtml += `&nbsp;&nbsp;${key}: ${value.length} chars<br>`;
                }
                debugHtml += `</div>`;

                // Session history info
                debugHtml += `<div style="margin-bottom: 8px;">`;
                debugHtml += `<strong>Sessions:</strong> ${sessionHistory.length}<br>`;

                if (sessionHistory.length > 0) {
                    const uniqueIds = [...new Set(sessionHistory.map(s => s.exerciseId))];
                    debugHtml += `<strong>Unique exercises:</strong> ${uniqueIds.length}<br>`;
                    debugHtml += `<strong>Sample IDs:</strong><br>`;
                    uniqueIds.slice(0, 5).forEach(id => {
                        debugHtml += `&nbsp;&nbsp;${id}<br>`;
                    });
                } else {
                    debugHtml += `<span style="color: var(--ios-red);">NO SESSION HISTORY!</span><br>`;
                    debugHtml += `<br><strong style="color: var(--ios-yellow);">Troubleshooting:</strong><br>`;
                    debugHtml += `1. Close this page<br>`;
                    debugHtml += `2. Open PT Tracker<br>`;
                    debugHtml += `3. Scroll down and tap Coverage button<br>`;
                }
                debugHtml += `</div>`;

                // Roles info
                const roleExerciseIds = Object.keys(rolesData.exercise_roles || {});
                debugHtml += `<div style="margin-bottom: 8px;">`;
                debugHtml += `<strong>Exercises with roles:</strong> ${roleExerciseIds.length}<br>`;
                debugHtml += `<strong>Sample IDs:</strong><br>`;
                roleExerciseIds.slice(0, 5).forEach(id => {
                    debugHtml += `&nbsp;&nbsp;${id}<br>`;
                });
                debugHtml += `</div>`;

                // Check for matches
                if (sessionHistory.length > 0 && roleExerciseIds.length > 0) {
                    const sessionIds = new Set(sessionHistory.map(s => s.exerciseId));
                    const matches = roleExerciseIds.filter(id => sessionIds.has(id));
                    debugHtml += `<div style="color: ${matches.length > 0 ? 'var(--ios-green)' : 'var(--ios-red)'};">`;
                    debugHtml += `<strong>Matching IDs:</strong> ${matches.length}<br>`;
                    if (matches.length > 0) {
                        debugHtml += `<strong>Matches:</strong><br>`;
                        matches.slice(0, 3).forEach(id => {
                            const sessions = sessionHistory.filter(s => s.exerciseId === id);
                            debugHtml += `&nbsp;&nbsp;${rolesData.exercise_roles[id].name} (${sessions.length} sessions)<br>`;
                        });
                    }
                    debugHtml += `</div>`;
                }

                document.getElementById('debug-content').innerHTML = debugHtml;
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // Menu functions
        function toggleMenu() {
            const overlay = document.getElementById('menu-overlay');
            const menu = document.getElementById('slide-menu');
            overlay.classList.toggle('active');
            menu.classList.toggle('active');
        }

        // Export all data (3 separate files: roles + schema + vocab)
        function exportAllData() {
            const dateStr = new Date().toISOString().split('T')[0];

            // Helper to download a file
            function downloadJSON(data, filename) {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // Export each file separately
            downloadJSON(rolesData, `exercise_roles-${dateStr}.json`);

            setTimeout(() => {
                downloadJSON(schema, `exercise_roles.schema-${dateStr}.json`);
            }, 300);

            setTimeout(() => {
                downloadJSON(vocabulary, `exercise_roles_vocabulary-${dateStr}.json`);
            }, 600);

            toggleMenu();
            alert('Exported 3 files! Upload to GitHub:\n1. exercise_roles.json\n2. exercise_roles.schema.json\n3. exercise_roles_vocabulary.json');
        }

        // Import data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);

                        // Validate structure
                        if (!imported.exercise_roles || !imported.schema || !imported.vocabulary) {
                            alert('Invalid import file: missing required sections');
                            return;
                        }

                        // Update in-memory data
                        rolesData = imported.exercise_roles;
                        schema = imported.schema;
                        vocabulary = imported.vocabulary;

                        // Re-derive enums
                        deriveEnums();

                        // Re-render
                        renderCoverageView();

                        toggleMenu();
                        alert('Data imported successfully! Reload to see changes.');
                    } catch (err) {
                        alert('Error importing file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Roles editor
        let currentEditExerciseId = null;

        function openRolesEditor() {
            toggleMenu();

            // Build exercise list
            let html = '<div class="form-group">';
            html += '<label class="form-label">Select Exercise</label>';
            html += '<select class="form-select" id="exercise-selector" onchange="selectExerciseToEdit(this.value)">';
            html += '<option value="">-- Choose an exercise --</option>';

            // Add exercises from library
            exerciseLibrary.forEach(ex => {
                const hasRoles = rolesData.exercise_roles[ex.id];
                const label = `${ex.title || ex.name}${hasRoles ? ' ‚úì' : ''}`;
                html += `<option value="${ex.id}">${label}</option>`;
            });

            html += '</select></div>';
            html += '<div id="roles-container"></div>';

            document.getElementById('editor-body').innerHTML = html;
            document.getElementById('roles-editor').classList.add('active');
        }

        function closeRolesEditor() {
            document.getElementById('roles-editor').classList.remove('active');
            currentEditExerciseId = null;
        }

        function selectExerciseToEdit(exerciseId) {
            if (!exerciseId) {
                document.getElementById('roles-container').innerHTML = '';
                return;
            }

            currentEditExerciseId = exerciseId;
            const exercise = exerciseLibrary.find(e => e.id === exerciseId);
            const rolesForExercise = rolesData.exercise_roles[exerciseId];

            let html = `<h3 style="margin: 20px 0 12px; font-size: 16px;">${exercise.title || exercise.name}</h3>`;

            // Show existing roles
            if (rolesForExercise && rolesForExercise.roles && rolesForExercise.roles.length > 0) {
                html += '<div style="margin-bottom: 16px;">';
                html += '<div class="form-label">Current Roles</div>';
                rolesForExercise.roles.forEach((role, idx) => {
                    html += `
                        <div class="role-item">
                            <div class="role-details">
                                <div><strong>${role.region}</strong> ‚Üí ${role.capacity}</div>
                                <div class="role-meta">
                                    ${role.focus ? 'Focus: ' + role.focus + ' ‚Ä¢ ' : ''}
                                    Contribution: ${role.contribution}
                                </div>
                            </div>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteRole(${idx})">Delete</button>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Add new role form
            html += '<div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color);">';
            html += '<div class="form-label">Add New Role</div>';

            html += '<div class="form-group">';
            html += '<label class="form-label">Region</label>';
            html += '<select class="form-select" id="new-region">';
            html += '<option value="">-- Select --</option>';
            regions.forEach(r => {
                html += `<option value="${r}">${r}</option>`;
            });
            html += '</select></div>';

            html += '<div class="form-group">';
            html += '<label class="form-label">Capacity</label>';
            html += '<select class="form-select" id="new-capacity">';
            html += '<option value="">-- Select --</option>';
            capacities.forEach(c => {
                html += `<option value="${c}">${c}</option>`;
            });
            html += '</select></div>';

            html += '<div class="form-group">';
            html += '<label class="form-label">Focus (optional)</label>';
            html += '<input type="text" class="form-input" id="new-focus" placeholder="e.g., sagittal, lateral, anti_rotation">';
            html += '</div>';

            html += '<div class="form-group">';
            html += '<label class="form-label">Contribution</label>';
            html += '<select class="form-select" id="new-contribution">';
            html += '<option value="">-- Select --</option>';
            contributions.forEach(c => {
                html += `<option value="${c}">${c}</option>`;
            });
            html += '</select></div>';

            html += '<button class="btn btn-primary" style="width: 100%;" onclick="addRole()">Add Role</button>';
            html += '</div>';

            document.getElementById('roles-container').innerHTML = html;
        }

        function addRole() {
            const region = document.getElementById('new-region').value;
            const capacity = document.getElementById('new-capacity').value;
            const focus = document.getElementById('new-focus').value.trim();
            const contribution = document.getElementById('new-contribution').value;

            if (!region || !capacity || !contribution) {
                alert('Please fill in region, capacity, and contribution');
                return;
            }

            const newRole = {
                region,
                capacity,
                contribution
            };

            if (focus) {
                newRole.focus = focus;
            }

            // Initialize exercise in rolesData if it doesn't exist
            if (!rolesData.exercise_roles[currentEditExerciseId]) {
                const exercise = exerciseLibrary.find(e => e.id === currentEditExerciseId);
                rolesData.exercise_roles[currentEditExerciseId] = {
                    name: exercise.title || exercise.name,
                    roles: []
                };
            }

            // Add the role
            rolesData.exercise_roles[currentEditExerciseId].roles.push(newRole);

            // Refresh the view
            selectExerciseToEdit(currentEditExerciseId);
            alert('Role added! Remember to export when done.');
        }

        function deleteRole(roleIndex) {
            if (!confirm('Delete this role?')) return;

            rolesData.exercise_roles[currentEditExerciseId].roles.splice(roleIndex, 1);

            // If no roles left, remove the exercise entirely
            if (rolesData.exercise_roles[currentEditExerciseId].roles.length === 0) {
                delete rolesData.exercise_roles[currentEditExerciseId];
            }

            // Refresh the view
            selectExerciseToEdit(currentEditExerciseId);
            alert('Role deleted! Remember to export when done.');
        }

        // Go back to PT Tracker
        function goBack() {
            window.location.href = 'pt_tracker.html';
        }

        // Start app
        init();
    </script>
</body>
</html>
