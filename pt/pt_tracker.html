<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PT Tracker">
    <link rel="manifest" href="manifest-pt.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23007AFF' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üí™</text></svg>">
    <meta name="theme-color" content="#007AFF" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <title>PT Exercise Tracker</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-orange: #FF9500;
            --ios-gray: #8E8E93;
            --ios-background: #F2F2F7;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F2F2F7;
            --text-primary: #000000;
            --text-secondary: #3a3a3c;
            --border-color: rgba(0,0,0,0.1);
            --modal-bg: #FFFFFF;
            --input-bg: #FFFFFF;
            --shadow: rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --ios-background: #000000;
                --bg-primary: #1c1c1e;
                --bg-secondary: #2c2c2e;
                --text-primary: #FFFFFF;
                --text-secondary: #98989d;
                --border-color: rgba(255,255,255,0.15);
                --modal-bg: #1c1c1e;
                --input-bg: #2c2c2e;
                --shadow: rgba(0,0,0,0.5);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--ios-background);
            color: var(--text-primary);
            touch-action: manipulation;
            user-select: none;
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            padding: 15px;
            box-shadow: 0 2px 8px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 20px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .exercise-name {
            font-size: 17px;
            color: var(--ios-blue);
            font-weight: 600;
        }

        /* Main Counter View */
        .counter-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 250px);
            padding: 20px;
        }

        .set-info {
            font-size: 17px;
            color: var(--ios-gray);
            margin-bottom: 20px;
        }

        .counter-display {
            width: min(320px, 85vw);
            height: min(320px, 85vw);
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 72px;
            font-weight: 700;
            color: var(--ios-blue);
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            margin-bottom: 30px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .counter-display:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.2);
        }

        .timer-display {
            font-size: 64px;
            font-weight: 700;
            color: var(--ios-blue);
            margin-bottom: 20px;
        }

        .timer-display.warning {
            color: var(--ios-orange);
        }

        .timer-display.danger {
            color: var(--ios-red);
        }

        .target-info {
            font-size: 17px;
            color: var(--ios-gray);
            margin-bottom: 30px;
        }

        .remaining-info {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 12px;
        }

        .progress-bar-container {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--ios-blue), var(--ios-green));
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 400px;
            padding: 0 20px;
        }

        .control-btn {
            flex: 1;
            padding: 10px 12px;
            font-size: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        .control-btn:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--ios-blue);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--ios-blue);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .btn-success {
            background: var(--ios-green);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .btn-danger {
            background: var(--ios-red);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--modal-bg);
            backdrop-filter: blur(20px);
            padding: 12px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 12px;
            z-index: 999;
        }

        .footer button {
            flex: 1;
            padding: 12px;
            font-size: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
        }

        .footer button:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        /* iOS Bottom Sheet Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .modal.active {
            display: block;
            opacity: 1;
        }

        .modal-content {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--modal-bg);
            border-radius: 20px 20px 0 0;
            padding: 0;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -2px 20px var(--shadow);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-drag-handle {
            width: 36px;
            height: 5px;
            background: var(--border-color);
            border-radius: 3px;
            margin: 12px auto 8px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            padding: 8px 20px 16px;
            color: #000;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
        }

        .modal-form {
            padding: 20px;
        }

        .modal-input, .modal-select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            margin-bottom: 12px;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px var(--shadow);
        }

        .modal-input:focus, .modal-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--ios-blue);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            padding: 0 20px 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
        }

        .modal-buttons button:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .modal-save {
            background: var(--ios-blue);
            color: white;
        }

        .modal-cancel {
            background: var(--bg-primary);
            color: var(--ios-blue);
            box-shadow: 0 1px 3px var(--shadow);
        }

        /* iOS Action Sheet */
        .action-sheet-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .action-sheet-backdrop.active {
            display: block;
            opacity: 1;
        }

        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: transparent;
            z-index: 3001;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px;
        }

        .action-sheet.active {
            transform: translateY(0);
        }

        .action-sheet-content {
            background: var(--modal-bg);
            backdrop-filter: blur(20px);
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .action-sheet-message {
            padding: 20px;
            text-align: center;
            color: var(--ios-gray);
            font-size: 13px;
            border-bottom: 0.5px solid var(--border-color);
        }

        .action-sheet-button {
            width: 100%;
            padding: 16px;
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            border-bottom: 0.5px solid var(--border-color);
            color: var(--ios-blue);
            transition: background 0.2s;
        }

        .action-sheet-button:last-child {
            border-bottom: none;
        }

        .action-sheet-button:active {
            background: rgba(0, 0, 0, 0.05);
        }

        .action-sheet-button.destructive {
            color: var(--ios-red);
            font-weight: 600;
        }

        .action-sheet-cancel {
            background: var(--modal-bg);
            backdrop-filter: blur(20px);
            border-radius: 14px;
            width: 100%;
            padding: 16px;
            border: none;
            font-size: 20px;
            font-weight: 600;
            color: var(--ios-blue);
            cursor: pointer;
            transition: background 0.2s;
        }

        .action-sheet-cancel:active {
            background: rgba(0, 0, 0, 0.05);
        }

        .history-section {
            margin-bottom: 16px;
        }

        .history-heading {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .history-list {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            padding: 12px;
        }

        .history-item {
            padding: 10px 8px;
            border-bottom: 0.5px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-meta {
            font-size: 12px;
            color: var(--ios-gray);
            margin-top: 4px;
        }

        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(0, 122, 255, 0.1);
            color: var(--ios-blue);
            margin-right: 6px;
        }

        .pocket-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 4000;
        }

        .pocket-overlay.active {
            display: flex;
        }

        .pocket-pad {
            width: min(420px, 95vw);
            height: min(500px, 80vh);
            border-radius: 28px;
            background: var(--bg-primary);
            color: var(--ios-blue);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 56px;
            font-weight: 800;
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
            text-align: center;
            padding: 20px;
        }

        .pocket-meta {
            color: #3a3a3c;
            font-size: 16px;
            font-weight: 600;
        }

        .pocket-close {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(0,0,0,0.75);
            color: white;
            border: none;
            border-radius: 22px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4001;
        }

        .hidden {
            display: none !important;
        }

        /* Body Heatmap */
        .body-diagram {
            position: relative;
            width: 200px;
            height: 380px;
            margin: 20px auto;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 380"><ellipse cx="100" cy="40" rx="25" ry="30" fill="%23e0e0e0"/><rect x="75" y="65" width="50" height="80" rx="10" fill="%23e0e0e0"/><rect x="45" y="70" width="30" height="60" rx="8" fill="%23e0e0e0"/><rect x="125" y="70" width="30" height="60" rx="8" fill="%23e0e0e0"/><rect x="70" y="145" width="60" height="40" rx="8" fill="%23e0e0e0"/><rect x="65" y="185" width="30" height="90" rx="8" fill="%23e0e0e0"/><rect x="105" y="185" width="30" height="90" rx="8" fill="%23e0e0e0"/><rect x="60" y="275" width="35" height="100" rx="8" fill="%23e0e0e0"/><rect x="105" y="275" width="35" height="100" rx="8" fill="%23e0e0e0"/></svg>') no-repeat center;
            background-size: contain;
        }

        .body-part-overlay {
            position: absolute;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .heat-none { background: rgba(142, 142, 147, 0.2); }
        .heat-low { background: rgba(0, 122, 255, 0.4); }
        .heat-medium { background: rgba(255, 149, 0, 0.5); }
        .heat-high { background: rgba(255, 59, 48, 0.6); }
        .heat-very-high { background: rgba(255, 59, 48, 0.8); }

        .body-part-overlay:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
            <h1 style="margin: 0;">üí™ PT Exercise Tracker</h1>
            <div id="streak-display" style="font-size: 14px; font-weight: 600; color: var(--ios-orange);"></div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div class="exercise-name" id="exercise-name" onclick="showQuickSwitcher()" style="cursor: pointer;">Goblet Squat ‚ñæ</div>
            <div style="display: flex; gap: 4px;">
                <button onclick="showWeeklyStats()" style="background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 4px 8px;">üìä</button>
                <button onclick="showExerciseDetailsModal()" style="background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 4px 8px;">üìã</button>
                <button onclick="showSettings()" style="background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 4px 8px;">‚öôÔ∏è</button>
            </div>
        </div>
    </div>

    <!-- Quick Start Shortcuts -->
    <div id="quick-start-container" style="padding: 12px 15px; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); display: none;">
        <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">Quick Start</div>
        <div id="quick-start-exercises" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
    </div>

    <!-- Session Plan -->
    <div id="session-plan-container" style="padding: 12px 15px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">Today's Session</div>
            <button onclick="endSessionEarly()" style="background: transparent; border: none; color: var(--ios-red); font-size: 12px; font-weight: 600; cursor: pointer; padding: 4px 8px;">End Session</button>
        </div>
        <div id="session-plan-list" style="display: flex; flex-direction: column; gap: 6px;"></div>
    </div>

    <!-- Counter View -->
    <div class="counter-view" id="counter-view">
        <div class="set-info" id="set-info">Set 1 of 3</div>
        <div class="remaining-info" id="remaining-info">Reps left: 10 ¬∑ Sets left: 3</div>

        <!-- Counter Mode -->
        <div id="counter-mode">
            <div class="counter-display" id="counter-display" onclick="incrementCounter()" aria-live="assertive">0</div>
            <div class="target-info" id="target-info">Target: 10 reps</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>

        <!-- Timer Mode -->
        <div id="timer-mode" class="hidden">
            <div class="target-info" id="timer-rep-info">Rep 1 of 10</div>
            <div class="timer-display" id="timer-display">00:00</div>
            <div class="target-info" id="timer-target">Target: 10 seconds</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="timer-progress-bar"></div>
            </div>
            <div class="controls" style="margin-bottom: 20px;">
                <button class="control-btn btn-primary" id="timer-start-btn" onclick="startTimer()">Start Timer</button>
                <button class="control-btn btn-danger hidden" id="timer-stop-btn" onclick="stopTimer()">Pause</button>
                <button class="control-btn btn-secondary hidden" id="timer-reset-btn" onclick="resetTimer()">Reset</button>
            </div>
            <!-- Log partial rep (only shown when paused) -->
            <div class="controls" id="timer-log-controls" style="margin-bottom: 10px; display: none;">
                <button class="control-btn btn-warning" onclick="logPartialTimerRep()" style="font-size: 13px; padding: 8px;">‚è±Ô∏è Log This Time & Next Rep</button>
            </div>
        </div>

        <div class="controls" id="main-controls">
            <button class="control-btn btn-secondary" onclick="previousSet()">Previous</button>
            <button class="control-btn btn-primary" onclick="showLogSetModal()">Log Set</button>
            <button class="control-btn btn-success" onclick="completeSet()">Complete Set</button>
        </div>
    </div>

    <div class="footer">
        <button class="btn-primary" onclick="showExerciseList()">Exercises</button>
        <button class="btn-secondary" onclick="showHistory()">History</button>
        <button class="btn-secondary" onclick="showBodyHeatmap()" style="font-size: 15px;">üî• Body</button>
        <button class="btn-success" onclick="togglePocketMode(true)">Pocket Tap</button>
    </div>

    <!-- Exercise Selection Modal -->
    <div class="modal" id="exercise-modal" onclick="if(event.target === this) closeExerciseModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Select Exercise</div>
            <div class="modal-form">
                <select class="modal-select" id="exercise-select" onchange="updateExerciseType()">
                    <option value="goblet_squat">Goblet Squat</option>
                    <option value="plank">Plank Hold</option>
                    <option value="step_ups">Step Ups</option>
                    <option value="clamshells">Clamshells</option>
                    <option value="bridge_hold">Bridge Hold</option>
                    <option value="pushup_amrap">Push-up AMRAP</option>
                    <option value="walk_distance">Walk (Distance)</option>
                </select>
                <select class="modal-select" id="exercise-type" onchange="updateTargetLabel()">
                    <option value="reps">Rep-based</option>
                    <option value="timed">Timed Reps</option>
                    <option value="hold">Hold</option>
                    <option value="duration">Duration</option>
                    <option value="amrap">AMRAP</option>
                    <option value="distance">Distance</option>
                </select>
                <input type="number" class="modal-input" id="sets-input" placeholder="Number of sets" value="3">
                <input type="number" class="modal-input" id="reps-input" placeholder="Reps per set" value="10">
                <input type="number" class="modal-input" id="target-input" placeholder="Target (seconds or distance)" value="10">
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeExerciseModal()">Cancel</button>
                <button class="modal-save" onclick="saveExercise()">Start</button>
            </div>
        </div>
    </div>

    <!-- Exercise List Modal -->
    <div class="modal" id="exercise-list-modal" onclick="if(event.target === this) closeExerciseList()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">My Exercises</div>
            <div class="modal-form">
                <input type="text" class="modal-input" id="exercise-search" placeholder="Search exercises..." oninput="filterExercises()">
                <div id="tag-filter-container" style="margin-bottom: 12px;"></div>
                <div id="recent-exercises-container" style="margin-bottom: 12px;"></div>
                <div class="history-list" id="exercise-list-content"></div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="control-btn btn-success" onclick="showAddExerciseModal()" style="flex: 1;">+ Add New</button>
                    <button class="control-btn btn-primary" onclick="showLibraryBrowser()" style="flex: 1;">üìö Browse Library</button>
                    <button class="control-btn btn-secondary" onclick="showArchivedExercises()" style="flex: 1;" id="archived-btn">üì¶ Archived</button>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="control-btn btn-primary" onclick="showPlanSessionModal()" style="flex: 1;">üìÖ Plan Session</button>
                    <button class="control-btn btn-secondary" onclick="showDataBackup()" style="flex: 1;">üíæ Data / Backup</button>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="control-btn btn-secondary" onclick="archiveExamples()" style="flex: 1;" id="archive-examples-btn">üóëÔ∏è Archive Examples</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Exercise Modal -->
    <div class="modal" id="add-exercise-modal" onclick="if(event.target === this) closeAddExerciseModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title" id="add-exercise-title">Add Exercise</div>
            <div class="modal-form">
                <input type="text" class="modal-input" id="new-exercise-name" placeholder="Exercise name">
                <select class="modal-select" id="new-exercise-type">
                    <option value="reps">Rep-based</option>
                    <option value="timed">Timed Reps</option>
                    <option value="hold">Hold</option>
                    <option value="duration">Duration</option>
                    <option value="amrap">AMRAP</option>
                    <option value="distance">Distance</option>
                </select>
                <input type="number" class="modal-input" id="new-sets" placeholder="Sets (e.g., 3)" value="3">
                <input type="number" class="modal-input" id="new-reps" placeholder="Reps per set (e.g., 10)" value="10">
                <input type="number" class="modal-input" id="new-seconds" placeholder="Seconds (for timed)" value="">
                <div id="tag-selector-container" style="margin: 12px 0;"></div>

                <!-- ATLAS Features -->
                <div style="background: rgba(0,122,255,0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: var(--ios-blue);">
                        üîÑ Side Tracking
                    </div>
                    <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 12px;">
                        <strong>Check bilateral</strong> if both sides work together (squats, wall sits)<br>
                        <strong>Select left/right</strong> if sides work separately (clams, single leg raises)
                    </div>
                    <label style="display: flex; align-items: center; font-size: 15px; cursor: pointer; background: var(--bg-primary); padding: 8px; border-radius: 6px;">
                        <input type="checkbox" id="bilateral-checkbox" style="margin-right: 8px;">
                        <span>‚úì Bilateral (both sides work together)</span>
                    </label>
                    <div id="side-options-container" style="margin-top: 12px;"></div>
                </div>

                <!-- Supersedes Section -->
                <div style="background: rgba(0,122,255,0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: var(--ios-blue);">
                        üîÑ Supersedes (Replaces Previous Exercises)
                    </div>
                    <div style="font-size: 12px; color: var(--ios-gray); margin-bottom: 8px;">
                        Select exercises that this new/updated version replaces
                    </div>
                    <div id="supersedes-selector-container"></div>
                </div>

                <!-- ATLAS: Muscles & Regions -->
                <textarea class="modal-input" id="primary-muscles" placeholder="Primary muscles (e.g., quadriceps, gluteus maximus)" style="min-height: 50px; resize: vertical;"></textarea>
                <textarea class="modal-input" id="anatomic-regions" placeholder="Anatomic regions (e.g., knee, hip, lower back)" style="min-height: 50px; resize: vertical;"></textarea>

                <!-- Equipment & Modifiers -->
                <select class="modal-select" id="equipment-select" multiple style="min-height: 80px;">
                    <option value="none">No equipment</option>
                    <option value="band">Resistance band</option>
                    <option value="weights">Weights/dumbbells</option>
                    <option value="ball">Exercise ball</option>
                    <option value="step">Step/platform</option>
                    <option value="wall">Wall</option>
                    <option value="chair">Chair</option>
                    <option value="foam_roller">Foam roller</option>
                    <option value="mat">Mat</option>
                </select>
                <div style="font-size: 12px; color: var(--ios-gray); margin-top: 4px; margin-bottom: 8px;">Hold Ctrl/Cmd to select multiple</div>

                <select class="modal-select" id="difficulty-select">
                    <option value="">Difficulty (optional)</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeAddExerciseModal()">Cancel</button>
                <button class="modal-save" onclick="saveNewExercise()">Save</button>
            </div>
        </div>
    </div>

    <!-- Session Notes Modal -->
    <div class="modal" id="session-notes-modal" onclick="if(event.target === this) closeSessionNotesModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Session Notes (Optional)</div>
            <div class="modal-form">
                <textarea class="modal-input" id="session-notes" placeholder="How did it feel? Any pain? Progress notes..." style="min-height: 100px; resize: vertical;"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="saveSessionWithNotes('')">Skip</button>
                <button class="modal-save" onclick="saveSessionWithNotes(document.getElementById('session-notes').value)">Save</button>
            </div>
        </div>
    </div>

    <!-- Log Set Modal -->
    <div class="modal" id="log-set-modal" onclick="if(event.target === this) closeLogSetModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title" id="log-set-title">Log Set</div>
            <div class="modal-form">
                <div style="font-size: 15px; color: var(--ios-gray); margin-bottom: 12px; text-align: center;" id="log-set-subtitle">
                    Enter actual reps performed
                </div>
                <input type="number" class="modal-input" id="log-set-reps" placeholder="Reps performed" min="0">
                <div id="log-set-side-selector" style="margin: 12px 0;"></div>

                <!-- Weight/Resistance Tracking (Optional) -->
                <div style="background: rgba(0,122,255,0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px;">Optional Tracking:</div>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="number" class="modal-input" id="log-set-weight" placeholder="Weight (lbs)" min="0" step="0.5" style="flex: 1; margin: 0;">
                        <select class="modal-select" id="log-set-weight-unit" style="flex: 0 0 auto; width: 80px; margin: 0;">
                            <option value="lbs">lbs</option>
                            <option value="kg">kg</option>
                        </select>
                    </div>
                    <select class="modal-select" id="log-set-resistance" style="margin: 0;">
                        <option value="">Resistance Band (optional)</option>
                        <option value="light">Light</option>
                        <option value="medium">Medium</option>
                        <option value="heavy">Heavy</option>
                        <option value="extra-heavy">Extra Heavy</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeLogSetModal()">Cancel</button>
                <button class="modal-save" onclick="saveLoggedSet()">Save</button>
            </div>
        </div>
    </div>

    <!-- Exercise Details Modal -->
    <div class="modal" id="exercise-details-modal" onclick="if(event.target === this) closeExerciseDetailsModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title" id="exercise-details-title">Exercise Details</div>
            <div class="modal-form" style="max-height: 500px; overflow-y: auto;">
                <!-- Professional Guidance Section (for imported exercises) -->
                <div id="professional-guidance-section" style="display: none; margin-bottom: 16px;">
                    <div style="background: rgba(0,122,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px; color: var(--ios-blue);">
                            üìö Professional Guidance
                        </div>
                        <div id="professional-guidance-content"></div>
                    </div>
                    <hr style="border: none; border-top: 1px solid rgba(0,0,0,0.1); margin: 16px 0;">
                </div>

                <!-- User's Personal Notes -->
                <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 8px;">Your Personal Notes:</div>
                <textarea class="modal-input" id="exercise-description" placeholder="Description (what is this exercise?)" style="min-height: 60px; resize: vertical;"></textarea>
                <textarea class="modal-input" id="exercise-tips" placeholder="Execution tips (form, alignment, cues)" style="min-height: 80px; resize: vertical;"></textarea>
                <textarea class="modal-input" id="exercise-feel" placeholder="Where to feel (target muscles)" style="min-height: 50px; resize: vertical;"></textarea>
                <textarea class="modal-input" id="exercise-not-feel" placeholder="Where NOT to feel (avoid strain)" style="min-height: 50px; resize: vertical;"></textarea>
                <textarea class="modal-input" id="exercise-modifications" placeholder="Modifications (easier/harder variations)" style="min-height: 60px; resize: vertical;"></textarea>
                <input type="number" class="modal-input" id="exercise-rest-seconds" placeholder="Rest between sets (seconds, optional)" min="0">
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeExerciseDetailsModal()">Cancel</button>
                <button class="modal-save" onclick="saveExerciseDetails()">Save</button>
            </div>
        </div>
    </div>

    <!-- Rest Timer Modal -->
    <div class="modal" id="rest-timer-modal">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Rest Timer</div>
            <div class="modal-form">
                <div style="text-align: center; font-size: 48px; font-weight: 700; color: var(--ios-blue); margin: 20px 0;" id="rest-countdown">60</div>
                <div style="text-align: center; font-size: 15px; color: var(--ios-gray); margin-bottom: 20px;">Rest between sets</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="rest-progress-bar"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="skipRest()">Skip Rest</button>
                <button class="modal-save" onclick="closeRestTimer()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Quick Exercise Switcher Modal -->
    <div class="modal" id="quick-switcher-modal" onclick="if(event.target === this) closeQuickSwitcher()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Switch Exercise</div>
            <div class="modal-form">
                <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 12px; text-align: center;">Tap to switch (current progress will be saved)</div>
                <div class="history-list" id="quick-switcher-list"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="history-modal" onclick="if(event.target === this) closeHistoryModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">History</div>
            <div class="modal-form">
                <div class="history-section">
                    <div class="history-heading">Exercise revisions</div>
                    <div class="history-list" id="exercise-history-list"></div>
                </div>
                <div class="history-section">
                    <div class="history-heading">Recent sessions</div>
                    <div class="history-list" id="session-history-list"></div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="control-btn btn-secondary" onclick="exportWeeklySummary()" style="flex: 1;">üìä Weekly Summary</button>
                    <button class="control-btn btn-primary" onclick="exportForPT()" style="flex: 1;">Full Report</button>
                    <button class="control-btn btn-secondary" onclick="reloadApp()" style="flex: 1;">Reload app (use after updates)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Body Heatmap Modal -->
    <div class="modal" id="body-heatmap-modal" onclick="if(event.target === this) closeBodyHeatmap()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Body Parts Worked (Last 7 Days)</div>
            <div class="modal-form">
                <div style="font-size: 13px; color: var(--ios-gray); text-align: center; margin-bottom: 12px;">
                    Tap body parts to see exercises
                </div>
                <div class="body-diagram" id="body-diagram"></div>
                <div class="heatmap-legend">
                    <div class="legend-item">
                        <div class="legend-color heat-none"></div>
                        <span>None</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color heat-low"></div>
                        <span>1-2√ó</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color heat-medium"></div>
                        <span>3-4√ó</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color heat-high"></div>
                        <span>5+√ó</span>
                    </div>
                </div>
                <div id="body-part-details" style="margin-top: 12px;"></div>
            </div>
        </div>
    </div>

    <!-- All Sessions Modal (grouped by workout session) -->
    <div class="modal" id="all-sessions-modal" onclick="if(event.target === this) closeAllSessions()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Complete Workout Sessions</div>
            <div class="modal-form" style="max-height: 500px; overflow-y: auto;">
                <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 12px; text-align: center;">
                    All exercises grouped by workout session
                </div>
                <div id="all-sessions-list"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeAllSessions()">Close</button>
            </div>
        </div>
    </div>

    <!-- Weekly Stats Modal -->
    <div class="modal" id="weekly-stats-modal" onclick="if(event.target === this) closeWeeklyStats()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Weekly Stats</div>
            <div class="modal-form" style="max-height: 500px; overflow-y: auto;">
                <div id="weekly-overview"></div>
                <div id="weekly-volume-chart"></div>
                <div id="weekly-exercises"></div>
                <div id="weekly-adherence"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeWeeklyStats()">Close</button>
                <button class="modal-save" onclick="showAllSessions()">View All Sessions</button>
            </div>
        </div>
    </div>

    <!-- Exercise Progress Modal -->
    <div class="modal" id="exercise-progress-modal" onclick="if(event.target === this) closeExerciseProgress()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title" id="progress-modal-title">Exercise Progress</div>
            <div class="modal-form" style="max-height: 500px; overflow-y: auto;">
                <div id="progress-summary" style="margin-bottom: 16px;"></div>
                <div id="progress-chart" style="margin-bottom: 16px;"></div>
                <div id="progress-sessions" style="margin-bottom: 16px;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeExerciseProgress()">Close</button>
            </div>
        </div>
    </div>

    <!-- Exercise Library Browser Modal -->
    <div class="modal" id="library-browser-modal" onclick="if(event.target === this) closeLibraryBrowser()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Exercise Library</div>
            <div class="modal-form">
                <div style="font-size: 13px; color: var(--ios-gray); text-align: center; margin-bottom: 12px;">
                    Professional PT exercises with detailed guidance
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 8px 12px; background: rgba(0,122,255,0.05); border-radius: 8px;">
                    <label style="font-size: 14px; font-weight: 500; cursor: pointer;" for="show-new-toggle">
                        Show only new
                    </label>
                    <input type="checkbox" id="show-new-toggle" checked onchange="toggleShowOnlyNew()" style="width: 20px; height: 20px; cursor: pointer;">
                </div>
                <input type="text" class="modal-input" id="library-search" placeholder="Search exercises..." oninput="filterLibraryExercises()">
                <div class="history-list" id="library-exercises-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeLibraryBrowser()">Close</button>
                <button class="modal-save" id="bulk-import-btn" onclick="bulkImportExercises()" style="display: none;">Import Selected</button>
            </div>
        </div>
    </div>

    <!-- Exercise Detail View Modal -->
    <div class="modal" id="exercise-detail-modal" onclick="if(event.target === this) closeExerciseDetail()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title" id="exercise-detail-title">Exercise Details</div>
            <div class="modal-form">
                <div id="exercise-detail-content" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeExerciseDetail()">Back</button>
                <button class="modal-save" id="import-exercise-btn" onclick="importSeedExercise()">Import to My Exercises</button>
            </div>
        </div>
    </div>

    <!-- Data / Backup Modal -->
    <div class="modal" id="data-backup-modal" onclick="if(event.target === this) closeDataBackup()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Data / Backup</div>
            <div class="modal-form">
                <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 16px;">Export your data to save a backup or commit to GitHub.</div>
                <button class="control-btn btn-primary" onclick="exportAllData()" style="width: 100%; margin-bottom: 12px; font-weight: 600;">üíæ Export All Data</button>
                <div style="font-size: 12px; color: var(--ios-gray); margin: -8px 0 16px 0; text-align: center;">Single file with library, history, and version</div>
                <button class="control-btn btn-secondary" onclick="exportExerciseLibrary()" style="width: 100%; margin-bottom: 12px;">üìö Export Exercise Library</button>
                <button class="control-btn btn-secondary" onclick="exportExerciseHistory()" style="width: 100%; margin-bottom: 20px;">üìä Export Exercise History</button>

                <div style="border-top: 1px solid var(--ios-separator); padding-top: 16px; margin-top: 4px;">
                    <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 12px;">Restore from backup file</div>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                    <button class="control-btn btn-secondary" onclick="document.getElementById('import-file-input').click()" style="width: 100%; margin-bottom: 12px;">üì• Import Data</button>
                </div>

                <div style="border-top: 1px solid var(--ios-separator); padding-top: 16px; margin-top: 4px;">
                    <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 12px;">Advanced: Schema-driven exercise editor</div>
                    <button class="control-btn btn-primary" onclick="window.open('./exercise_editor.html', '_blank')" style="width: 100%;">üõ†Ô∏è Open Exercise Editor</button>
                    <div style="font-size: 11px; color: var(--ios-gray); margin-top: 8px; text-align: center;">Create/edit exercises with full schema validation</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeDataBackup()">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal" onclick="if(event.target === this) closeSettings()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">‚öôÔ∏è Settings</div>
            <div class="modal-form" style="max-height: 600px; overflow-y: auto;">

                <!-- Data & Backup Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; padding-left: 8px;">üìä DATA & BACKUP</div>
                    <div style="background: var(--bg-primary); border-radius: 12px; overflow: hidden;">
                        <button onclick="exportAllData()" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üíæ Export All Data</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Ä∫</span>
                            </div>
                            <div style="font-size: 12px; color: var(--ios-gray); margin-top: 2px;">Library + history + version</div>
                        </button>
                        <button onclick="exportExerciseLibrary()" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üìö Export Library Only</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Ä∫</span>
                            </div>
                        </button>
                        <button onclick="exportExerciseHistory()" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üìä Export History Only</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Ä∫</span>
                            </div>
                        </button>
                        <button onclick="document.getElementById('import-file-input').click()" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üì• Import Data</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Ä∫</span>
                            </div>
                            <div style="font-size: 12px; color: var(--ios-gray); margin-top: 2px;">Restore from backup</div>
                        </button>
                    </div>
                </div>

                <!-- Exercise Library Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; padding-left: 8px;">üí™ EXERCISE LIBRARY</div>
                    <div style="background: var(--bg-primary); border-radius: 12px; overflow: hidden;">
                        <button onclick="closeSettings(); showLibraryBrowser();" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üìö Browse Library</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Ä∫</span>
                            </div>
                            <div style="font-size: 12px; color: var(--ios-gray); margin-top: 2px;">Professional PT exercises</div>
                        </button>
                        <button onclick="window.open('./exercise_editor.html', '_blank')" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üõ†Ô∏è Exercise Editor</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Üó</span>
                            </div>
                            <div style="font-size: 12px; color: var(--ios-gray); margin-top: 2px;">Create custom exercises</div>
                        </button>
                    </div>
                </div>

                <!-- Tracking Preferences Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; padding-left: 8px;">üéØ TRACKING PREFERENCES</div>
                    <div style="background: var(--bg-primary); border-radius: 12px; overflow: hidden;">
                        <div style="padding: 10px 12px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 15px; color: var(--text-primary);">Haptic Feedback</div>
                                    <div style="font-size: 11px; color: var(--ios-gray); margin-top: 2px;">Vibration on actions</div>
                                </div>
                                <input type="checkbox" id="haptic-toggle" checked onchange="toggleHaptic()" style="width: 42px; height: 24px; cursor: pointer;">
                            </div>
                        </div>
                        <div style="padding: 10px 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-size: 15px; color: var(--text-primary);">Voice Announcements</div>
                                    <div style="font-size: 11px; color: var(--ios-gray); margin-top: 2px;">Speak progress updates</div>
                                </div>
                                <input type="checkbox" id="voice-toggle" checked onchange="toggleVoice()" style="width: 42px; height: 24px; cursor: pointer;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- App Management Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; padding-left: 8px;">üì± APP MANAGEMENT</div>
                    <div style="background: var(--bg-primary); border-radius: 12px; overflow: hidden;">
                        <div style="padding: 10px 12px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="font-size: 15px; color: var(--text-primary);">App Version</span>
                                <span style="color: var(--ios-gray); font-size: 13px;">v1.3.0</span>
                            </div>
                        </div>
                        <button onclick="reloadApp()" style="width: 100%; padding: 10px 12px; border: none; background: transparent; text-align: left; cursor: pointer; font-size: 15px; color: var(--text-primary);">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üîÑ Reload App</span>
                                <span style="color: var(--ios-gray); font-size: 14px;">‚Ä∫</span>
                            </div>
                            <div style="font-size: 12px; color: var(--ios-gray); margin-top: 2px;">Check for updates</div>
                        </button>
                    </div>
                </div>

                <!-- About Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 12px; padding-left: 8px;">‚ÑπÔ∏è ABOUT</div>
                    <div style="background: var(--bg-primary); border-radius: 12px; overflow: hidden;">
                        <div style="padding: 14px 16px;">
                            <div style="font-size: 14px; color: var(--ios-gray); line-height: 1.6;">
                                All data stored locally on your device. No cloud sync. Export regularly to back up your progress.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeSettings()">Close</button>
            </div>
        </div>
    </div>

    <!-- Dosage Prompt Modal -->
    <div class="modal" id="dosage-prompt-modal" onclick="if(event.target === this) closeDosagePrompt()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">üíä Set Initial Dosage</div>
            <div class="modal-form">
                <div style="font-size: 15px; color: var(--text-primary); margin-bottom: 20px; text-align: center; font-weight: 600;" id="dosage-exercise-name"></div>
                <div style="font-size: 14px; color: var(--ios-gray); margin-bottom: 24px; text-align: center;">What did your PT prescribe?</div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Sets</label>
                    <input type="number" id="dosage-sets" class="modal-input" placeholder="e.g., 3" min="1" style="font-size: 20px; text-align: center; font-weight: 600;">
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Reps (per set)</label>
                    <input type="number" id="dosage-reps" class="modal-input" placeholder="e.g., 10" min="1" style="font-size: 20px; text-align: center; font-weight: 600;">
                </div>

                <div id="dosage-seconds-container" style="margin-bottom: 16px; display: none;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Seconds (per rep)</label>
                    <input type="number" id="dosage-seconds" class="modal-input" placeholder="e.g., 30" min="1" style="font-size: 20px; text-align: center; font-weight: 600;">
                    <div style="font-size: 12px; color: var(--ios-gray); margin-top: 4px; text-align: center;">Hold exercises typically 20-30s</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeDosagePrompt()">Cancel</button>
                <button class="modal-save" onclick="confirmDosage()">Add to My Program</button>
            </div>
        </div>
    </div>

    <!-- Plan Session Modal -->
    <div class="modal" id="plan-session-modal" onclick="if(event.target === this) closePlanSessionModal()">
        <div class="modal-content">
            <div class="modal-drag-handle"></div>
            <div class="modal-title">Plan Today's Session</div>
            <div class="modal-form">
                <div style="font-size: 13px; color: var(--ios-gray); margin-bottom: 12px;">Select exercises for today's workout. Tap to add/remove.</div>
                <div id="plan-session-list" class="history-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closePlanSessionModal()">Cancel</button>
                <button class="modal-save" id="start-session-btn" onclick="startPlannedSession()">Start Session</button>
            </div>
        </div>
    </div>

    <!-- iOS Action Sheet -->
    <div class="action-sheet-backdrop" id="action-sheet-backdrop" onclick="hideActionSheet()"></div>
    <div class="action-sheet" id="action-sheet">
        <div class="action-sheet-content">
            <div class="action-sheet-message" id="action-sheet-message"></div>
            <button class="action-sheet-button destructive" id="action-sheet-confirm" onclick="confirmActionSheet()">Confirm</button>
        </div>
        <button class="action-sheet-cancel" onclick="hideActionSheet()">Cancel</button>
    </div>

    <!-- Eyes-free pocket tap overlay -->
    <div class="pocket-overlay" id="pocket-overlay" onclick="handlePocketTap()" aria-live="assertive">
        <button class="pocket-close" onclick="togglePocketMode(false); event.stopPropagation();" aria-label="Exit Pocket Mode">‚úï</button>
        <div class="pocket-pad" role="button" aria-label="Pocket tap target">
            <div id="pocket-label">Tap to count</div>
            <div class="pocket-meta" id="pocket-meta">Reps left ¬∑ Sets left</div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'pt_tracker_data';
        const LIBRARY_KEY = 'pt_exercise_library';
        const LAST_EXERCISE_KEY = 'pt_last_exercise_id';
        const PT_VERSION_KEY = 'pt_data_version';
        const PT_DATA_VERSION = '1';
        const ATLAS_REFERENCE_URL = 'https://github.com/vouser123/rukuba/tree/revert-5-claude/enable-page-code-writing-MNryw';

        /**
         * SESSION ID TRACKING
         * -------------------
         * Each history entry includes a sessionId to group exercises performed in the same workout session.
         *
         * Current strategy: Generate a random sessionId once per app load.
         * - All exercises completed before closing/refreshing the app share the same sessionId
         * - Different app launches = different sessionIds, even on the same day
         * - Format: 8-character random alphanumeric string (e.g., "a3f9k2m1")
         *
         * Future: This enables session-based UI features like:
         * - "Today's Workout" view grouping exercises by session
         * - Session history browser
         * - Session planning (which exercises in what order)
         */
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 10);
        }

        let currentSessionId = generateSessionId();

        // Session planning
        let sessionPlan = []; // Array of exercise IDs planned for today
        let sessionPlanCompleted = new Set(); // IDs of completed exercises

        function reloadApp() {
            try {
                window.location.reload();
            } catch (e) {
                console.warn('Reload failed, you can close and reopen the app manually.', e);
            }
        }

        const ATLAS_SEED = [
            {
                id: 'goblet_squat',
                name: 'Goblet Squat (Example)',
                dosage: 'S3x10 (both)',
                supersedes: ['ex_basic_squats_01'],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'plank_hold',
                name: 'Plank Hold (Example)',
                dosage: 'S3x1',
                hold_seconds: 30,
                supersedes: [],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'step_ups',
                name: 'Step Ups (Example)',
                dosage: 'S3x10 (side)',
                supersedes: ['ex_basic_squats_01'],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'clamshells',
                name: 'Clamshells (Example)',
                dosage: 'S3x15 (side)',
                supersedes: [],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'bridge_hold',
                name: 'Bridge Hold (Example)',
                dosage: 'S3x1',
                hold_seconds: 30,
                supersedes: [],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'bike_intervals',
                name: 'Bike Intervals (Example)',
                dosage: 'S4x1',
                duration_seconds: 300,
                supersedes: [],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'pushup_amrap',
                name: 'Push-up AMRAP (Example)',
                dosage: 'AMRAP',
                amrap_window_sec: 60,
                supersedes: [],
                summary: 'Example exercise - edit or delete as needed'
            },
            {
                id: 'walk_distance',
                name: 'Walk (Example)',
                dosage: 'S1x400',
                distance_meters: 400,
                supersedes: [],
                summary: 'Example exercise - edit or delete as needed'
            }
        ];

        function parseAtlasDosage(dosage = '') {
            const match = /S(\d+)x(\d+)/i.exec(dosage);
            const sets = match ? parseInt(match[1], 10) : 3;
            const repsPerSet = match ? parseInt(match[2], 10) : 10;
            const isSide = /(side)/i.test(dosage);
            const isBoth = /(both)/i.test(dosage);

            return { sets, repsPerSet, side: isSide ? 'side' : isBoth ? 'both' : null };
        }

        function atlasSeedToSpec(entry) {
            const base = parseAtlasDosage(entry.dosage || '');
            const spec = {
                type: 'reps',
                sets: entry.sets_override || base.sets || 3,
                repsPerSet: base.repsPerSet || 10,
                secondsPerRep: 0
            };

            if (entry.hold_seconds) {
                spec.type = 'hold';
                spec.repsPerSet = base.repsPerSet || 1;
                spec.secondsPerRep = entry.hold_seconds;
            } else if (entry.duration_seconds) {
                spec.type = 'duration';
                spec.repsPerSet = base.repsPerSet || 1;
                spec.secondsPerRep = entry.duration_seconds;
            } else if (entry.amrap_window_sec) {
                spec.type = 'amrap';
                spec.repsPerSet = 0;
                spec.secondsPerRep = entry.amrap_window_sec;
            } else if (entry.distance_meters) {
                spec.type = 'distance';
                spec.repsPerSet = entry.distance_meters;
                spec.secondsPerRep = 0;
            }

            return spec;
        }

        const DEFAULT_LIBRARY = ATLAS_SEED.map(entry => {
            const spec = atlasSeedToSpec(entry);
            return {
                id: entry.id,
                name: entry.name,
                supersedes: entry.supersedes || [],
                atlasUrl: ATLAS_REFERENCE_URL,
                current: spec,
                history: [
                    {
                        timestamp: new Date().toISOString(),
                        summary: entry.summary || 'Seeded from atlas_pt_min_250817.json',
                        previous: null,
                        next: spec,
                        supersedes: entry.supersedes || []
                    }
                ]
            };
        });
        let exerciseLibrary = loadExerciseLibrary();

        function getInitialExercise() {
            // Only restore last used exercise if it exists
            const lastExerciseId = localStorage.getItem(LAST_EXERCISE_KEY);
            if (lastExerciseId) {
                const lastExercise = exerciseLibrary.find(ex => ex.id === lastExerciseId && !ex.archived);
                if (lastExercise) {
                    return toSessionExercise(lastExercise);
                }
            }

            // Don't auto-select any exercise - let user choose
            return null;
        }

        let currentExercise = getInitialExercise();

        let timerInterval = null;
        let timerSecondsRemaining = currentExercise ? Math.max(currentExercise.secondsPerRep || 0, 1) : 0; // counts DOWN
        let timerRunning = false;
        let actionSheetCallback = null;
        let pocketMode = false;

        const TIMER_TYPES = ['timed', 'hold', 'duration'];
        const COUNTER_TYPES = ['reps', 'amrap', 'distance'];

        const AVAILABLE_TAGS = ['knee', 'back', 'ankle', 'hip', 'shoulder', 'core', 'arm', 'leg', 'glute', 'neck', 'wrist', 'elbow'];

        let editingExerciseId = null;
        let selectedTags = [];
        let filterTags = [];
        let selectedSideOptions = [];
        let selectedSupersedes = [];

        const SIDE_OPTIONS_AVAILABLE = ['left', 'right', 'both'];

        // Audio for timer
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Speech synthesis for voice announcements
        function speak(text) {
            if (!preferences.voiceEnabled) return;
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                speechSynthesis.speak(utterance);
            }
        }

        /**
         * FIRST-RUN DETECTION & DATA LOADING
         * -----------------------------------
         * TRUE FIRST RUN is detected when ALL of these are missing:
         *   - PT_VERSION_KEY
         *   - LIBRARY_KEY
         *   - STORAGE_KEY
         *
         * On true first run:
         *   - Seed default exercises into LIBRARY_KEY
         *   - Set PT_VERSION_KEY to prevent future reseeding
         *
         * Once PT_VERSION_KEY exists, we NEVER auto-reseed defaults.
         * This prevents data loss on PWA updates/reinstalls.
         *
         * Parse errors are handled gracefully:
         *   - Log warning to console
         *   - Return empty array (in memory only)
         *   - DO NOT overwrite stored data
         */
        function loadExerciseLibrary() {
            const version = localStorage.getItem(PT_VERSION_KEY);
            const storedLibrary = localStorage.getItem(LIBRARY_KEY);
            const storedHistory = localStorage.getItem(STORAGE_KEY);

            // True first run: no version, no library, no history
            const isFirstRun = !version && !storedLibrary && !storedHistory;

            if (isFirstRun) {
                console.log('First run detected - seeding default exercises');
                localStorage.setItem(LIBRARY_KEY, JSON.stringify(DEFAULT_LIBRARY));
                localStorage.setItem(PT_VERSION_KEY, PT_DATA_VERSION);
                return DEFAULT_LIBRARY;
            }

            // Not first run: load existing library
            if (storedLibrary) {
                try {
                    const parsed = JSON.parse(storedLibrary);
                    if (Array.isArray(parsed)) {
                        return parsed.length > 0 ? parsed : [];
                    }
                } catch (e) {
                    console.error('Failed to parse exercise library:', e);
                    console.warn('Returning empty library - stored data preserved');
                    return [];
                }
            }

            // No stored library but not first run (user deleted library)
            return [];
        }

        function persistExerciseLibrary() {
            localStorage.setItem(LIBRARY_KEY, JSON.stringify(exerciseLibrary));
        }

        // Safe history loading with error handling
        function loadHistory() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) return [];

            try {
                const parsed = JSON.parse(stored);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Failed to parse exercise history:', e);
                console.warn('Returning empty history - stored data preserved');
                return [];
            }
        }

        /**
         * DATA LOSS PREVENTION - TEST CHECKLIST
         * --------------------------------------
         * To verify the version guard prevents data loss:
         *
         * ‚úì TEST 1: True first run
         *   - Clear all localStorage (DevTools ‚Üí Application ‚Üí Clear Site Data)
         *   - Reload app
         *   - EXPECT: Default exercises seeded, PT_VERSION_KEY set to "1"
         *   - VERIFY: localStorage has pt_data_version="1", pt_exercise_library with defaults
         *
         * ‚úì TEST 2: Update with existing data
         *   - Add custom exercises, complete some workouts
         *   - Note your custom data
         *   - Reload app (simulates PWA update)
         *   - EXPECT: All custom exercises and history preserved
         *   - VERIFY: No re-seeding, PT_VERSION_KEY still "1"
         *
         * ‚úì TEST 3: Corrupted JSON
         *   - In DevTools ‚Üí Application ‚Üí localStorage, manually corrupt pt_exercise_library
         *     (e.g., change JSON to invalid syntax like `[{broken`)
         *   - Reload app
         *   - EXPECT: Console shows error "Failed to parse exercise library"
         *   - EXPECT: Console shows warning "Returning empty library - stored data preserved"
         *   - EXPECT: App shows blank exercise list (safe in-memory fallback)
         *   - VERIFY: Corrupted data still in localStorage (not overwritten)
         *   - FIX: Restore valid JSON or clear localStorage to reset
         */

        /**
         * EXERCISE OBJECT STRUCTURE
         * -------------------------
         * This app represents exercises in two forms:
         *
         * 1. Library Entry (persisted in localStorage):
         *    - id: unique identifier
         *    - name: exercise name
         *    - current: { type, sets, repsPerSet, secondsPerRep }
         *    - bilateral: true/false (both sides work together)
         *    - sideOptions: ['left', 'right'] (for sided exercises)
         *    - tags: body parts (knee, hip, etc.)
         *    - equipment: array of equipment types
         *    - guidance: { external_cues, motor_cues, compensation_warnings, safety_flags }
         *    - history: array of revisions tracking dosage changes
         *    - details: { description, executionTips, shouldFeel, shouldNotFeel, etc. }
         *    - favorite, archived: boolean flags
         *
         * 2. Session Exercise (runtime state):
         *    Converted from library entry by toSessionExercise()
         *    - All library fields PLUS:
         *    - currentSet, currentRep: live progress tracking
         *    - sessionData: array of logged sets [{set, reps, timestamp, side?, weight?, resistance?}]
         *
         * TODO: Define what a "session" is (one workout? one day? when does it end?)
         * TODO: Add program-layer integration (how exercises fit into rehab programs)
         * TODO: Schema-driven fields (lifecycle, progression parameters, etc.)
         */
        function toSessionExercise(entry) {
            const spec = entry?.current || {};
            const isBilateral = entry.bilateral === true;
            const sideOptions = entry.sideOptions || [];

            // For sided exercises, multiply sets by number of sides
            // E.g., 3 sets with ['left', 'right'] = 6 total sets (3 per side)
            const baseSets = spec.sets || 3;
            const effectiveSides = (!isBilateral && sideOptions.length > 0) ? sideOptions.length : 1;
            const totalSets = baseSets * effectiveSides;

            return {
                id: entry.id,
                name: entry.name,
                type: spec.type || 'reps',
                sets: totalSets,
                baseSets: baseSets, // Original sets per side
                sideOptions: sideOptions,
                bilateral: isBilateral,
                repsPerSet: spec.repsPerSet || 10,
                secondsPerRep: spec.secondsPerRep ?? 10,
                currentSet: 1,
                currentRep: 0,
                sessionData: [] // Populated during execution
            };
        }

        function getLibraryEntryById(id) {
            return exerciseLibrary.find(ex => ex.id === id) || exerciseLibrary[0];
        }

        function recordRevision(entry, nextSpec, reason = 'Updated dosage') {
            const previous = { ...(entry.current || {}) };
            const changes = [];

            if ((previous.sets ?? null) !== nextSpec.sets) changes.push(`sets ${previous.sets ?? '‚Äî'} ‚Üí ${nextSpec.sets}`);
            if ((previous.repsPerSet ?? null) !== nextSpec.repsPerSet) changes.push(`reps ${previous.repsPerSet ?? '‚Äî'} ‚Üí ${nextSpec.repsPerSet}`);
            if ((previous.secondsPerRep ?? null) !== nextSpec.secondsPerRep) changes.push(`seconds ${previous.secondsPerRep ?? '‚Äî'} ‚Üí ${nextSpec.secondsPerRep}`);
            if ((previous.type ?? '') !== nextSpec.type) changes.push(`type ${previous.type || 'reps'} ‚Üí ${nextSpec.type}`);

            entry.history = entry.history || [];
            entry.history.push({
                timestamp: new Date().toISOString(),
                summary: changes.length ? changes.join(', ') : reason,
                previous,
                next: nextSpec,
                supersedes: entry.supersedes || []
            });

            entry.current = nextSpec;
            persistExerciseLibrary();
        }

        function populateExerciseSelect() {
            const select = document.getElementById('exercise-select');
            const selectedValue = currentExercise?.id;
            select.innerHTML = '';

            exerciseLibrary.forEach(entry => {
                const opt = document.createElement('option');
                opt.value = entry.id;
                opt.textContent = entry.name;
                if (entry.id === selectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
        }

        function applyLibraryEntryToForm(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            const spec = entry.current || {};

            document.getElementById('exercise-type').value = spec.type || 'reps';
            document.getElementById('sets-input').value = spec.sets || 3;
            document.getElementById('reps-input').value = spec.repsPerSet || 10;
            document.getElementById('target-input').value = spec.secondsPerRep ?? 10;
            updateTargetLabel();
        }

        function playBeep(frequency = 800, duration = 200) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'square'; // More noticeable than sine

            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime); // Louder
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        function playCompletionSound() {
            // Triple beep for completion
            playBeep(1000, 150);
            setTimeout(() => playBeep(1200, 150), 200);
            setTimeout(() => playBeep(1400, 200), 400);
        }

        // Haptic feedback helper (stronger vibrations for better feedback)
        function haptic(style = 'light') {
            if (!preferences.hapticEnabled) return;
            if ('vibrate' in navigator) {
                switch(style) {
                    case 'light':
                        navigator.vibrate(30);
                        break;
                    case 'medium':
                        navigator.vibrate(50);
                        break;
                    case 'heavy':
                        navigator.vibrate(80);
                        break;
                    case 'success':
                        navigator.vibrate([30, 50, 30]);
                        break;
                    case 'error':
                        navigator.vibrate([50, 100, 50]);
                        break;
                }
            }
        }

        const isTimerType = (type) => TIMER_TYPES.includes(type);

        /**
         * POCKET MODE BEHAVIOR
         * --------------------
         * Eyes-free fullscreen overlay for use when phone is in pocket/armband.
         *
         * HOW IT WORKS:
         *
         * For REP-BASED exercises (reps, amrap, distance):
         *   - Large tap area displays current rep count
         *   - Each tap increments the counter
         *   - Audio and haptic feedback confirm each tap
         *   - When target reps reached, set auto-completes
         *
         * For TIME-BASED exercises (timed, hold, duration):
         *   - Large tap area displays countdown timer
         *   - First tap starts the timer
         *   - Second tap pauses the timer
         *   - Timer auto-advances to next rep when complete
         *   - Can log partial reps (if paused) via "Log This Time" button (not in Pocket mode)
         *
         * INTERACTION:
         *   - Tap anywhere on white pad to count/start-pause
         *   - Small X button in top-left to exit (positioned away from tap area)
         *   - All existing audio/haptic cues preserved
         *
         * TODO: Add Pocket mode support for "Log This Rep" when timer paused
         * TODO: Consider voice-only interaction mode (no screen needed)
         */
        // Pocket Mode long-press detection for timer logging
        let pocketPressTimer = null;
        let pocketLongPressTriggered = false;

        function togglePocketMode(enabled) {
            pocketMode = enabled;
            const overlay = document.getElementById('pocket-overlay');
            if (enabled) {
                overlay.classList.add('active');
                haptic('medium');
                setupPocketLongPress();
            } else {
                overlay.classList.remove('active');
                haptic('medium');
                cleanupPocketLongPress();
            }
            updatePocketOverlay();
        }

        function setupPocketLongPress() {
            const overlay = document.getElementById('pocket-overlay');
            overlay.addEventListener('touchstart', handlePocketPressStart, { passive: true });
            overlay.addEventListener('touchend', handlePocketPressEnd, { passive: true });
            overlay.addEventListener('touchcancel', handlePocketPressCancel, { passive: true });
        }

        function cleanupPocketLongPress() {
            const overlay = document.getElementById('pocket-overlay');
            overlay.removeEventListener('touchstart', handlePocketPressStart);
            overlay.removeEventListener('touchend', handlePocketPressEnd);
            overlay.removeEventListener('touchcancel', handlePocketPressCancel);
            if (pocketPressTimer) {
                clearTimeout(pocketPressTimer);
                pocketPressTimer = null;
            }
        }

        function handlePocketPressStart(e) {
            // Ignore if tapping the X button
            if (e.target.closest('.pocket-close')) return;

            pocketLongPressTriggered = false;

            // Only enable long-press for timer exercises
            if (!isTimerType(currentExercise.type)) return;

            // Start long-press timer (700ms for deliberate action)
            pocketPressTimer = setTimeout(() => {
                pocketLongPressTriggered = true;
                handlePocketLongPress();
            }, 700);
        }

        function handlePocketPressEnd(e) {
            if (pocketPressTimer) {
                clearTimeout(pocketPressTimer);
                pocketPressTimer = null;
            }
        }

        function handlePocketPressCancel(e) {
            if (pocketPressTimer) {
                clearTimeout(pocketPressTimer);
                pocketPressTimer = null;
            }
            pocketLongPressTriggered = false;
        }

        function handlePocketLongPress() {
            // Log timer and advance to next rep
            if (isTimerType(currentExercise.type) && timerRunning) {
                logPartialTimerRep();
                updatePocketOverlay();
            }
        }

        function handlePocketTap() {
            if (!pocketMode) return;

            // If long-press was triggered, don't also handle tap
            if (pocketLongPressTriggered) {
                pocketLongPressTriggered = false;
                return;
            }

            if (COUNTER_TYPES.includes(currentExercise.type)) {
                incrementCounter();
            } else if (isTimerType(currentExercise.type)) {
                if (!timerRunning) {
                    startTimer();
                } else {
                    stopTimer();
                }
            }
            updatePocketOverlay();
        }

        function updatePocketOverlay() {
            const overlay = document.getElementById('pocket-overlay');
            if (!overlay.classList.contains('active')) return;

            const setsLeft = Math.max(currentExercise.sets - currentExercise.currentSet, 0);
            const repsLeft = Math.max((currentExercise.repsPerSet || 0) - currentExercise.currentRep, 0);
            const label = COUNTER_TYPES.includes(currentExercise.type)
                ? `${currentExercise.currentRep}`
                : `${formatSeconds(timerSecondsRemaining)}`;

            document.getElementById('pocket-label').textContent = label;

            const metaPieces = [
                `Sets left: ${setsLeft}`
            ];

            if (COUNTER_TYPES.includes(currentExercise.type) && currentExercise.type !== 'amrap' && currentExercise.repsPerSet) {
                metaPieces.push(`Reps left: ${repsLeft}`);
            }

            if (currentExercise.type === 'amrap' && currentExercise.secondsPerRep) {
                metaPieces.push(`AMRAP ${currentExercise.secondsPerRep}s window`);
            }

            if (currentExercise.type === 'distance') {
                metaPieces.push(`Distance goal: ${currentExercise.repsPerSet}`);
            }

            if (isTimerType(currentExercise.type)) {
                metaPieces.push(timerRunning ? 'Timer running' : 'Timer paused');
            }

            document.getElementById('pocket-meta').textContent = metaPieces.join(' ¬∑ ');
        }

        // iOS-style Action Sheet
        function showActionSheet(message, onConfirm) {
            document.getElementById('action-sheet-message').textContent = message;
            actionSheetCallback = onConfirm;

            const backdrop = document.getElementById('action-sheet-backdrop');
            const sheet = document.getElementById('action-sheet');

            backdrop.classList.add('active');
            setTimeout(() => {
                sheet.classList.add('active');
            }, 10);

            haptic('medium');
        }

        function hideActionSheet() {
            const backdrop = document.getElementById('action-sheet-backdrop');
            const sheet = document.getElementById('action-sheet');

            sheet.classList.remove('active');
            setTimeout(() => {
                backdrop.classList.remove('active');
            }, 300);

            actionSheetCallback = null;
            haptic('medium');
        }

        function confirmActionSheet() {
            if (actionSheetCallback) {
                actionSheetCallback();
            }
            hideActionSheet();
            haptic('medium');
        }

        // Counter Functions
        function incrementCounter() {
            if (!COUNTER_TYPES.includes(currentExercise.type)) return;

            currentExercise.currentRep++;
            haptic('medium');

            const repsLeft = currentExercise.repsPerSet - currentExercise.currentRep;

            // Voice announcements at milestones
            if (currentExercise.repsPerSet && currentExercise.type !== 'amrap') {
                if (repsLeft === 5) speak('5 reps left');
                else if (repsLeft === 3) speak('3 reps left');
                else if (repsLeft === 1) speak('Last rep');
                else if (repsLeft === 0) {
                    playCompletionSound();
                    haptic('success');
                    speak('Set complete');
                }
            }

            updateDisplay();
        }

        function formatSeconds(totalSeconds = 0) {
            const minutes = Math.floor(Math.max(totalSeconds, 0) / 60);
            const seconds = Math.max(totalSeconds % 60, 0);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateDisplay() {
            // Handle no exercise selected
            if (!currentExercise) {
                document.getElementById('exercise-name').textContent = 'No Exercise Selected';
                document.getElementById('set-info').textContent = 'Tap "Exercises" below to choose';
                document.getElementById('remaining-info').textContent = '';
                document.getElementById('counter-mode').classList.add('hidden');
                document.getElementById('timer-mode').classList.add('hidden');
                document.getElementById('main-controls').classList.add('hidden');
                return;
            }

            document.getElementById('exercise-name').textContent = currentExercise.name;

            // For sided exercises, show per-side progress
            const hasSides = currentExercise.sideOptions && currentExercise.sideOptions.length > 0 && !currentExercise.bilateral;
            let setInfoText = `Set ${currentExercise.currentSet} of ${currentExercise.sets}`;

            if (hasSides && currentExercise.baseSets) {
                setInfoText += ` (${currentExercise.baseSets} per side)`;
            }
            document.getElementById('set-info').textContent = setInfoText;

            const setsLeft = Math.max(currentExercise.sets - currentExercise.currentSet, 0);
            const repsLeft = Math.max((currentExercise.repsPerSet || 0) - currentExercise.currentRep, 0);

            let remainingLabel = `Sets left: ${setsLeft}`;

            // For sided exercises, show per-side breakdown
            if (hasSides && currentExercise.sideOptions) {
                const sideProgress = {};
                currentExercise.sideOptions.forEach(side => sideProgress[side] = 0);

                // Count completed sets per side
                currentExercise.sessionData.forEach(set => {
                    if (set.side && sideProgress[set.side] !== undefined) {
                        sideProgress[set.side]++;
                    }
                });

                const sideLabels = currentExercise.sideOptions.map(side =>
                    `${side}: ${sideProgress[side]}/${currentExercise.baseSets}`
                ).join(' ¬∑ ');
                remainingLabel = `${sideLabels}`;
            }

            if (COUNTER_TYPES.includes(currentExercise.type) && currentExercise.type !== 'amrap' && currentExercise.repsPerSet) {
                remainingLabel += ` ¬∑ Reps left: ${repsLeft}`;
            }
            if (currentExercise.type === 'amrap' && currentExercise.secondsPerRep) {
                remainingLabel += ` ¬∑ ${currentExercise.secondsPerRep}s AMRAP window`;
            }
            if (isTimerType(currentExercise.type)) {
                remainingLabel += ` ¬∑ Time: ${formatSeconds(timerSecondsRemaining)}`;
            }
            document.getElementById('remaining-info').textContent = remainingLabel;

            if (COUNTER_TYPES.includes(currentExercise.type)) {
                document.getElementById('counter-mode').classList.remove('hidden');
                document.getElementById('timer-mode').classList.add('hidden');
                document.getElementById('main-controls').classList.remove('hidden');

                document.getElementById('counter-display').textContent = currentExercise.currentRep;

                let targetText = 'Target: ';
                if (currentExercise.type === 'amrap') {
                    targetText += currentExercise.secondsPerRep ? `${currentExercise.secondsPerRep}s AMRAP window` : 'AMRAP';
                } else if (currentExercise.type === 'distance') {
                    targetText += `${currentExercise.repsPerSet || 0} distance units`;
                } else {
                    targetText += `${currentExercise.repsPerSet} reps`;
                }
                document.getElementById('target-info').textContent = targetText;

                const progress = currentExercise.repsPerSet
                    ? Math.min((currentExercise.currentRep / currentExercise.repsPerSet) * 100, 100)
                    : Math.min((currentExercise.currentSet / currentExercise.sets) * 100, 100);
                document.getElementById('progress-bar').style.width = progress + '%';
            } else {
                document.getElementById('counter-mode').classList.add('hidden');
                document.getElementById('timer-mode').classList.remove('hidden');
                document.getElementById('main-controls').classList.remove('hidden');

                const repLabel = currentExercise.type === 'hold' || currentExercise.type === 'duration'
                    ? `Set ${currentExercise.currentSet} timer`
                    : `Rep ${currentExercise.currentRep + 1} of ${currentExercise.repsPerSet}`;
                document.getElementById('timer-rep-info').textContent = repLabel;

                const display = formatSeconds(timerSecondsRemaining);
                document.getElementById('timer-display').textContent = display;

                const timerLabel = currentExercise.type === 'duration'
                    ? `Target: ${currentExercise.secondsPerRep || 0}s total`
                    : `Target: ${currentExercise.secondsPerRep || 0} seconds`;
                document.getElementById('timer-target').textContent = timerLabel;

                const progress = currentExercise.secondsPerRep
                    ? Math.max(0, (timerSecondsRemaining / currentExercise.secondsPerRep) * 100)
                    : 0;
                document.getElementById('timer-progress-bar').style.width = progress + '%';

                const timerDisplay = document.getElementById('timer-display');
                timerDisplay.classList.remove('warning', 'danger');
                if (timerSecondsRemaining <= 5 && timerSecondsRemaining > 0) {
                    timerDisplay.classList.add('danger');
                } else if (timerSecondsRemaining <= 10 && timerSecondsRemaining > 5) {
                    timerDisplay.classList.add('warning');
                }

                const logControls = document.getElementById('timer-log-controls');
                if (timerRunning) {
                    document.getElementById('timer-start-btn').classList.add('hidden');
                    document.getElementById('timer-stop-btn').classList.remove('hidden');
                    document.getElementById('timer-reset-btn').classList.add('hidden');
                    logControls.style.display = 'none';
                } else if (timerSecondsRemaining === 0 || timerSecondsRemaining === currentExercise.secondsPerRep) {
                    document.getElementById('timer-start-btn').classList.remove('hidden');
                    document.getElementById('timer-stop-btn').classList.add('hidden');
                    document.getElementById('timer-reset-btn').classList.add('hidden');
                    logControls.style.display = 'none';
                } else {
                    // Timer is paused mid-rep
                    document.getElementById('timer-start-btn').classList.remove('hidden');
                    document.getElementById('timer-stop-btn').classList.add('hidden');
                    document.getElementById('timer-reset-btn').classList.remove('hidden');
                    // Show "Log This Time & Next Rep" button when paused
                    logControls.style.display = 'flex';
                }
            }

            updatePocketOverlay();
        }

        function startTimer() {
            if (timerInterval || !isTimerType(currentExercise.type)) return;

            const targetSeconds = Math.max(currentExercise.secondsPerRep || 0, 1);

            // Initialize timer if starting fresh
            if (timerSecondsRemaining === 0) {
                timerSecondsRemaining = targetSeconds;
            }

            timerRunning = true;
            playBeep(400, 100); // Audio feedback for resume
            haptic('heavy'); // Stronger haptic for resume

            timerInterval = setInterval(() => {
                timerSecondsRemaining--;
                updateDisplay();

                // Countdown beeps
                if (timerSecondsRemaining <= 3 && timerSecondsRemaining > 0) {
                    playBeep(600, 100);
                    haptic('medium');
                }

                // Timer complete
                if (timerSecondsRemaining <= 0) {
                    stopTimer();
                    playCompletionSound();
                    haptic('success');

                    currentExercise.currentRep++;

                    const repsLeft = currentExercise.repsPerSet - currentExercise.currentRep;
                    if (repsLeft === 0) speak('Set complete');
                    else if (repsLeft === 1) speak('Last rep');
                    else speak(`${repsLeft} reps left`);

                    // Auto-complete holds/durations when rep target is reached
                    if (currentExercise.type !== 'timed' && currentExercise.repsPerSet && currentExercise.currentRep >= currentExercise.repsPerSet) {
                        updateDisplay();
                        return;
                    }

                    // Reset timer for next rep
                    timerSecondsRemaining = targetSeconds;
                    updateDisplay();
                }
            }, 1000);

            updateDisplay();
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerRunning = false;
            playBeep(300, 100); // Audio feedback for pause
            haptic('heavy'); // Stronger haptic for pause
            updateDisplay();
        }

        function seedTimerSeconds() {
            timerSecondsRemaining = isTimerType(currentExercise.type)
                ? Math.max(currentExercise.secondsPerRep || 0, 1)
                : 0;
        }

        function resetTimer() {
            stopTimer();
            seedTimerSeconds();
            haptic('heavy');
            updateDisplay();
        }

        // Log the current partial timer value and advance to next rep
        function logPartialTimerRep() {
            const achievedSeconds = Math.max(currentExercise.secondsPerRep || 0, 1) - timerSecondsRemaining;

            // Record this rep with the actual time achieved (not target)
            currentExercise.sessionData.push({
                set: currentExercise.currentSet,
                reps: 1,
                secondsAchieved: achievedSeconds,
                secondsTarget: currentExercise.secondsPerRep || 0,
                type: currentExercise.type,
                timestamp: new Date().toISOString(),
                partialRep: true
            });

            playBeep(500, 150);
            haptic('success');
            speak(`Logged ${achievedSeconds} seconds`);

            currentExercise.currentRep++;

            const repsLeft = currentExercise.repsPerSet - currentExercise.currentRep;
            if (repsLeft === 0) {
                speak('Set complete');
                seedTimerSeconds();
                updateDisplay();
            } else {
                if (repsLeft === 1) speak('Last rep');
                else speak(`${repsLeft} reps left`);

                // Reset timer for next rep
                seedTimerSeconds();
                updateDisplay();
            }
        }

        function completeSet() {
            const reps = currentExercise.currentRep;

            if (reps === 0) {
                showActionSheet('No reps recorded. Complete set anyway?', () => {
                    finishSet();
                });
                return;
            }

            currentExercise.sessionData.push({
                set: currentExercise.currentSet,
                reps: reps,
                type: currentExercise.type,
                timestamp: new Date().toISOString()
            });

            haptic('success');
            speak(`Set ${currentExercise.currentSet} complete`);

            // Check for progress
            detectProgress(currentExercise.currentSet, reps);

            if (currentExercise.currentSet < currentExercise.sets) {
                currentExercise.currentSet++;
                currentExercise.currentRep = 0;
                seedTimerSeconds();
                stopTimer();
                updateDisplay();

                // Show rest timer if rest time is recommended
                const entry = getLibraryEntryById(currentExercise.id);
                const restSeconds = entry.details?.restSeconds;
                if (restSeconds && restSeconds > 0) {
                    showRestTimer(restSeconds);
                }
            } else {
                speak('All sets complete');
                showSessionNotesModal();
            }
        }

        /**
         * EXERCISE EXECUTION DATA TRACKING
         * ---------------------------------
         * When performing an exercise, this app currently tracks:
         *
         * currentExercise.sessionData[] contains:
         *   - set: which set number (1-based)
         *   - reps: how many reps completed
         *   - type: exercise type (reps, timed, hold, etc.)
         *   - timestamp: ISO datetime of completion
         *   - side: (optional) which side for unilateral exercises ('left', 'right', 'both')
         *   - weight: (optional) weight used in lbs/kg
         *   - weightUnit: (optional) 'lbs' or 'kg'
         *   - resistance: (optional) resistance band level ('light', 'medium', 'heavy')
         *   - secondsAchieved: (optional) actual time held (for partial timer reps)
         *   - secondsTarget: (optional) target time (for partial timer reps)
         *   - partialRep: (optional) true if logged early via "Log This Time"
         *   - manualLog: (optional) true if logged via "Log Set" modal
         *
         * At session completion (all sets done):
         *   - sessionData is saved to localStorage under STORAGE_KEY
         *   - Includes: exerciseId, exerciseName, date, sets[], notes
         *
         * TODO: Define "session" concept - when does it start/end? How to group exercises?
         * TODO: Add session planning (which exercises in what order for today)
         * TODO: Track adherence to program-level dosage prescriptions
         * TODO: Progressive overload tracking (weight/resistance over time)
         */
        function finishSet() {
            currentExercise.sessionData.push({
                set: currentExercise.currentSet,
                reps: currentExercise.currentRep,
                type: currentExercise.type,
                timestamp: new Date().toISOString()
            });

            if (currentExercise.currentSet < currentExercise.sets) {
                currentExercise.currentSet++;
                currentExercise.currentRep = 0;
                seedTimerSeconds();
                stopTimer();
                updateDisplay();
            } else {
                showSessionNotesModal();
            }
        }

        let logSetSide = 'both'; // Track which side for unilateral exercises

        function showLogSetModal() {
            const targetReps = currentExercise.repsPerSet || 0;
            document.getElementById('log-set-title').textContent = `Log Set ${currentExercise.currentSet}`;

            // Show side selector for unilateral exercises
            const entry = getLibraryEntryById(currentExercise.id);
            const isBilateral = entry.bilateral === true;
            const sideOptions = entry.sideOptions || [];

            // For sided exercises, show which sides need more sets
            let subtitleText = `Target: ${targetReps} reps ¬∑ Enter actual reps performed`;
            if (sideOptions.length > 0 && !isBilateral && currentExercise.baseSets) {
                // Count completed sets per side
                const sideProgress = {};
                sideOptions.forEach(side => sideProgress[side] = 0);
                currentExercise.sessionData.forEach(set => {
                    if (set.side && sideProgress[set.side] !== undefined) {
                        sideProgress[set.side]++;
                    }
                });

                // Find which side needs more sets (for smart default selection)
                let suggestedSide = sideOptions[0];
                for (const side of sideOptions) {
                    if (sideProgress[side] < currentExercise.baseSets) {
                        suggestedSide = side;
                        break;
                    }
                }

                const progressText = sideOptions.map(side =>
                    `${side}: ${sideProgress[side]}/${currentExercise.baseSets}`
                ).join(', ');
                subtitleText = `${progressText} ¬∑ Enter reps for selected side`;
                logSetSide = suggestedSide;
            } else {
                logSetSide = sideOptions[0] || 'both';
            }

            document.getElementById('log-set-subtitle').textContent = subtitleText;
            document.getElementById('log-set-reps').value = targetReps;

            // Clear weight/resistance fields
            document.getElementById('log-set-weight').value = '';
            document.getElementById('log-set-weight-unit').value = 'lbs';
            document.getElementById('log-set-resistance').value = '';

            const sideContainer = document.getElementById('log-set-side-selector');
            if (sideOptions.length > 0 && !isBilateral) {
                sideContainer.innerHTML = '<div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Select side for this set:</div>' +
                    sideOptions.map(side => {
                        return `<span class="pill" style="cursor: pointer; background: ${logSetSide === side ? 'var(--ios-blue)' : 'rgba(0,122,255,0.1)'}; color: ${logSetSide === side ? 'white' : 'var(--ios-blue)'};" onclick="selectLogSetSide('${side}')">${side}</span>`;
                    }).join(' ');
            } else {
                sideContainer.innerHTML = '';
                logSetSide = 'both';
            }

            document.getElementById('log-set-modal').classList.add('active');
            haptic('medium');

            // Auto-focus the input
            setTimeout(() => {
                document.getElementById('log-set-reps').focus();
                document.getElementById('log-set-reps').select();
            }, 300);
        }

        function selectLogSetSide(side) {
            logSetSide = side;
            const sideOptions = getLibraryEntryById(currentExercise.id).sideOptions || [];
            const sideContainer = document.getElementById('log-set-side-selector');
            sideContainer.innerHTML = '<div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Side:</div>' +
                sideOptions.map(s => {
                    return `<span class="pill" style="cursor: pointer; background: ${logSetSide === s ? 'var(--ios-blue)' : 'rgba(0,122,255,0.1)'}; color: ${logSetSide === s ? 'white' : 'var(--ios-blue)'};" onclick="selectLogSetSide('${s}')">${s}</span>`;
                }).join(' ');
        }

        function closeLogSetModal() {
            document.getElementById('log-set-modal').classList.remove('active');
            haptic('medium');
        }

        function saveLoggedSet() {
            const reps = parseInt(document.getElementById('log-set-reps').value);

            if (isNaN(reps) || reps < 0) {
                alert('Please enter a valid number of reps (0 or more).');
                return;
            }

            const setData = {
                set: currentExercise.currentSet,
                reps: reps,
                type: currentExercise.type,
                timestamp: new Date().toISOString(),
                manualLog: true
            };

            // Add side if applicable
            if (logSetSide && logSetSide !== 'both') {
                setData.side = logSetSide;
            }

            // Add weight tracking if provided
            const weight = parseFloat(document.getElementById('log-set-weight').value);
            if (!isNaN(weight) && weight > 0) {
                const unit = document.getElementById('log-set-weight-unit').value;
                setData.weight = weight;
                setData.weightUnit = unit;
            }

            // Add resistance band tracking if provided
            const resistance = document.getElementById('log-set-resistance').value;
            if (resistance) {
                setData.resistance = resistance;
            }

            currentExercise.sessionData.push(setData);

            closeLogSetModal();
            haptic('success');
            speak(`Set ${currentExercise.currentSet} logged: ${reps} reps`);

            // Check for progress
            detectProgress(currentExercise.currentSet, reps);

            if (currentExercise.currentSet < currentExercise.sets) {
                currentExercise.currentSet++;
                currentExercise.currentRep = 0;
                seedTimerSeconds();
                stopTimer();
                updateDisplay();
            } else {
                speak('All sets complete');
                showSessionNotesModal();
            }
        }

        // Smart Progress Detection
        function detectProgress(setNumber, reps) {
            const sessions = loadHistory();
            const previousSessions = sessions.filter(s => s.exerciseId === currentExercise.id);

            if (previousSessions.length === 0) return; // First time doing this exercise

            const lastSession = previousSessions[previousSessions.length - 1];
            const lastSetReps = lastSession.sets && lastSession.sets[setNumber - 1]?.reps;

            if (!lastSetReps) return; // No comparison data

            const diff = reps - lastSetReps;

            if (diff > 0) {
                setTimeout(() => {
                    speak(`${diff} more rep${diff > 1 ? 's' : ''} than last time!`);
                    haptic('success');
                }, 1500);
            } else if (diff < 0 && Math.abs(diff) > 2) {
                // Only mention if significantly fewer (more than 2 reps)
                setTimeout(() => {
                    speak(`${Math.abs(diff)} fewer reps than last time`);
                }, 1500);
            }
        }

        function previousSet() {
            if (currentExercise.currentSet > 1) {
                currentExercise.currentSet--;
                currentExercise.currentRep = 0;
                seedTimerSeconds();
                stopTimer();
                haptic('medium');
                updateDisplay();
            }
        }

        function showSessionNotesModal() {
            document.getElementById('session-notes').value = '';
            document.getElementById('session-notes-modal').classList.add('active');
            haptic('medium');
        }

        function closeSessionNotesModal() {
            document.getElementById('session-notes-modal').classList.remove('active');
            haptic('medium');
        }

        function saveSessionWithNotes(notes) {
            const sessions = loadHistory();
            sessions.push({
                sessionId: currentSessionId,
                exerciseId: currentExercise.id,
                exerciseName: currentExercise.name,
                exerciseType: currentExercise.type,
                date: new Date().toISOString(),
                notes: notes.trim(),
                exerciseSpec: {
                    sets: currentExercise.sets,
                    repsPerSet: currentExercise.repsPerSet,
                    secondsPerRep: currentExercise.secondsPerRep,
                    type: currentExercise.type
                },
                sets: currentExercise.sessionData
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));

            haptic('success');
            closeSessionNotesModal();

            // Mark exercise as completed in session plan
            if (sessionPlan.includes(currentExercise.id)) {
                sessionPlanCompleted.add(currentExercise.id);
                updateSessionPlanDisplay();

                // Auto-advance to next exercise in plan
                const nextExercise = getNextPlannedExercise();
                if (nextExercise) {
                    currentExercise = toSessionExercise(nextExercise);
                    localStorage.setItem(LAST_EXERCISE_KEY, nextExercise.id);
                    seedTimerSeconds();
                    updateDisplay();
                    speak(`Next: ${nextExercise.name}`);
                    return;
                }
            }

            // Reset for new session
            currentExercise.currentSet = 1;
            currentExercise.currentRep = 0;
            currentExercise.sessionData = [];
            seedTimerSeconds();
            stopTimer();
            updateDisplay();
            updateStreakDisplay(); // Refresh streak after completing session
            updateQuickStartShortcuts(); // Update shortcuts based on usage
        }

        function updateQuickStartShortcuts() {
            const sessions = loadHistory();
            const container = document.getElementById('quick-start-container');
            const exercisesContainer = document.getElementById('quick-start-exercises');

            if (sessions.length === 0 || exerciseLibrary.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Count exercise usage in last 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const usageCount = {};
            sessions.forEach(session => {
                const sessionDate = new Date(session.date);
                if (sessionDate >= thirtyDaysAgo) {
                    usageCount[session.exerciseId] = (usageCount[session.exerciseId] || 0) + 1;
                }
            });

            // Sort by usage and get top 5
            const sortedExercises = Object.entries(usageCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([id]) => id);

            if (sortedExercises.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Render shortcuts
            exercisesContainer.innerHTML = sortedExercises.map(id => {
                const entry = getLibraryEntryById(id);
                if (!entry || entry.archived) return '';
                return `<button class="pill" style="cursor: pointer; padding: 8px 14px; background: var(--ios-blue); color: white; font-weight: 500; white-space: normal; word-wrap: break-word; text-align: left; line-height: 1.4;" onclick="quickStartExercise('${id}')">${entry.name}</button>`;
            }).filter(Boolean).join('');

            container.style.display = exercisesContainer.innerHTML ? 'block' : 'none';
        }

        function quickStartExercise(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            if (!entry) return;

            currentExercise = toSessionExercise(entry);
            localStorage.setItem(LAST_EXERCISE_KEY, exerciseId);
            seedTimerSeconds();
            updateDisplay();
            haptic('medium');
            speak(`Starting ${entry.name}`);
        }

        // Session Planning Functions
        function showPlanSessionModal() {
            closeExerciseList();
            renderPlanSessionList();
            document.getElementById('plan-session-modal').classList.add('active');
            haptic('medium');
        }

        function closePlanSessionModal() {
            document.getElementById('plan-session-modal').classList.remove('active');
            haptic('medium');
        }

        function renderPlanSessionList() {
            const container = document.getElementById('plan-session-list');
            const activeExercises = exerciseLibrary.filter(ex => !ex.archived);

            if (activeExercises.length === 0) {
                container.innerHTML = '<div class="history-item">No exercises available. Add some first!</div>';
                return;
            }

            container.innerHTML = activeExercises.map(ex => {
                const spec = ex.current || {};
                const isSelected = sessionPlan.includes(ex.id);
                return `
                    <div class="history-item" onclick="toggleExerciseInPlan('${ex.id}')" style="cursor: pointer; background: ${isSelected ? 'rgba(0,122,255,0.1)' : 'transparent'}; border: 2px solid ${isSelected ? 'var(--ios-blue)' : 'transparent'};">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${ex.name}</div>
                                <div class="history-meta">${describeSpec(spec)}</div>
                            </div>
                            <div style="font-size: 20px; margin-left: 12px;">${isSelected ? '‚úì' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update button state
            const btn = document.getElementById('start-session-btn');
            btn.disabled = sessionPlan.length === 0;
            btn.style.opacity = sessionPlan.length === 0 ? '0.5' : '1';
        }

        function toggleExerciseInPlan(exerciseId) {
            const index = sessionPlan.indexOf(exerciseId);
            if (index > -1) {
                sessionPlan.splice(index, 1);
            } else {
                sessionPlan.push(exerciseId);
            }
            renderPlanSessionList();
            haptic('light');
        }

        function startPlannedSession() {
            if (sessionPlan.length === 0) return;

            sessionPlanCompleted.clear();
            closePlanSessionModal();

            // Start with first exercise in plan
            const firstExercise = getLibraryEntryById(sessionPlan[0]);
            if (firstExercise) {
                currentExercise = toSessionExercise(firstExercise);
                localStorage.setItem(LAST_EXERCISE_KEY, firstExercise.id);
                seedTimerSeconds();
                updateDisplay();
                updateSessionPlanDisplay();
                speak(`Starting session: ${firstExercise.name}`);
                haptic('success');
            }
        }

        function updateSessionPlanDisplay() {
            const container = document.getElementById('session-plan-container');
            const listContainer = document.getElementById('session-plan-list');

            if (sessionPlan.length === 0) {
                container.style.display = 'none';
                return;
            }

            const planItems = sessionPlan.map(id => {
                const entry = getLibraryEntryById(id);
                if (!entry) return '';

                const isCompleted = sessionPlanCompleted.has(id);
                const isCurrent = currentExercise && currentExercise.id === id;

                return `
                    <div onclick="switchToPlannedExercise('${id}')" style="padding: 8px 12px; border-radius: 8px; background: ${isCurrent ? 'var(--ios-blue)' : isCompleted ? 'var(--ios-green)' : 'var(--bg-primary)'}; color: ${isCurrent || isCompleted ? 'white' : 'var(--text-primary)'}; cursor: pointer; display: flex; align-items: center; gap: 8px; ${isCompleted ? 'opacity: 0.7;' : ''}">
                        <div style="font-size: 16px;">${isCompleted ? '‚úì' : isCurrent ? '‚ñ∂' : '‚óã'}</div>
                        <div style="flex: 1; font-size: 14px; font-weight: ${isCurrent ? '600' : '500'};">${entry.name}</div>
                    </div>
                `;
            }).filter(Boolean).join('');

            listContainer.innerHTML = planItems;
            container.style.display = 'block';
        }

        function switchToPlannedExercise(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            if (!entry) return;

            // Save current progress if switching mid-exercise
            if (currentExercise && currentExercise.sessionData.length > 0) {
                if (!confirm('Switch exercises? Current progress will be lost.')) {
                    return;
                }
            }

            currentExercise = toSessionExercise(entry);
            localStorage.setItem(LAST_EXERCISE_KEY, exerciseId);
            seedTimerSeconds();
            updateDisplay();
            updateSessionPlanDisplay();
            haptic('medium');
            speak(`Switched to ${entry.name}`);
        }

        function getNextPlannedExercise() {
            const remaining = sessionPlan.filter(id => !sessionPlanCompleted.has(id));
            if (remaining.length === 0) return null;
            return getLibraryEntryById(remaining[0]);
        }

        function endSessionEarly() {
            const completed = sessionPlanCompleted.size;
            const total = sessionPlan.length;
            const message = `End session early?\n\nCompleted: ${completed}/${total} exercises\n\nSession plan will be cleared.`;

            showActionSheet(message, () => {
                sessionPlan = [];
                sessionPlanCompleted.clear();
                updateSessionPlanDisplay();
                haptic('medium');
                speak('Session ended');
            });
        }

        // All Sessions Functions
        function showAllSessions() {
            closeWeeklyStats();
            const sessions = loadHistory();

            // Group by sessionId
            const sessionGroups = {};
            sessions.forEach(session => {
                const sid = session.sessionId || 'unknown';
                if (!sessionGroups[sid]) {
                    sessionGroups[sid] = [];
                }
                sessionGroups[sid].push(session);
            });

            // Sort session groups by date (most recent first)
            const sortedGroups = Object.entries(sessionGroups).sort((a, b) => {
                const aDate = new Date(a[1][0].date);
                const bDate = new Date(b[1][0].date);
                return bDate - aDate;
            });

            const container = document.getElementById('all-sessions-list');

            if (sortedGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No sessions recorded yet.</div>';
            } else {
                container.innerHTML = sortedGroups.map(([sessionId, exercises]) => {
                    const sessionDate = new Date(exercises[0].date);
                    const totalExercises = exercises.length;
                    const totalSets = exercises.reduce((sum, ex) => sum + (ex.sets?.length || 0), 0);
                    const totalReps = exercises.reduce((sum, ex) => sum + ex.sets.reduce((rs, set) => rs + (set.reps || 0), 0), 0);

                    // Check if this is today's session
                    const isToday = sessionDate.toDateString() === new Date().toDateString();

                    return `
                        <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 12px; ${isToday ? 'border: 2px solid var(--ios-blue);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 15px;">
                                        ${sessionDate.toLocaleDateString()}
                                        ${isToday ? '<span style="color: var(--ios-blue); margin-left: 8px;">‚Ä¢ Today</span>' : ''}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                                        ${sessionDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                                    </div>
                                </div>
                                <div style="text-align: right; font-size: 12px; color: var(--text-secondary);">
                                    <div>${totalExercises} exercise${totalExercises !== 1 ? 's' : ''}</div>
                                    <div>${totalSets} sets ¬∑ ${totalReps} reps</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid var(--border-color); padding-top: 8px;">
                                ${exercises.map(ex => {
                                    const exTotalReps = ex.sets.reduce((sum, set) => sum + (set.reps || 0), 0);
                                    const avgReps = (exTotalReps / ex.sets.length).toFixed(1);
                                    return `
                                        <div style="padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer;" onclick="showExerciseProgress('${ex.exerciseId}')">
                                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px;">${ex.exerciseName}</div>
                                            <div style="font-size: 11px; color: var(--text-secondary);">
                                                ${ex.sets.length} sets √ó ${avgReps} avg = ${exTotalReps} total reps
                                            </div>
                                            ${ex.notes ? `<div style="font-size: 11px; color: var(--ios-gray); margin-top: 2px; font-style: italic;">"${ex.notes}"</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('all-sessions-modal').classList.add('active');
            haptic('medium');
        }

        function closeAllSessions() {
            document.getElementById('all-sessions-modal').classList.remove('active');
            haptic('medium');
        }

        // Weekly Stats Functions
        function showWeeklyStats() {
            const sessions = loadHistory();
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            const weekSessions = sessions.filter(s => new Date(s.date) >= startOfWeek);

            renderWeeklyOverview(weekSessions, startOfWeek);
            renderWeeklyVolumeChart(sessions);
            renderWeeklyExercises(weekSessions);
            renderWeeklyAdherence(sessions);

            document.getElementById('weekly-stats-modal').classList.add('active');
            haptic('medium');
        }

        function closeWeeklyStats() {
            document.getElementById('weekly-stats-modal').classList.remove('active');
            haptic('medium');
        }

        function renderWeeklyOverview(weekSessions, startOfWeek) {
            const container = document.getElementById('weekly-overview');

            const totalSessions = weekSessions.length;
            const uniqueExercises = new Set(weekSessions.map(s => s.exerciseId)).size;
            const totalSets = weekSessions.reduce((sum, s) => sum + (s.sets?.length || 0), 0);
            const totalReps = weekSessions.reduce((sum, s) => sum + s.sets.reduce((rs, set) => rs + (set.reps || 0), 0), 0);

            // Days trained this week
            const daysWithSessions = new Set(weekSessions.map(s => new Date(s.date).toDateString())).size;

            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">
                        This Week (${startOfWeek.toLocaleDateString()})
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Sessions</div>
                            <div style="font-size: 24px; font-weight: 700;">${totalSessions}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Days Trained</div>
                            <div style="font-size: 24px; font-weight: 700;">${daysWithSessions}<span style="font-size: 14px;">/7</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Total Volume</div>
                            <div style="font-size: 24px; font-weight: 700;">${totalReps}<span style="font-size: 14px;"> reps</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Exercises</div>
                            <div style="font-size: 24px; font-weight: 700;">${uniqueExercises}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeeklyVolumeChart(allSessions) {
            const container = document.getElementById('weekly-volume-chart');

            // Calculate volume for past 8 weeks
            const weeks = [];
            for (let i = 7; i >= 0; i--) {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - weekStart.getDay() - (i * 7));
                weekStart.setHours(0, 0, 0, 0);

                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);

                const weekSessions = allSessions.filter(s => {
                    const sessionDate = new Date(s.date);
                    return sessionDate >= weekStart && sessionDate < weekEnd;
                });

                const totalReps = weekSessions.reduce((sum, s) => sum + s.sets.reduce((rs, set) => rs + (set.reps || 0), 0), 0);
                const totalSets = weekSessions.reduce((sum, s) => sum + s.sets.length, 0);

                weeks.push({
                    label: i === 0 ? 'This week' : `${i}w ago`,
                    date: weekStart.toLocaleDateString([], {month: 'short', day: 'numeric'}),
                    reps: totalReps,
                    sets: totalSets,
                    sessions: weekSessions.length
                });
            }

            const maxReps = Math.max(...weeks.map(w => w.reps), 1);

            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">Volume Trend (8 Weeks)</div>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        ${weeks.map(week => {
                            const barWidth = (week.reps / maxReps * 100).toFixed(1);
                            const color = week.reps > 0 ? 'var(--ios-blue)' : 'var(--ios-gray)';
                            return `
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                                    <div style="width: 60px; color: var(--text-secondary); flex-shrink: 0; font-size: 11px;">${week.date}</div>
                                    <div style="flex: 1; background: rgba(0,122,255,0.1); border-radius: 4px; height: 28px; position: relative;">
                                        <div style="background: ${color}; border-radius: 4px; height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                                        <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-weight: 600; color: var(--text-primary); font-size: 11px;">
                                            ${week.reps > 0 ? `${week.reps} reps` : '‚Äî'}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 11px; color: var(--text-secondary); text-align: center;">
                        Total weekly volume helps PTs monitor training load progression
                    </div>
                </div>
            `;
        }

        function renderWeeklyExercises(weekSessions) {
            const container = document.getElementById('weekly-exercises');

            if (weekSessions.length === 0) {
                container.innerHTML = `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; color: var(--text-secondary);">
                        No sessions this week yet. Start training!
                    </div>
                `;
                return;
            }

            // Group by exercise
            const exerciseGroups = {};
            weekSessions.forEach(session => {
                const exId = session.exerciseId;
                if (!exerciseGroups[exId]) {
                    exerciseGroups[exId] = {
                        name: session.exerciseName,
                        sessions: [],
                        totalReps: 0,
                        totalSets: 0
                    };
                }
                exerciseGroups[exId].sessions.push(session);
                exerciseGroups[exId].totalSets += session.sets.length;
                exerciseGroups[exId].totalReps += session.sets.reduce((sum, set) => sum + (set.reps || 0), 0);
            });

            const sortedExercises = Object.entries(exerciseGroups).sort((a, b) => b[1].sessions.length - a[1].sessions.length);

            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">Exercises This Week</div>
                    ${sortedExercises.map(([exId, group]) => `
                        <div style="padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="showExerciseProgress('${exId}')">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${group.name}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                ${group.sessions.length}√ó sessions ¬∑ ${group.totalSets} sets ¬∑ ${group.totalReps} reps
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderWeeklyAdherence(allSessions) {
            const container = document.getElementById('weekly-adherence');

            // Last 4 weeks
            const weeks = [];
            for (let i = 0; i < 4; i++) {
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - weekStart.getDay() - (i * 7));
                weekStart.setHours(0, 0, 0, 0);

                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);

                const weekSessions = allSessions.filter(s => {
                    const sessionDate = new Date(s.date);
                    return sessionDate >= weekStart && sessionDate < weekEnd;
                });

                const daysWithSessions = new Set(weekSessions.map(s => new Date(s.date).toDateString())).size;

                weeks.push({
                    label: i === 0 ? 'This week' : `${i} week${i > 1 ? 's' : ''} ago`,
                    sessions: weekSessions.length,
                    days: daysWithSessions
                });
            }

            weeks.reverse();

            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">Adherence Trend</div>
                    ${weeks.map(week => {
                        const barWidth = (week.days / 7 * 100).toFixed(1);
                        const color = week.days >= 3 ? 'var(--ios-green)' : week.days >= 1 ? 'var(--ios-orange)' : 'var(--ios-gray)';
                        return `
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 12px;">
                                    <div style="color: var(--text-secondary);">${week.label}</div>
                                    <div style="font-weight: 600;">${week.days} day${week.days !== 1 ? 's' : ''} ¬∑ ${week.sessions} sessions</div>
                                </div>
                                <div style="background: rgba(0,122,255,0.1); border-radius: 4px; height: 20px; position: relative;">
                                    <div style="background: ${color}; border-radius: 4px; height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary); text-align: center;">
                        Aim for 3-5 training days per week for best results
                    </div>
                </div>
            `;
        }

        // Exercise Progress Tracking Functions
        function showExerciseProgress(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            if (!entry) return;

            const sessions = loadHistory();
            const exerciseSessions = sessions.filter(s => s.exerciseId === exerciseId || s.exerciseName === entry.name);

            if (exerciseSessions.length === 0) {
                alert('No sessions recorded yet for this exercise.');
                return;
            }

            document.getElementById('progress-modal-title').textContent = `${entry.name} - Progress`;
            renderProgressSummary(entry, exerciseSessions);
            renderProgressChart(exerciseSessions);
            renderProgressSessions(exerciseSessions);

            document.getElementById('exercise-progress-modal').classList.add('active');
            haptic('medium');
        }

        function closeExerciseProgress() {
            document.getElementById('exercise-progress-modal').classList.remove('active');
            haptic('medium');
        }

        function renderProgressSummary(entry, sessions) {
            const container = document.getElementById('progress-summary');

            const totalSessions = sessions.length;
            const allSets = sessions.flatMap(s => s.sets);
            const totalSets = allSets.length;
            const totalReps = allSets.reduce((sum, set) => sum + (set.reps || 0), 0);
            const avgRepsPerSet = (totalReps / totalSets).toFixed(1);

            // First vs last comparison
            const firstSession = sessions[0];
            const lastSession = sessions[sessions.length - 1];
            const firstAvgReps = firstSession.sets.reduce((sum, set) => sum + (set.reps || 0), 0) / firstSession.sets.length;
            const lastAvgReps = lastSession.sets.reduce((sum, set) => sum + (set.reps || 0), 0) / lastSession.sets.length;
            const improvement = ((lastAvgReps - firstAvgReps) / firstAvgReps * 100).toFixed(1);
            const improvementColor = improvement >= 0 ? 'var(--ios-green)' : 'var(--ios-red)';

            // Frequency
            const firstDate = new Date(firstSession.date);
            const lastDate = new Date(lastSession.date);
            const daySpan = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) || 1;
            const sessionsPerWeek = ((totalSessions / daySpan) * 7).toFixed(1);

            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">Summary</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Total Sessions</div>
                            <div style="font-size: 20px; font-weight: 700;">${totalSessions}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Frequency</div>
                            <div style="font-size: 20px; font-weight: 700;">${sessionsPerWeek}√ó<span style="font-size: 14px;">/week</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Total Volume</div>
                            <div style="font-size: 20px; font-weight: 700;">${totalReps}<span style="font-size: 14px;"> reps</span></div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 11px;">Avg per Set</div>
                            <div style="font-size: 20px; font-weight: 700;">${avgRepsPerSet}<span style="font-size: 14px;"> reps</span></div>
                        </div>
                    </div>
                    ${totalSessions > 1 ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 4px;">Progress (first ‚Üí most recent)</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${improvementColor};">
                                ${firstAvgReps.toFixed(1)} ‚Üí ${lastAvgReps.toFixed(1)} reps
                                <span style="font-size: 14px; margin-left: 8px;">(${improvement > 0 ? '+' : ''}${improvement}%)</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderProgressChart(sessions) {
            const container = document.getElementById('progress-chart');

            // Simple text-based chart showing trend
            const last10 = sessions.slice(-10);
            const maxReps = Math.max(...last10.map(s => s.sets.reduce((sum, set) => sum + (set.reps || 0), 0) / s.sets.length));

            const chartHtml = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">Recent Trend (Last ${last10.length} Sessions)</div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        ${last10.map((session, idx) => {
                            const avgReps = session.sets.reduce((sum, set) => sum + (set.reps || 0), 0) / session.sets.length;
                            const barWidth = (avgReps / maxReps * 100).toFixed(1);
                            const date = new Date(session.date).toLocaleDateString();
                            return `
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                                    <div style="width: 70px; color: var(--text-secondary); flex-shrink: 0;">${date}</div>
                                    <div style="flex: 1; background: rgba(0,122,255,0.1); border-radius: 4px; height: 24px; position: relative;">
                                        <div style="background: var(--ios-blue); border-radius: 4px; height: 100%; width: ${barWidth}%; transition: width 0.3s;"></div>
                                        <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-weight: 600; color: var(--text-primary);">${avgReps.toFixed(1)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = chartHtml;
        }

        function renderProgressSessions(sessions) {
            const container = document.getElementById('progress-sessions');

            const sessionsHtml = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 12px; color: var(--ios-blue);">Session History</div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${sessions.slice().reverse().map((session, idx) => {
                            const date = new Date(session.date);
                            const totalReps = session.sets.reduce((sum, set) => sum + (set.reps || 0), 0);
                            const avgReps = (totalReps / session.sets.length).toFixed(1);

                            return `
                                <div style="padding: 8px; border-bottom: 1px solid var(--border-color); ${idx === 0 ? 'background: rgba(0,122,255,0.05);' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <div style="font-weight: 600; font-size: 13px;">${date.toLocaleDateString()}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        ${session.sets.length} sets √ó ${avgReps} avg reps = ${totalReps} total reps
                                    </div>
                                    ${session.notes ? `<div style="font-size: 11px; color: var(--ios-gray); margin-top: 4px; font-style: italic;">"${session.notes}"</div>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = sessionsHtml;
        }

        // Modal Functions
        function showExerciseModal() {
            populateExerciseSelect();
            applyLibraryEntryToForm(currentExercise.id);
            document.getElementById('exercise-modal').classList.add('active');
            haptic('medium');
        }

        function closeExerciseModal() {
            document.getElementById('exercise-modal').classList.remove('active');
            haptic('medium');
        }

        function updateTargetLabel() {
            const type = document.getElementById('exercise-type').value;
            const targetInput = document.getElementById('target-input');

            const placeholders = {
                timed: 'Seconds per rep (timed reps)',
                hold: 'Seconds to hold',
                duration: 'Seconds per set (duration)',
                amrap: 'AMRAP window (seconds, optional)',
                distance: 'Distance goal (steps/meters)',
                reps: 'Target (seconds optional)'
            };

            targetInput.placeholder = placeholders[type] || 'Target (seconds or distance)';
            targetInput.disabled = type === 'reps';
        }

        function updateExerciseType() {
            const select = document.getElementById('exercise-select');
            applyLibraryEntryToForm(select.value);
        }

        function saveExercise() {
            const select = document.getElementById('exercise-select');
            const exerciseName = select.options[select.selectedIndex].text;
            const exerciseId = select.value;
            const type = document.getElementById('exercise-type').value;
            const sets = parseInt(document.getElementById('sets-input').value);
            const reps = parseInt(document.getElementById('reps-input').value);
            const seconds = parseInt(document.getElementById('target-input').value);

            if (!sets) {
                alert('Please enter a valid number for sets.');
                return;
            }

            if (COUNTER_TYPES.includes(type) && type !== 'amrap' && (!reps && reps !== 0)) {
                alert('Please enter a valid number for reps/distance.');
                return;
            }

            if (type === 'distance' && (!reps || reps <= 0)) {
                alert('Please enter a distance goal.');
                return;
            }

            if (isTimerType(type) && (!seconds || seconds <= 0)) {
                alert('Please enter seconds for the timer-based exercise.');
                return;
            }

            const entry = getLibraryEntryById(exerciseId);
            const nextSpec = {
                type: type,
                sets: sets,
                repsPerSet: reps,
                secondsPerRep: (isTimerType(type) || type === 'amrap') ? (seconds || 0) : 0
            };

            const prevSpec = entry.current || {};
            if (
                prevSpec.type !== nextSpec.type ||
                prevSpec.sets !== nextSpec.sets ||
                prevSpec.repsPerSet !== nextSpec.repsPerSet ||
                (prevSpec.secondsPerRep ?? null) !== (nextSpec.secondsPerRep ?? null)
            ) {
                recordRevision(entry, nextSpec, 'Manual exercise update');
            } else {
                entry.current = nextSpec;
                persistExerciseLibrary();
            }

            exerciseLibrary = loadExerciseLibrary();
            currentExercise = toSessionExercise({ ...entry, name: exerciseName, id: exerciseId });

            // Remember this exercise for next session
            localStorage.setItem(LAST_EXERCISE_KEY, exerciseId);

            seedTimerSeconds();
            stopTimer();

            haptic('success');
            updateDisplay();
            closeExerciseModal();
        }

        function showHistory() {
            if (!currentExercise) {
                alert('Please select an exercise first');
                return;
            }
            renderHistory();
            document.getElementById('history-modal').classList.add('active');
            haptic('medium');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.remove('active');
            haptic('medium');
        }

        function describeSpec(spec) {
            if (!spec) return 'No spec available';
            const parts = [
                `${spec.sets || 0} sets`,
                spec.type === 'timed' ? `${spec.repsPerSet || 0} reps √ó ${spec.secondsPerRep || 0}s` : `${spec.repsPerSet || 0} reps`
            ];
            return parts.join(' ¬∑ ');
        }

        function renderHistory() {
            const sessions = loadHistory();
            const exerciseHistoryList = document.getElementById('exercise-history-list');
            const sessionHistoryList = document.getElementById('session-history-list');
            const exerciseEntry = getLibraryEntryById(currentExercise.id);

            if (!exerciseEntry.history || exerciseEntry.history.length === 0) {
                exerciseHistoryList.innerHTML = '<div class="history-item">No revisions logged yet.</div>';
            } else {
                exerciseHistoryList.innerHTML = exerciseEntry.history
                    .slice()
                    .reverse()
                    .map(revision => {
                        const supersedesLabel = revision.supersedes && revision.supersedes.length
                            ? `<span class="pill">Supersedes ${revision.supersedes.join(', ')}</span>`
                            : '';
                        return `
                            <div class="history-item">
                                <div>${revision.summary}</div>
                                ${supersedesLabel}
                                <div class="history-meta">${new Date(revision.timestamp).toLocaleString()} ¬∑ ${describeSpec(revision.next)}</div>
                            </div>
                        `;
                    })
                    .join('');
            }

            const relevantSessions = sessions
                .filter(s => (s.exerciseId && s.exerciseId === currentExercise.id) || s.exerciseName === currentExercise.name)
                .slice()
                .reverse();

            if (relevantSessions.length === 0) {
                sessionHistoryList.innerHTML = '<div class="history-item">No sessions tracked yet.</div>';
            } else {
                sessionHistoryList.innerHTML = relevantSessions
                    .slice(0, 10)
                    .map(session => {
                        const totalReps = (session.sets || []).reduce((sum, set) => sum + (set.reps || 0), 0);
                        const sessionLabel = session.exerciseType === 'timed'
                            ? `${session.sets?.length || 0} sets ¬∑ ${session.exerciseType} ¬∑ ${totalReps} reps`
                            : `${session.sets?.length || 0} sets ¬∑ ${totalReps} reps`;

                        // Show side info for unilateral exercises and weight/resistance
                        const setDetails = (session.sets || []).map((set, idx) => {
                            const sideLabel = set.side ? ` (${set.side})` : '';
                            const manualLabel = set.manualLog ? ' üìù' : '';
                            const weightLabel = set.weight ? ` ${set.weight}${set.weightUnit || 'lbs'}` : '';
                            const resistanceLabel = set.resistance ? ` [${set.resistance}]` : '';
                            return `Set ${idx + 1}: ${set.reps}${sideLabel}${weightLabel}${resistanceLabel}${manualLabel}`;
                        }).join(' ¬∑ ');

                        const notesHtml = session.notes ? `<div style="margin-top: 6px; font-style: italic; color: var(--text-secondary);">"${session.notes}"</div>` : '';
                        return `
                            <div class="history-item">
                                <div>${session.exerciseName}</div>
                                <div class="history-meta">${new Date(session.date).toLocaleString()} ¬∑ ${sessionLabel}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${setDetails}</div>
                                ${notesHtml}
                            </div>
                        `;
                    })
                    .join('');
            }
        }

        // Exercise List Management
        function showExerciseList() {
            renderRecentExercises();
            renderExerciseList();
            renderTagFilters();

            // Show/hide Archive Examples button
            const examples = exerciseLibrary.filter(ex => ex.name.includes('(Example)') && !ex.archived);
            const archiveBtn = document.getElementById('archive-examples-btn');
            if (archiveBtn) {
                archiveBtn.style.display = examples.length > 0 ? 'block' : 'none';
            }

            document.getElementById('exercise-list-modal').classList.add('active');
            haptic('medium');
        }

        function renderRecentExercises() {
            const sessions = loadHistory();
            if (sessions.length === 0) {
                document.getElementById('recent-exercises-container').innerHTML = '';
                return;
            }

            // Get unique exercises from most recent sessions
            const recentExerciseIds = new Set();
            const recentExercises = [];

            sessions.slice().reverse().forEach(session => {
                if (session.exerciseId && !recentExerciseIds.has(session.exerciseId) && recentExercises.length < 5) {
                    recentExerciseIds.add(session.exerciseId);
                    const entry = getLibraryEntryById(session.exerciseId);
                    if (entry) {
                        recentExercises.push(entry);
                    }
                }
            });

            if (recentExercises.length === 0) {
                document.getElementById('recent-exercises-container').innerHTML = '';
                return;
            }

            const container = document.getElementById('recent-exercises-container');
            container.innerHTML = `
                <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">‚ö° Recent Exercises</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                    ${recentExercises.map(ex =>
                        `<button class="pill" style="cursor: pointer; padding: 6px 12px; background: var(--ios-blue); color: white;" onclick="selectExerciseFromList('${ex.id}'); event.stopPropagation();">${ex.name}</button>`
                    ).join('')}
                </div>
            `;
        }

        function closeExerciseList() {
            document.getElementById('exercise-list-modal').classList.remove('active');
            document.getElementById('exercise-search').value = '';
            filterTags = [];
            haptic('medium');
        }

        // DATA EXPORT FUNCTIONS
        function showDataBackup() {
            document.getElementById('data-backup-modal').classList.add('active');
            haptic('medium');
        }

        function closeDataBackup() {
            document.getElementById('data-backup-modal').classList.remove('active');
            haptic('medium');
        }

        // SETTINGS FUNCTIONS
        const PREFERENCES_KEY = 'pt_preferences';
        let preferences = {
            hapticEnabled: true,
            voiceEnabled: true
        };

        function loadPreferences() {
            try {
                const stored = localStorage.getItem(PREFERENCES_KEY);
                if (stored) {
                    preferences = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Failed to load preferences:', e);
            }
            // Update UI toggles
            document.getElementById('haptic-toggle').checked = preferences.hapticEnabled;
            document.getElementById('voice-toggle').checked = preferences.voiceEnabled;
        }

        function savePreferences() {
            localStorage.setItem(PREFERENCES_KEY, JSON.stringify(preferences));
        }

        function showSettings() {
            loadPreferences();
            document.getElementById('settings-modal').classList.add('active');
            haptic('medium');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
            haptic('medium');
        }

        function toggleHaptic() {
            preferences.hapticEnabled = document.getElementById('haptic-toggle').checked;
            savePreferences();
            haptic('light');
        }

        function toggleVoice() {
            preferences.voiceEnabled = document.getElementById('voice-toggle').checked;
            savePreferences();
            haptic('light');
        }

        // DOSAGE PROMPT FUNCTIONS
        let pendingExerciseImport = null;

        function showDosagePrompt(exercise) {
            pendingExerciseImport = exercise;

            document.getElementById('dosage-exercise-name').textContent = exercise.canonical_name;
            document.getElementById('dosage-sets').value = '';
            document.getElementById('dosage-reps').value = '';
            document.getElementById('dosage-seconds').value = '';

            // Show seconds field for hold exercises
            const isHold = exercise.pattern_modifiers && exercise.pattern_modifiers.includes('hold_seconds');
            const secondsContainer = document.getElementById('dosage-seconds-container');
            if (isHold) {
                secondsContainer.style.display = 'block';
            } else {
                secondsContainer.style.display = 'none';
            }

            document.getElementById('dosage-prompt-modal').classList.add('active');
            haptic('medium');
        }

        function closeDosagePrompt() {
            document.getElementById('dosage-prompt-modal').classList.remove('active');
            pendingExerciseImport = null;
            haptic('medium');
        }

        function confirmDosage() {
            const sets = parseInt(document.getElementById('dosage-sets').value);
            const reps = parseInt(document.getElementById('dosage-reps').value);
            const seconds = parseInt(document.getElementById('dosage-seconds').value) || 0;

            if (!sets || !reps || sets < 1 || reps < 1) {
                alert('Please enter valid sets and reps');
                return;
            }

            if (!pendingExerciseImport) return;

            const ex = pendingExerciseImport;
            const isHold = ex.pattern_modifiers && ex.pattern_modifiers.includes('hold_seconds');

            if (isHold && (!seconds || seconds < 1)) {
                alert('Please enter valid seconds for this hold exercise');
                return;
            }

            // Import the exercise with the specified dosage
            const isBilateral = ex.pattern === 'both';
            const sideOptions = ex.pattern === 'side' ? ['left', 'right'] : [];
            const simpleTags = ex.tags.functional || [];
            const equipmentList = ex.equipment.required || [];

            const newExercise = {
                id: ex.exercise_id,
                name: ex.canonical_name,
                description: ex.description,
                pt_category: ex.pt_category,
                primary_muscles: ex.primary_muscles,
                secondary_muscles: ex.secondary_muscles,
                pattern: ex.pattern,
                pattern_modifiers: ex.pattern_modifiers,
                equipment: equipmentList,
                equipmentOptional: ex.equipment.optional || [],
                guidance: ex.guidance,
                tags: simpleTags,
                bilateral: isBilateral,
                sideOptions: sideOptions,
                primaryMuscles: ex.primary_muscles.join(', '),
                anatomicRegions: ex.tags.heatmap ? ex.tags.heatmap.join(', ') : '',
                difficulty: '',
                supersedes: [],
                atlasUrl: '',
                current: {
                    type: isHold ? 'hold' : 'reps',
                    sets: sets,
                    repsPerSet: reps,
                    secondsPerRep: seconds
                },
                history: [
                    {
                        timestamp: new Date().toISOString(),
                        summary: `Imported from exercise library (${sets} sets √ó ${reps} reps${isHold ? ` √ó ${seconds}s` : ''})`,
                        previous: {},
                        next: {
                            type: isHold ? 'hold' : 'reps',
                            sets: sets,
                            repsPerSet: reps,
                            secondsPerRep: seconds
                        },
                        supersedes: []
                    }
                ],
                favorite: false,
                archived: false
            };

            exerciseLibrary.push(newExercise);
            persistExerciseLibrary();

            closeDosagePrompt();
            closeExerciseDetail();
            closeLibraryBrowser();

            const patternMsg = ex.pattern === 'side'
                ? 'üîÑ Side tracking enabled: Will log left and right separately'
                : '‚úì Bilateral exercise: Both sides work together';
            alert(`"${ex.canonical_name}" added to your program!\n\n${sets} sets √ó ${reps} reps${isHold ? ` √ó ${seconds}s` : ''}\n\n${patternMsg}`);
            haptic('success');
        }

        function exportExerciseLibrary() {
            const stored = localStorage.getItem(LIBRARY_KEY);
            if (!stored) {
                alert('No exercise library data found.');
                return;
            }

            try {
                const parsed = JSON.parse(stored);
                const dateStamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `pt_exercise_library-${dateStamp}.json`;
                downloadJSON(parsed, filename);
                haptic('success');
            } catch (e) {
                console.error('Failed to export exercise library:', e);
                alert('Unable to export exercise library. Data may be corrupt.');
            }
        }

        function exportExerciseHistory() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) {
                alert('No exercise history data found.');
                return;
            }

            try {
                const parsed = JSON.parse(stored);
                const dateStamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `pt_exercise_history-${dateStamp}.json`;
                downloadJSON(parsed, filename);
                haptic('success');
            } catch (e) {
                console.error('Failed to export exercise history:', e);
                alert('Unable to export exercise history. Data may be corrupt.');
            }
        }

        function exportAllData() {
            const library = localStorage.getItem(LIBRARY_KEY);
            const history = localStorage.getItem(STORAGE_KEY);
            const version = localStorage.getItem(PT_VERSION_KEY);

            if (!library && !history) {
                alert('No data found to export.');
                return;
            }

            try {
                const allData = {
                    pt_data_version: version || PT_DATA_VERSION,
                    pt_exercise_library: library ? JSON.parse(library) : [],
                    pt_tracker_data: history ? JSON.parse(history) : [],
                    exported_at: new Date().toISOString()
                };

                const dateStamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `pt_all_data-${dateStamp}.json`;
                downloadJSON(allData, filename);
                haptic('success');
            } catch (e) {
                console.error('Failed to export all data:', e);
                alert('Unable to export data. One or more data sources may be corrupt.');
            }
        }

        // Mobile Safari compatible download helper
        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Detect file type and import accordingly
                    if (data.pt_data_version !== undefined && data.pt_exercise_library !== undefined) {
                        // All-data export format
                        importAllData(data);
                    } else if (Array.isArray(data)) {
                        // Individual export format (library or history)
                        // Try to detect which one based on structure
                        if (data.length > 0 && data[0].exerciseId !== undefined) {
                            // History format
                            importHistory(data);
                        } else {
                            // Library format
                            importLibrary(data);
                        }
                    } else {
                        alert('Unrecognized file format. Please use a valid PT Tracker export file.');
                    }
                } catch (e) {
                    console.error('Failed to import file:', e);
                    alert('Unable to read file. Make sure it\'s a valid JSON export.');
                }

                // Reset file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function importAllData(data) {
            const message = `Import all data?\n\nThis will REPLACE:\n‚Ä¢ Exercise library (${data.pt_exercise_library?.length || 0} exercises)\n‚Ä¢ Exercise history (${data.pt_tracker_data?.length || 0} sessions)\n\nCurrent data will be overwritten. Continue?`;

            showActionSheet(message, () => {
                if (data.pt_exercise_library) {
                    localStorage.setItem(LIBRARY_KEY, JSON.stringify(data.pt_exercise_library));
                }
                if (data.pt_tracker_data) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data.pt_tracker_data));
                }
                if (data.pt_data_version) {
                    localStorage.setItem(PT_VERSION_KEY, data.pt_data_version);
                }

                // Reload library and update display
                exerciseLibrary = loadExerciseLibrary();
                closeDataBackup();
                alert('Data imported successfully! Reload the page to see all changes.');
                haptic('success');
            });
        }

        function importLibrary(data) {
            const message = `Import exercise library?\n\nThis will REPLACE your current library with ${data.length} exercises.\n\nCurrent library will be overwritten. Continue?`;

            showActionSheet(message, () => {
                localStorage.setItem(LIBRARY_KEY, JSON.stringify(data));
                exerciseLibrary = loadExerciseLibrary();
                closeDataBackup();
                alert('Exercise library imported successfully!');
                haptic('success');
            });
        }

        function importHistory(data) {
            const message = `Import exercise history?\n\nThis will REPLACE your current history with ${data.length} sessions.\n\nCurrent history will be overwritten. Continue?`;

            showActionSheet(message, () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                closeDataBackup();
                alert('Exercise history imported successfully!');
                haptic('success');
            });
        }

        function renderTagFilters() {
            const container = document.getElementById('tag-filter-container');
            container.innerHTML = AVAILABLE_TAGS.map(tag => {
                const active = filterTags.includes(tag);
                return `<span class="pill" style="cursor: pointer; background: ${active ? 'var(--ios-blue)' : 'rgba(0,122,255,0.1)'}; color: ${active ? 'white' : 'var(--ios-blue)'};" onclick="toggleFilterTag('${tag}')">${tag}</span>`;
            }).join(' ');
        }

        function toggleFilterTag(tag) {
            if (filterTags.includes(tag)) {
                filterTags = filterTags.filter(t => t !== tag);
            } else {
                filterTags.push(tag);
            }
            renderTagFilters();
            filterExercises();
        }

        function filterExercises() {
            const searchTerm = document.getElementById('exercise-search').value.toLowerCase();
            const filtered = exerciseLibrary.filter(ex => {
                const matchesSearch = !searchTerm || ex.name.toLowerCase().includes(searchTerm);
                const matchesTags = filterTags.length === 0 || (ex.tags && filterTags.some(tag => ex.tags.includes(tag)));
                const notArchived = !ex.archived;
                return matchesSearch && matchesTags && notArchived;
            });
            renderExerciseList(filtered);
        }

        function toggleFavorite(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            entry.favorite = !entry.favorite;
            persistExerciseLibrary();
            exerciseLibrary = loadExerciseLibrary();
            renderExerciseList();
            haptic('medium');
        }

        function archiveExercise(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            showActionSheet(`Archive "${entry.name}"? You can restore it later from archived exercises.`, () => {
                entry.archived = true;
                persistExerciseLibrary();
                exerciseLibrary = loadExerciseLibrary();
                renderExerciseList();
                haptic('success');
            });
        }

        let viewingArchived = false;

        function showArchivedExercises() {
            viewingArchived = !viewingArchived;
            const btn = document.getElementById('archived-btn');

            if (viewingArchived) {
                const archived = exerciseLibrary.filter(ex => ex.archived);
                btn.textContent = '‚Üê Back';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                renderArchivedList(archived);
            } else {
                btn.textContent = 'üì¶ Archived';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                renderExerciseList();
            }
        }

        function renderArchivedList(archivedExercises) {
            const container = document.getElementById('exercise-list-content');

            if (archivedExercises.length === 0) {
                container.innerHTML = '<div class="history-item">No archived exercises.</div>';
                return;
            }

            container.innerHTML = archivedExercises.map(ex => {
                const spec = ex.current || {};
                return `
                    <div class="history-item">
                        <div>${ex.name}</div>
                        <div class="history-meta">${describeSpec(spec)}</div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button class="control-btn btn-success" onclick="unarchiveExercise('${ex.id}'); event.stopPropagation();" style="flex: 1; padding: 8px; font-size: 14px;">Restore</button>
                            <button class="control-btn btn-danger" onclick="permanentlyDeleteExercise('${ex.id}'); event.stopPropagation();" style="flex: 1; padding: 8px; font-size: 14px;">Delete Forever</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function unarchiveExercise(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            entry.archived = false;
            persistExerciseLibrary();
            exerciseLibrary = loadExerciseLibrary();
            haptic('success');
            speak('Exercise restored');
            showArchivedExercises(); // Refresh archived view
        }

        function permanentlyDeleteExercise(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            showActionSheet(`PERMANENTLY delete "${entry.name}"? This cannot be undone!`, () => {
                exerciseLibrary = exerciseLibrary.filter(ex => ex.id !== exerciseId);
                persistExerciseLibrary();
                exerciseLibrary = loadExerciseLibrary();
                haptic('success');
                showArchivedExercises(); // Refresh archived view
            });
        }

        function archiveExamples() {
            const examples = exerciseLibrary.filter(ex => ex.name.includes('(Example)') && !ex.archived);

            if (examples.length === 0) {
                alert('No example exercises found to archive.');
                return;
            }

            const message = `Archive ${examples.length} example exercise${examples.length !== 1 ? 's' : ''}?\n\n${examples.map(ex => ex.name).join('\n')}\n\nYou can restore them from the Archived section later.`;

            showActionSheet(message, () => {
                examples.forEach(ex => {
                    ex.archived = true;
                });
                persistExerciseLibrary();
                exerciseLibrary = loadExerciseLibrary();
                filterExercises(); // Refresh the list
                haptic('success');
                alert(`${examples.length} example${examples.length !== 1 ? 's' : ''} archived successfully!`);

                // Hide the button if no more examples
                const remainingExamples = exerciseLibrary.filter(ex => ex.name.includes('(Example)') && !ex.archived);
                if (remainingExamples.length === 0) {
                    document.getElementById('archive-examples-btn').style.display = 'none';
                }
            });
        }

        function renderExerciseList(filteredLibrary = null) {
            let list = filteredLibrary || exerciseLibrary.filter(ex => !ex.archived);
            const container = document.getElementById('exercise-list-content');

            if (list.length === 0) {
                container.innerHTML = '<div class="history-item">No exercises found.</div>';
                return;
            }

            // Sort: favorites first, then by last used, then alphabetically
            const sessions = loadHistory();
            list = list.slice().sort((a, b) => {
                // Favorites first
                if (a.favorite && !b.favorite) return -1;
                if (!a.favorite && b.favorite) return 1;

                // Then by most recently used
                const aSession = sessions.filter(s => s.exerciseId === a.id).pop();
                const bSession = sessions.filter(s => s.exerciseId === b.id).pop();
                const aDate = aSession ? new Date(aSession.date).getTime() : 0;
                const bDate = bSession ? new Date(bSession.date).getTime() : 0;
                if (aDate !== bDate) return bDate - aDate;

                // Then alphabetically
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = list.map(ex => {
                const spec = ex.current || {};
                const tags = ex.tags || [];
                const tagHtml = tags.length ? tags.map(t => `<span class="pill">${t}</span>`).join('') : '';
                const hasDetails = ex.details && (ex.details.description || ex.details.executionTips);
                const detailsIndicator = hasDetails ? ' üìã' : '';

                // Calculate quick stats and adherence
                const exerciseSessions = sessions.filter(s => s.exerciseId === ex.id || s.exerciseName === ex.name);
                const totalSessions = exerciseSessions.length;
                const lastSession = exerciseSessions.length ? new Date(exerciseSessions[exerciseSessions.length - 1].date) : null;

                // PT Adherence indicators
                let adherenceColor = '#999';
                let adherenceText = '';
                let adherenceIcon = '';

                if (lastSession) {
                    const daysSince = Math.floor((Date.now() - lastSession.getTime()) / (1000 * 60 * 60 * 24));
                    if (daysSince === 0) {
                        adherenceText = 'Done today ‚úì';
                        adherenceColor = '#34C759';
                    } else if (daysSince <= 3) {
                        adherenceText = `${daysSince} day${daysSince > 1 ? 's' : ''} ago`;
                        adherenceColor = '#34C759';
                    } else if (daysSince <= 7) {
                        adherenceText = `${daysSince} days ago`;
                        adherenceColor = '#FF9500';
                        adherenceIcon = '‚ö†Ô∏è ';
                    } else {
                        adherenceText = `${daysSince} days ago`;
                        adherenceColor = '#FF3B30';
                        adherenceIcon = '‚ùó ';
                    }
                } else {
                    adherenceText = 'Never done';
                    adherenceColor = '#8E8E93';
                    adherenceIcon = '‚óã ';
                }

                const statsHtml = `<div style="font-size: 12px; color: ${adherenceColor}; margin-top: 4px; font-weight: 600;">${adherenceIcon}${adherenceText}${totalSessions > 0 ? ` ¬∑ ${totalSessions} session${totalSessions > 1 ? 's' : ''} total` : ''}</div>`;

                return `
                    <div class="history-item" style="cursor: pointer; border-left: 4px solid ${adherenceColor};">
                        <div onclick="selectExerciseFromList('${ex.id}')">${ex.name}${detailsIndicator}</div>
                        ${tagHtml ? `<div style="margin-top: 4px;">${tagHtml}</div>` : ''}
                        <div class="history-meta">${describeSpec(spec)}</div>
                        ${statsHtml}
                        <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="control-btn ${ex.favorite ? 'btn-primary' : 'btn-secondary'}" onclick="toggleFavorite('${ex.id}'); event.stopPropagation();" style="flex: 0 0 auto; padding: 8px 12px; font-size: 18px;">${ex.favorite ? '‚≠ê' : '‚òÜ'}</button>
                            ${totalSessions > 0 ? `<button class="control-btn btn-success" onclick="showExerciseProgress('${ex.id}'); event.stopPropagation();" style="flex: 1; padding: 8px; font-size: 14px;">üìä Progress</button>` : ''}
                            <button class="control-btn btn-secondary" onclick="showExerciseDetailsModal('${ex.id}'); event.stopPropagation();" style="flex: 1; padding: 8px; font-size: 14px;">Details</button>
                            <button class="control-btn btn-secondary" onclick="editExerciseFromList('${ex.id}'); event.stopPropagation();" style="flex: 1; padding: 8px; font-size: 14px;">Edit</button>
                            <button class="control-btn btn-danger" onclick="archiveExercise('${ex.id}'); event.stopPropagation();" style="flex: 1; padding: 8px; font-size: 14px;">Archive</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectExerciseFromList(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            currentExercise = toSessionExercise(entry);

            // Remember this exercise for next session
            localStorage.setItem(LAST_EXERCISE_KEY, exerciseId);

            seedTimerSeconds();
            stopTimer();
            updateDisplay();
            closeExerciseList();
            haptic('success');

            // Announce last session info if available
            const sessions = loadHistory();
            const lastSession = sessions.filter(s => s.exerciseId === exerciseId).pop();
            if (lastSession) {
                const daysSince = Math.floor((Date.now() - new Date(lastSession.date).getTime()) / (1000 * 60 * 60 * 24));
                if (daysSince === 0) {
                    speak('Last session: today');
                } else if (daysSince === 1) {
                    speak('Last session: yesterday');
                } else if (daysSince < 7) {
                    speak(`Last session: ${daysSince} days ago`);
                }
            }
        }

        function showAddExerciseModal() {
            editingExerciseId = null;
            selectedTags = [];
            selectedSideOptions = [];
            selectedSupersedes = [];
            document.getElementById('add-exercise-title').textContent = 'Add Exercise';
            document.getElementById('new-exercise-name').value = '';
            document.getElementById('new-exercise-type').value = 'reps';
            document.getElementById('new-sets').value = '3';
            document.getElementById('new-reps').value = '10';
            document.getElementById('new-seconds').value = '';
            document.getElementById('bilateral-checkbox').checked = false;
            document.getElementById('primary-muscles').value = '';
            document.getElementById('anatomic-regions').value = '';
            document.getElementById('equipment-select').selectedIndex = -1;
            document.getElementById('difficulty-select').value = '';
            renderTagSelector();
            renderSideOptionsSelector();
            renderSupersedesSelector();
            document.getElementById('add-exercise-modal').classList.add('active');
            haptic('medium');
        }

        function closeAddExerciseModal() {
            document.getElementById('add-exercise-modal').classList.remove('active');
            haptic('medium');
        }

        function renderTagSelector() {
            const container = document.getElementById('tag-selector-container');
            container.innerHTML = '<div style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Tags (body parts):</div>' +
                AVAILABLE_TAGS.map(tag => {
                    const active = selectedTags.includes(tag);
                    return `<span class="pill" style="cursor: pointer; background: ${active ? 'var(--ios-blue)' : 'rgba(0,122,255,0.1)'}; color: ${active ? 'white' : 'var(--ios-blue)'};" onclick="toggleTag('${tag}')">${tag}</span>`;
                }).join(' ');
        }

        function toggleTag(tag) {
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
            } else {
                selectedTags.push(tag);
            }
            renderTagSelector();
        }

        function renderSideOptionsSelector() {
            const container = document.getElementById('side-options-container');
            const isBilateral = document.getElementById('bilateral-checkbox').checked;

            if (isBilateral) {
                container.innerHTML = '<div style="font-size: 13px; color: var(--ios-gray); font-style: italic;">Side tracking disabled (bilateral exercise)</div>';
                selectedSideOptions = [];
                return;
            }

            const hasSelection = selectedSideOptions.length > 0;
            let helpText;
            if (selectedSideOptions.length === 2 && selectedSideOptions.includes('left') && selectedSideOptions.includes('right')) {
                helpText = '‚úì Will log left and right separately (e.g., clams)';
            } else if (selectedSideOptions.length === 1) {
                helpText = `‚úì Will ask which ${selectedSideOptions[0]} side when logging`;
            } else if (selectedSideOptions.length === 3) {
                helpText = '‚úì Will ask which side (left/right/both)';
            } else {
                helpText = '‚ö†Ô∏è Tap which sides - select BOTH for exercises like clams';
            }

            container.innerHTML = `
                <div style="background: var(--bg-primary); padding: 8px; border-radius: 6px;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">Tap which sides this exercise uses:</div>
                    <div style="font-size: 12px; color: ${hasSelection ? 'var(--ios-green)' : 'var(--ios-orange)'}; margin-bottom: 8px;">${helpText}</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${SIDE_OPTIONS_AVAILABLE.map(side => {
                            const active = selectedSideOptions.includes(side);
                            return `<span class="pill" style="cursor: pointer; background: ${active ? 'var(--ios-blue)' : 'rgba(0,122,255,0.1)'}; color: ${active ? 'white' : 'var(--ios-blue)'}; padding: 8px 16px; font-weight: 600;" onclick="toggleSideOption('${side}')">${side}</span>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function toggleSideOption(side) {
            if (selectedSideOptions.includes(side)) {
                selectedSideOptions = selectedSideOptions.filter(s => s !== side);
            } else {
                selectedSideOptions.push(side);
            }
            renderSideOptionsSelector();
        }

        function renderSupersedesSelector() {
            const container = document.getElementById('supersedes-selector-container');

            // Get all exercises except the one being edited
            const availableExercises = exerciseLibrary.filter(ex => {
                // Don't show archived exercises
                if (ex.archived) return false;
                // Don't show the exercise being edited
                if (editingExerciseId && ex.id === editingExerciseId) return false;
                return true;
            });

            if (availableExercises.length === 0) {
                container.innerHTML = '<div style="font-size: 13px; color: var(--ios-gray); font-style: italic;">No other exercises available</div>';
                return;
            }

            const hasSelection = selectedSupersedes.length > 0;
            const helpText = hasSelection
                ? `‚úì Replaces ${selectedSupersedes.length} exercise${selectedSupersedes.length > 1 ? 's' : ''}`
                : 'No exercises selected';

            container.innerHTML = `
                <div style="background: var(--bg-primary); padding: 8px; border-radius: 6px;">
                    <div style="font-size: 12px; color: ${hasSelection ? 'var(--ios-green)' : 'var(--ios-gray)'}; margin-bottom: 8px;">${helpText}</div>
                    <div style="max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;">
                        ${availableExercises.map(ex => {
                            const active = selectedSupersedes.includes(ex.id);
                            return `<span class="pill" style="cursor: pointer; background: ${active ? 'var(--ios-blue)' : 'rgba(0,122,255,0.1)'}; color: ${active ? 'white' : 'var(--ios-blue)'}; padding: 6px 12px; font-size: 13px;" onclick="toggleSupersedes('${ex.id}')">${ex.name}${active ? ' ‚úì' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function toggleSupersedes(exerciseId) {
            if (selectedSupersedes.includes(exerciseId)) {
                selectedSupersedes = selectedSupersedes.filter(id => id !== exerciseId);
            } else {
                selectedSupersedes.push(exerciseId);
            }
            renderSupersedesSelector();
        }

        // Update bilateral checkbox listener
        document.addEventListener('DOMContentLoaded', () => {
            const bilateralCheckbox = document.getElementById('bilateral-checkbox');
            if (bilateralCheckbox) {
                bilateralCheckbox.addEventListener('change', renderSideOptionsSelector);
            }
        });

        function saveNewExercise() {
            const name = document.getElementById('new-exercise-name').value.trim();
            const type = document.getElementById('new-exercise-type').value;
            const sets = parseInt(document.getElementById('new-sets').value);
            const reps = parseInt(document.getElementById('new-reps').value);
            const seconds = parseInt(document.getElementById('new-seconds').value);
            const isBilateral = document.getElementById('bilateral-checkbox').checked;

            // ATLAS fields
            const primaryMuscles = document.getElementById('primary-muscles').value.trim();
            const anatomicRegions = document.getElementById('anatomic-regions').value.trim();
            const equipmentSelect = document.getElementById('equipment-select');
            const equipment = Array.from(equipmentSelect.selectedOptions).map(opt => opt.value);
            const difficulty = document.getElementById('difficulty-select').value;

            if (!name) {
                alert('Please enter an exercise name.');
                return;
            }

            if (!sets || sets <= 0) {
                alert('Please enter a valid number of sets.');
                return;
            }

            const spec = {
                type: type,
                sets: sets,
                repsPerSet: reps || 0,
                secondsPerRep: seconds || 0
            };

            // Use selectedSupersedes array (exercise IDs)
            const supersedes = selectedSupersedes;

            if (editingExerciseId) {
                // Edit existing
                const entry = getLibraryEntryById(editingExerciseId);
                entry.name = name;
                entry.tags = selectedTags;
                entry.bilateral = isBilateral;
                entry.sideOptions = isBilateral ? [] : selectedSideOptions;
                entry.supersedes = supersedes;
                entry.primaryMuscles = primaryMuscles;
                entry.anatomicRegions = anatomicRegions;
                entry.equipment = equipment;
                entry.difficulty = difficulty;
                entry.favorite = entry.favorite || false; // Preserve favorite status
                recordRevision(entry, spec, 'Manual edit');
            } else {
                // Add new
                const newId = 'ex_' + Date.now();
                const newEntry = {
                    id: newId,
                    name: name,
                    tags: selectedTags,
                    bilateral: isBilateral,
                    sideOptions: isBilateral ? [] : selectedSideOptions,
                    supersedes: supersedes,
                    primaryMuscles: primaryMuscles,
                    anatomicRegions: anatomicRegions,
                    equipment: equipment,
                    difficulty: difficulty,
                    favorite: false,
                    archived: false,
                    current: spec,
                    history: [{
                        timestamp: new Date().toISOString(),
                        summary: 'Exercise created',
                        previous: null,
                        next: spec,
                        supersedes: supersedes
                    }]
                };
                exerciseLibrary.push(newEntry);
                persistExerciseLibrary();
            }

            exerciseLibrary = loadExerciseLibrary();
            renderExerciseList();
            closeAddExerciseModal();
            haptic('success');
        }

        function editExerciseFromList(exerciseId) {
            editingExerciseId = exerciseId;
            const entry = getLibraryEntryById(exerciseId);
            const spec = entry.current || {};

            document.getElementById('add-exercise-title').textContent = 'Edit Exercise';
            document.getElementById('new-exercise-name').value = entry.name;
            document.getElementById('new-exercise-type').value = spec.type || 'reps';
            document.getElementById('new-sets').value = spec.sets || 3;
            document.getElementById('new-reps').value = spec.repsPerSet || 10;
            document.getElementById('new-seconds').value = spec.secondsPerRep || '';
            document.getElementById('bilateral-checkbox').checked = entry.bilateral || false;
            document.getElementById('primary-muscles').value = entry.primaryMuscles || '';
            document.getElementById('anatomic-regions').value = entry.anatomicRegions || '';
            document.getElementById('difficulty-select').value = entry.difficulty || '';

            // Set equipment multi-select
            const equipmentSelect = document.getElementById('equipment-select');
            Array.from(equipmentSelect.options).forEach(opt => {
                opt.selected = (entry.equipment || []).includes(opt.value);
            });

            selectedTags = entry.tags || [];
            selectedSideOptions = entry.sideOptions || [];
            selectedSupersedes = entry.supersedes || [];
            renderTagSelector();
            renderSideOptionsSelector();
            renderSupersedesSelector();
            document.getElementById('add-exercise-modal').classList.add('active');
            haptic('medium');
        }

        function deleteExerciseFromList(exerciseId) {
            const entry = getLibraryEntryById(exerciseId);
            showActionSheet(`Delete "${entry.name}"? This cannot be undone.`, () => {
                exerciseLibrary = exerciseLibrary.filter(ex => ex.id !== exerciseId);
                persistExerciseLibrary();
                exerciseLibrary = loadExerciseLibrary();
                renderExerciseList();
                haptic('success');
            });
        }

        // Exercise Details Modal
        let editingDetailsExerciseId = null;

        function showExerciseDetailsModal(exerciseId = null) {
            if (!exerciseId && !currentExercise) {
                alert('Please select an exercise first');
                return;
            }
            editingDetailsExerciseId = exerciseId || currentExercise.id;
            const entry = getLibraryEntryById(editingDetailsExerciseId);
            const details = entry.details || {};

            document.getElementById('exercise-details-title').textContent = entry.name;
            document.getElementById('exercise-description').value = details.description || '';
            document.getElementById('exercise-tips').value = details.executionTips || '';
            document.getElementById('exercise-feel').value = details.shouldFeel || '';
            document.getElementById('exercise-not-feel').value = details.shouldNotFeel || '';
            document.getElementById('exercise-modifications').value = details.modifications || '';
            document.getElementById('exercise-rest-seconds').value = details.restSeconds || '';

            // Display professional guidance if available (from imported exercises)
            const guidanceSection = document.getElementById('professional-guidance-section');
            const guidanceContent = document.getElementById('professional-guidance-content');

            if (entry.guidance && (entry.guidance.external_cues?.length > 0 || entry.guidance.motor_cues?.length > 0 || entry.guidance.compensation_warnings?.length > 0 || entry.guidance.safety_flags?.length > 0)) {
                let html = '';

                // Show description if available
                if (entry.description) {
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">Description</div>
                            <div style="font-size: 13px; color: var(--ios-gray);">${entry.description}</div>
                        </div>
                    `;
                }

                // External cues
                if (entry.guidance.external_cues && entry.guidance.external_cues.length > 0) {
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">üëÄ External Cues</div>
                            <ul style="font-size: 12px; color: var(--ios-gray); margin: 0; padding-left: 20px;">
                                ${entry.guidance.external_cues.map(cue => `<li style="margin-bottom: 4px;">${cue}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Motor cues
                if (entry.guidance.motor_cues && entry.guidance.motor_cues.length > 0) {
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">üí™ Motor Cues</div>
                            <ul style="font-size: 12px; color: var(--ios-gray); margin: 0; padding-left: 20px;">
                                ${entry.guidance.motor_cues.map(cue => `<li style="margin-bottom: 4px;">${cue}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Compensation warnings
                if (entry.guidance.compensation_warnings && entry.guidance.compensation_warnings.length > 0) {
                    html += `
                        <div style="margin-bottom: 12px;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px; color: var(--ios-orange);">‚ö†Ô∏è Compensation Warnings</div>
                            <ul style="font-size: 12px; color: var(--ios-gray); margin: 0; padding-left: 20px;">
                                ${entry.guidance.compensation_warnings.map(warning => `<li style="margin-bottom: 4px;">${warning}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Safety flags
                if (entry.guidance.safety_flags && entry.guidance.safety_flags.length > 0) {
                    html += `
                        <div style="margin-bottom: 0;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px; color: var(--ios-red);">üõë Safety Flags</div>
                            <ul style="font-size: 12px; color: var(--ios-red); margin: 0; padding-left: 20px;">
                                ${entry.guidance.safety_flags.map(flag => `<li style="margin-bottom: 4px;">${flag}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                guidanceContent.innerHTML = html;
                guidanceSection.style.display = 'block';
            } else {
                guidanceSection.style.display = 'none';
            }

            document.getElementById('exercise-details-modal').classList.add('active');
            haptic('medium');
        }

        function closeExerciseDetailsModal() {
            document.getElementById('exercise-details-modal').classList.remove('active');
            haptic('medium');
        }

        function saveExerciseDetails() {
            const entry = getLibraryEntryById(editingDetailsExerciseId);
            const details = {
                description: document.getElementById('exercise-description').value.trim(),
                executionTips: document.getElementById('exercise-tips').value.trim(),
                shouldFeel: document.getElementById('exercise-feel').value.trim(),
                shouldNotFeel: document.getElementById('exercise-not-feel').value.trim(),
                modifications: document.getElementById('exercise-modifications').value.trim(),
                restSeconds: parseInt(document.getElementById('exercise-rest-seconds').value) || null
            };

            entry.details = details;
            persistExerciseLibrary();
            exerciseLibrary = loadExerciseLibrary();

            closeExerciseDetailsModal();
            haptic('success');
        }

        // Rest Timer
        let restTimerInterval = null;
        let restSecondsRemaining = 0;
        let restSecondsTotal = 0;

        function showRestTimer(seconds) {
            restSecondsTotal = seconds;
            restSecondsRemaining = seconds;
            document.getElementById('rest-countdown').textContent = restSecondsRemaining;
            document.getElementById('rest-progress-bar').style.width = '100%';
            document.getElementById('rest-timer-modal').classList.add('active');
            haptic('medium');

            restTimerInterval = setInterval(() => {
                restSecondsRemaining--;
                document.getElementById('rest-countdown').textContent = restSecondsRemaining;
                const progress = (restSecondsRemaining / restSecondsTotal) * 100;
                document.getElementById('rest-progress-bar').style.width = progress + '%';

                // Countdown beeps
                if (restSecondsRemaining <= 3 && restSecondsRemaining > 0) {
                    playBeep(500, 100);
                    haptic('medium');
                }

                if (restSecondsRemaining <= 0) {
                    clearInterval(restTimerInterval);
                    restTimerInterval = null;
                    playCompletionSound();
                    haptic('success');
                    speak('Rest complete');
                    closeRestTimer();
                }
            }, 1000);
        }

        function closeRestTimer() {
            if (restTimerInterval) {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
            }
            document.getElementById('rest-timer-modal').classList.remove('active');
            haptic('medium');
        }

        function skipRest() {
            if (restTimerInterval) {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
            }
            closeRestTimer();
            haptic('medium');
        }

        // Session Recovery
        const RECOVERY_KEY = 'pt_session_recovery';

        function saveSessionRecovery() {
            if (currentExercise.sessionData.length > 0 || currentExercise.currentSet > 1 || currentExercise.currentRep > 0) {
                const recovery = {
                    exerciseId: currentExercise.id,
                    exerciseName: currentExercise.name,
                    currentSet: currentExercise.currentSet,
                    currentRep: currentExercise.currentRep,
                    sessionData: currentExercise.sessionData,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(RECOVERY_KEY, JSON.stringify(recovery));
            } else {
                localStorage.removeItem(RECOVERY_KEY);
            }
        }

        function checkSessionRecovery() {
            const recoveryData = localStorage.getItem(RECOVERY_KEY);
            if (!recoveryData) return;

            try {
                const recovery = JSON.parse(recoveryData);
                const timeDiff = Date.now() - new Date(recovery.timestamp).getTime();
                const hoursSince = timeDiff / (1000 * 60 * 60);

                // Only offer recovery if less than 24 hours old
                if (hoursSince < 24 && recovery.sessionData.length > 0) {
                    showActionSheet(
                        `Recover incomplete session for "${recovery.exerciseName}"? (${recovery.sessionData.length} sets completed)`,
                        () => {
                            const entry = getLibraryEntryById(recovery.exerciseId);
                            if (entry) {
                                currentExercise = toSessionExercise(entry);
                                currentExercise.currentSet = recovery.currentSet;
                                currentExercise.currentRep = recovery.currentRep;
                                currentExercise.sessionData = recovery.sessionData;
                                seedTimerSeconds();
                                updateDisplay();
                                haptic('success');
                                speak(`Recovered session: Set ${recovery.currentSet}`);
                            } else {
                                localStorage.removeItem(RECOVERY_KEY);
                            }
                        }
                    );
                } else {
                    localStorage.removeItem(RECOVERY_KEY);
                }
            } catch (e) {
                console.warn('Failed to parse recovery data:', e);
                localStorage.removeItem(RECOVERY_KEY);
            }
        }

        // Auto-save recovery every time session data changes
        window.addEventListener('beforeunload', saveSessionRecovery);
        setInterval(saveSessionRecovery, 5000); // Save every 5 seconds

        // PT Export Function
        function exportForPT() {
            const sessions = loadHistory();
            const entry = getLibraryEntryById(currentExercise.id);
            const exerciseSessions = sessions.filter(s => s.exerciseId === currentExercise.id || s.exerciseName === currentExercise.name);

            if (exerciseSessions.length === 0) {
                alert('No sessions to export yet.');
                return;
            }

            let report = `PHYSICAL THERAPY PROGRESS REPORT\n`;
            report += `Generated: ${new Date().toLocaleDateString()}\n`;
            report += `\n${'='.repeat(50)}\n\n`;
            report += `EXERCISE: ${entry.name}\n`;

            // Exercise details
            if (entry.details?.description) {
                report += `Description: ${entry.details.description}\n`;
            }
            if (entry.details?.executionTips) {
                report += `Form: ${entry.details.executionTips}\n`;
            }
            if (entry.tags && entry.tags.length) {
                report += `Body parts: ${entry.tags.join(', ')}\n`;
            }
            if (entry.bilateral !== undefined) {
                report += `Type: ${entry.bilateral ? 'Bilateral' : 'Unilateral'}\n`;
            }

            report += `\n${'='.repeat(50)}\n`;
            report += `SESSION HISTORY (${exerciseSessions.length} sessions)\n`;
            report += `${'='.repeat(50)}\n\n`;

            exerciseSessions.reverse().forEach((session, idx) => {
                const sessionDate = new Date(session.date);
                report += `Session ${exerciseSessions.length - idx} - ${sessionDate.toLocaleDateString()} at ${sessionDate.toLocaleTimeString()}\n`;
                report += `${'-'.repeat(50)}\n`;

                session.sets.forEach((set, setIdx) => {
                    const sideInfo = set.side ? ` (${set.side} side)` : '';
                    const manualInfo = set.manualLog ? ' [manually logged]' : '';
                    report += `  Set ${setIdx + 1}: ${set.reps} reps${sideInfo}${manualInfo}\n`;
                });

                const totalReps = session.sets.reduce((sum, set) => sum + (set.reps || 0), 0);
                report += `  Total: ${session.sets.length} sets, ${totalReps} reps\n`;

                if (session.notes) {
                    report += `  Notes: "${session.notes}"\n`;
                }

                report += `\n`;
            });

            report += `${'='.repeat(50)}\n`;
            report += `SUMMARY\n`;
            report += `${'='.repeat(50)}\n`;
            report += `Total sessions: ${exerciseSessions.length}\n`;

            const allReps = exerciseSessions.flatMap(s => s.sets.map(set => set.reps || 0));
            const avgReps = allReps.length ? (allReps.reduce((a, b) => a + b, 0) / allReps.length).toFixed(1) : 0;
            const maxReps = allReps.length ? Math.max(...allReps) : 0;
            const minReps = allReps.length ? Math.min(...allReps) : 0;

            report += `Average reps per set: ${avgReps}\n`;
            report += `Best set: ${maxReps} reps\n`;
            report += `Lowest set: ${minReps} reps\n`;

            const firstSession = exerciseSessions[exerciseSessions.length - 1];
            const lastSession = exerciseSessions[0];
            const firstAvg = firstSession.sets.reduce((sum, set) => sum + set.reps, 0) / firstSession.sets.length;
            const lastAvg = lastSession.sets.reduce((sum, set) => sum + set.reps, 0) / lastSession.sets.length;
            const improvement = ((lastAvg - firstAvg) / firstAvg * 100).toFixed(1);

            if (exerciseSessions.length > 1) {
                report += `\nProgress: ${improvement > 0 ? '+' : ''}${improvement}% from first to most recent session\n`;
            }

            report += `\n${'='.repeat(50)}\n`;
            report += `END OF REPORT\n`;

            // Copy to clipboard
            navigator.clipboard.writeText(report).then(() => {
                speak('Report copied');
                haptic('success');
                alert('PT report copied to clipboard! You can paste it in a text message or email to your physical therapist.');
            }).catch(() => {
                // Fallback: show in a textarea for manual copy
                const textarea = document.createElement('textarea');
                textarea.value = report;
                textarea.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; font-family: monospace; font-size: 12px; padding: 20px;';
                document.body.appendChild(textarea);
                textarea.select();
                alert('Report generated! Copy this text and share with your PT.');
            });
        }

        // Weekly Summary for PT - Quick Overview
        function exportWeeklySummary() {
            const sessions = loadHistory();
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            const weekSessions = sessions.filter(s => new Date(s.date) >= startOfWeek);

            if (weekSessions.length === 0) {
                alert('No sessions this week yet.');
                return;
            }

            let summary = `PT WEEKLY SUMMARY\n`;
            summary += `Week of ${startOfWeek.toLocaleDateString()}\n`;
            summary += `Generated: ${new Date().toLocaleDateString()}\n\n`;

            summary += `${'='.repeat(40)}\n`;
            summary += `OVERVIEW\n`;
            summary += `${'='.repeat(40)}\n`;
            summary += `Total sessions this week: ${weekSessions.length}\n`;

            // Count unique exercises
            const uniqueExercises = new Set(weekSessions.map(s => s.exerciseId));
            summary += `Exercises performed: ${uniqueExercises.size}\n`;

            // Total work
            const totalSets = weekSessions.reduce((sum, s) => sum + (s.sets?.length || 0), 0);
            const totalReps = weekSessions.reduce((sum, s) => sum + s.sets.reduce((rs, set) => rs + (set.reps || 0), 0), 0);
            summary += `Total sets: ${totalSets}\n`;
            summary += `Total reps: ${totalReps}\n\n`;

            // Group by exercise
            summary += `${'='.repeat(40)}\n`;
            summary += `EXERCISES THIS WEEK\n`;
            summary += `${'='.repeat(40)}\n`;

            const exerciseGroups = {};
            weekSessions.forEach(session => {
                const exName = session.exerciseName;
                if (!exerciseGroups[exName]) {
                    exerciseGroups[exName] = {
                        sessions: [],
                        totalSets: 0,
                        totalReps: 0
                    };
                }
                exerciseGroups[exName].sessions.push(session);
                exerciseGroups[exName].totalSets += session.sets.length;
                exerciseGroups[exName].totalReps += session.sets.reduce((sum, set) => sum + (set.reps || 0), 0);
            });

            Object.keys(exerciseGroups).sort().forEach(exName => {
                const group = exerciseGroups[exName];
                summary += `\n${exName}\n`;
                summary += `  Sessions: ${group.sessions.length}√ó this week\n`;
                summary += `  Total: ${group.totalSets} sets, ${group.totalReps} reps\n`;

                // Show dates
                const dates = group.sessions.map(s => new Date(s.date).toLocaleDateString());
                summary += `  Dates: ${dates.join(', ')}\n`;

                // Show notes if any
                const notes = group.sessions.filter(s => s.notes).map(s => s.notes);
                if (notes.length > 0) {
                    summary += `  Notes: ${notes.join(' | ')}\n`;
                }
            });

            summary += `\n${'='.repeat(40)}\n`;
            summary += `BODY PARTS WORKED\n`;
            summary += `${'='.repeat(40)}\n`;

            // Count body parts
            const bodyParts = {};
            weekSessions.forEach(session => {
                const exercise = getLibraryEntryById(session.exerciseId);
                if (exercise && exercise.tags) {
                    exercise.tags.forEach(tag => {
                        bodyParts[tag] = (bodyParts[tag] || 0) + 1;
                    });
                }
            });

            if (Object.keys(bodyParts).length > 0) {
                Object.keys(bodyParts).sort((a, b) => bodyParts[b] - bodyParts[a]).forEach(part => {
                    summary += `  ${part}: ${bodyParts[part]}√ó this week\n`;
                });
            } else {
                summary += `  (No body part tags set)\n`;
            }

            summary += `\n${'='.repeat(40)}\n`;
            summary += `END OF WEEKLY SUMMARY\n`;

            // Copy to clipboard
            navigator.clipboard.writeText(summary).then(() => {
                speak('Summary copied');
                haptic('success');
                alert('Weekly summary copied! Share with your PT.');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = summary;
                textarea.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; font-family: monospace; font-size: 12px; padding: 20px;';
                document.body.appendChild(textarea);
                textarea.select();
                alert('Weekly summary generated! Copy and share with your PT.');
            });
        }

        // PT-Appropriate Progress Tracking (Weekly Sessions, not daily streaks)
        function calculateWeeklyProgress() {
            const sessions = loadHistory();
            if (sessions.length === 0) return { thisWeek: 0, lastWeek: 0, totalWeeks: 0 };

            const now = new Date();
            const startOfThisWeek = new Date(now);
            startOfThisWeek.setDate(now.getDate() - now.getDay()); // Sunday
            startOfThisWeek.setHours(0, 0, 0, 0);

            const startOfLastWeek = new Date(startOfThisWeek);
            startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);

            const thisWeekSessions = sessions.filter(s => new Date(s.date) >= startOfThisWeek);
            const lastWeekSessions = sessions.filter(s => {
                const date = new Date(s.date);
                return date >= startOfLastWeek && date < startOfThisWeek;
            });

            // Count unique workout weeks
            const uniqueWeeks = new Set();
            sessions.forEach(s => {
                const date = new Date(s.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                uniqueWeeks.add(weekStart.toDateString());
            });

            return {
                thisWeek: thisWeekSessions.length,
                lastWeek: lastWeekSessions.length,
                totalWeeks: uniqueWeeks.size
            };
        }

        function updateStreakDisplay() {
            const { thisWeek, lastWeek, totalWeeks } = calculateWeeklyProgress();
            const display = document.getElementById('streak-display');

            if (thisWeek > 0) {
                display.textContent = `${thisWeek} session${thisWeek > 1 ? 's' : ''} this week`;
                if (thisWeek >= 3) display.textContent += ' üí™';
            } else if (lastWeek > 0) {
                display.textContent = `${lastWeek} last week`;
            } else if (totalWeeks > 0) {
                display.textContent = `${totalWeeks} week${totalWeeks > 1 ? 's' : ''} tracked`;
            } else {
                display.textContent = '';
            }
        }

        // Body Heatmap - Shows which body parts worked recently
        const BODY_PART_COORDS = {
            neck: { top: '8%', left: '40%', width: '20%', height: '8%' },
            shoulder: { top: '16%', left: '20%', width: '60%', height: '10%' },
            arm: { top: '18%', left: '10%', width: '15%', height: '18%' },
            core: { top: '28%', left: '35%', width: '30%', height: '16%' },
            back: { top: '17%', left: '35%', width: '30%', height: '20%' },
            hip: { top: '38%', left: '32%', width: '36%', height: '12%' },
            glute: { top: '44%', left: '32%', width: '36%', height: '10%' },
            leg: { top: '50%', left: '30%', width: '18%', height: '25%' },
            knee: { top: '62%', left: '30%', width: '18%', height: '10%' },
            ankle: { top: '88%', left: '30%', width: '18%', height: '8%' },
            wrist: { top: '34%', left: '8%', width: '12%', height: '6%' },
            elbow: { top: '28%', left: '8%', width: '12%', height: '6%' }
        };

        function getBodyPartHeatLevel(sessions, bodyPart) {
            // Count sessions in last 7 days that worked this body part
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentSessions = sessions.filter(s => new Date(s.date).getTime() > sevenDaysAgo);

            let count = 0;
            recentSessions.forEach(session => {
                const exercise = getLibraryEntryById(session.exerciseId);
                if (!exercise) return;

                // Check tags
                if (exercise.tags && exercise.tags.includes(bodyPart)) count++;

                // Check anatomic regions
                if (exercise.anatomicRegions && exercise.anatomicRegions.toLowerCase().includes(bodyPart)) count++;
            });

            if (count === 0) return 'heat-none';
            if (count <= 2) return 'heat-low';
            if (count <= 4) return 'heat-medium';
            if (count <= 6) return 'heat-high';
            return 'heat-very-high';
        }

        function showBodyHeatmap() {
            const sessions = loadHistory();
            const diagram = document.getElementById('body-diagram');

            // Clear previous overlays
            diagram.innerHTML = '';

            // Add overlays for each body part
            Object.keys(BODY_PART_COORDS).forEach(part => {
                const coords = BODY_PART_COORDS[part];
                const heatLevel = getBodyPartHeatLevel(sessions, part);

                const overlay = document.createElement('div');
                overlay.className = `body-part-overlay ${heatLevel}`;
                overlay.style.top = coords.top;
                overlay.style.left = coords.left;
                overlay.style.width = coords.width;
                overlay.style.height = coords.height;
                overlay.textContent = part === 'leg' ? 'leg' : '';
                overlay.onclick = () => showBodyPartDetails(part, sessions);

                diagram.appendChild(overlay);
            });

            document.getElementById('body-heatmap-modal').classList.add('active');
            document.getElementById('body-part-details').innerHTML = '';
            haptic('medium');
        }

        function closeBodyHeatmap() {
            document.getElementById('body-heatmap-modal').classList.remove('active');
            haptic('medium');
        }

        function showBodyPartDetails(bodyPart, sessions) {
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentSessions = sessions.filter(s => new Date(s.date).getTime() > sevenDaysAgo);

            const relevantExercises = [];
            recentSessions.forEach(session => {
                const exercise = getLibraryEntryById(session.exerciseId);
                if (!exercise) return;

                const matchesTags = exercise.tags && exercise.tags.includes(bodyPart);
                const matchesRegions = exercise.anatomicRegions && exercise.anatomicRegions.toLowerCase().includes(bodyPart);

                if (matchesTags || matchesRegions) {
                    const existing = relevantExercises.find(e => e.id === exercise.id);
                    if (existing) {
                        existing.count++;
                        existing.lastDate = new Date(Math.max(new Date(existing.lastDate), new Date(session.date)));
                    } else {
                        relevantExercises.push({
                            id: exercise.id,
                            name: exercise.name,
                            count: 1,
                            lastDate: new Date(session.date)
                        });
                    }
                }
            });

            const detailsDiv = document.getElementById('body-part-details');

            if (relevantExercises.length === 0) {
                detailsDiv.innerHTML = `
                    <div class="history-list">
                        <div class="history-item">
                            <strong>${bodyPart.toUpperCase()}</strong>
                            <div class="history-meta">No exercises in last 7 days</div>
                        </div>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = `
                    <div class="history-list">
                        <div class="history-item">
                            <strong>${bodyPart.toUpperCase()}</strong>
                            <div style="margin-top: 8px;">
                                ${relevantExercises.map(ex => `
                                    <div style="font-size: 14px; padding: 4px 0;">
                                        ${ex.name} <span class="pill">${ex.count}√ó this week</span>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Last: ${ex.lastDate.toLocaleDateString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            haptic('medium');
        }

        // Quick Exercise Switcher
        function showQuickSwitcher() {
            // If no exercise selected, go straight to exercise list
            if (!currentExercise) {
                showExerciseList();
                return;
            }

            const container = document.getElementById('quick-switcher-list');
            const activeExercises = exerciseLibrary.filter(ex => !ex.archived && (ex.favorite || ex.id === currentExercise.id));

            if (activeExercises.length <= 1) {
                // Show full exercise list if only one active
                showExerciseList();
                return;
            }

            container.innerHTML = activeExercises.map(ex => {
                const isCurrent = ex.id === currentExercise.id;
                return `
                    <div class="history-item" style="cursor: pointer; background: ${isCurrent ? 'rgba(0,122,255,0.1)' : 'white'};" onclick="quickSwitchTo('${ex.id}')">
                        <div>${isCurrent ? '‚ñ∂ ' : ''}${ex.name}${ex.favorite ? ' ‚≠ê' : ''}</div>
                        <div class="history-meta">${describeSpec(ex.current || {})}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('quick-switcher-modal').classList.add('active');
            haptic('medium');
        }

        function closeQuickSwitcher() {
            document.getElementById('quick-switcher-modal').classList.remove('active');
            haptic('medium');
        }

        function quickSwitchTo(exerciseId) {
            if (exerciseId === currentExercise.id) {
                closeQuickSwitcher();
                return;
            }

            // Save current progress before switching
            saveSessionRecovery();

            const entry = getLibraryEntryById(exerciseId);
            currentExercise = toSessionExercise(entry);

            // Remember this exercise for next session
            localStorage.setItem(LAST_EXERCISE_KEY, exerciseId);

            seedTimerSeconds();
            stopTimer();
            updateDisplay();
            closeQuickSwitcher();
            haptic('success');
            speak(`Switched to ${entry.name}`);
        }

        // Exercise Library Browser Functions
        let seedExercises = [];
        let selectedSeedExercise = null;
        let showOnlyNewExercises = true;  // Default: filter out already-imported
        let selectedExercisesForImport = new Set();  // Track checked exercises
        let isLoadingSeedExercises = false;

        async function loadExerciseSeedData() {
            isLoadingSeedExercises = true;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 7000);
                const response = await fetch('exercise_guidance_seed.json', { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                seedExercises = data.exercises || [];
                console.log(`Loaded ${seedExercises.length} exercises from seed data`);
                return seedExercises;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('Exercise seed data request timed out.');
                    alert('Failed to load exercise library:\nRequest timed out.\n\nMake sure exercise_guidance_seed.json is accessible.');
                } else {
                console.error('Failed to load exercise seed data:', error);
                alert(`Failed to load exercise library:\n${error.message}\n\nMake sure exercise_guidance_seed.json is accessible.`);
                }
                seedExercises = [];
                return [];
            } finally {
                isLoadingSeedExercises = false;
            }
        }

        async function showLibraryBrowser() {
            document.getElementById('library-exercises-list').innerHTML = '<div class="history-item">Loading exercise library‚Ä¶</div>';
            document.getElementById('library-browser-modal').classList.add('active');
            if (seedExercises.length === 0) {
                await loadExerciseSeedData();
            }

            selectedExercisesForImport.clear();
            document.getElementById('bulk-import-btn').style.display = 'none';
            renderLibraryExercises();
            haptic('medium');
        }

        function toggleShowOnlyNew() {
            showOnlyNewExercises = document.getElementById('show-new-toggle').checked;
            selectedExercisesForImport.clear();
            document.getElementById('bulk-import-btn').style.display = 'none';
            renderLibraryExercises();
        }

        function toggleExerciseSelection(exerciseId, event) {
            event.stopPropagation();
            if (selectedExercisesForImport.has(exerciseId)) {
                selectedExercisesForImport.delete(exerciseId);
            } else {
                selectedExercisesForImport.add(exerciseId);
            }

            // Show/hide import button based on selection
            const importBtn = document.getElementById('bulk-import-btn');
            importBtn.style.display = selectedExercisesForImport.size > 0 ? 'block' : 'none';

            // Update checkbox state
            const checkbox = document.getElementById(`ex-check-${exerciseId}`);
            if (checkbox) checkbox.checked = selectedExercisesForImport.has(exerciseId);
        }

        function renderLibraryExercises() {
            const container = document.getElementById('library-exercises-list');
            const searchTerm = document.getElementById('library-search').value.toLowerCase();

            if (isLoadingSeedExercises) {
                container.innerHTML = '<div class="history-item">Loading exercise library‚Ä¶</div>';
                return;
            }

            // Filter exercises based on search and "show only new" toggle
            let filtered = seedExercises.filter(ex =>
                ex.canonical_name.toLowerCase().includes(searchTerm) ||
                ex.description.toLowerCase().includes(searchTerm) ||
                ex.primary_muscles.some(m => m.toLowerCase().includes(searchTerm)) ||
                ex.equipment.required.some(e => e.toLowerCase().includes(searchTerm))
            );

            // Apply "show only new" filter
            if (showOnlyNewExercises) {
                filtered = filtered.filter(ex => !exerciseLibrary.find(e => e.id === ex.exercise_id));
            }

            if (filtered.length === 0) {
                const message = showOnlyNewExercises
                    ? 'No new exercises found. Uncheck "Show only new" to see all.'
                    : 'No exercises found in library';
                container.innerHTML = `<div class="history-item">${message}</div>`;
                return;
            }

            container.innerHTML = filtered.map(ex => {
                const patternLabel = ex.pattern === 'side' ? 'üîÑ Sided' : '‚úì Bilateral';
                const patternColor = ex.pattern === 'side' ? 'var(--ios-blue)' : 'var(--ios-green)';
                const equipmentLabel = ex.equipment.required.length > 0
                    ? ex.equipment.required.join(', ')
                    : 'No equipment';

                const alreadyImported = exerciseLibrary.find(e => e.id === ex.exercise_id);
                const isChecked = selectedExercisesForImport.has(ex.exercise_id);
                const checkboxDisabled = alreadyImported && !showOnlyNewExercises;

                return `
                    <div class="history-item" style="display: flex; gap: 12px; align-items: start; ${alreadyImported && !showOnlyNewExercises ? 'opacity: 0.5;' : ''}">
                        <input type="checkbox"
                               id="ex-check-${ex.exercise_id}"
                               ${isChecked ? 'checked' : ''}
                               ${checkboxDisabled ? 'disabled' : ''}
                               onclick="toggleExerciseSelection('${ex.exercise_id}', event)"
                               style="width: 20px; height: 20px; margin-top: 2px; cursor: ${checkboxDisabled ? 'not-allowed' : 'pointer'};">
                        <div style="flex: 1; cursor: pointer;" onclick="showExerciseDetail('${ex.exercise_id}')">
                            <div style="font-weight: 600; margin-bottom: 4px;">
                                ${ex.canonical_name}
                                ${alreadyImported && !showOnlyNewExercises ? '<span style="font-size: 11px; color: var(--ios-green); margin-left: 6px;">‚úì Imported</span>' : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--ios-gray); margin-bottom: 4px;">${ex.description.substring(0, 100)}${ex.description.length > 100 ? '...' : ''}</div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                                <span class="pill" style="background: ${patternColor}; color: white; font-size: 11px; padding: 4px 8px;">${patternLabel}</span>
                                <span class="pill" style="background: rgba(0,122,255,0.1); color: var(--ios-blue); font-size: 11px; padding: 4px 8px;">üì¶ ${equipmentLabel}</span>
                                <span class="pill" style="background: rgba(0,122,255,0.1); color: var(--ios-blue); font-size: 11px; padding: 4px 8px;">üí™ ${ex.primary_muscles.length} muscles</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterLibraryExercises() {
            renderLibraryExercises();
        }

        function showExerciseDetail(exerciseId) {
            selectedSeedExercise = seedExercises.find(ex => ex.exercise_id === exerciseId);
            if (!selectedSeedExercise) return;

            const ex = selectedSeedExercise;
            document.getElementById('exercise-detail-title').textContent = ex.canonical_name;

            const detailContent = `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Description</div>
                    <div style="font-size: 14px; color: var(--ios-gray);">${ex.description}</div>
                </div>

                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Pattern</div>
                    <div style="font-size: 14px;">
                        <span class="pill" style="background: ${ex.pattern === 'side' ? 'var(--ios-blue)' : 'var(--ios-green)'}; color: white;">
                            ${ex.pattern === 'side' ? 'üîÑ Sided Exercise (work left and right separately)' : '‚úì Bilateral Exercise (both sides together)'}
                        </span>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Primary Muscles</div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${ex.primary_muscles.map(m => `<span class="pill" style="background: rgba(0,122,255,0.1); color: var(--ios-blue); font-size: 13px;">${m}</span>`).join('')}
                    </div>
                </div>

                ${ex.secondary_muscles.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Secondary Muscles</div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        ${ex.secondary_muscles.map(m => `<span class="pill" style="background: rgba(0,122,255,0.05); color: var(--ios-gray); font-size: 12px;">${m}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                ${ex.equipment.required.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Equipment Required</div>
                    <div style="font-size: 14px; color: var(--ios-gray);">${ex.equipment.required.join(', ')}</div>
                </div>
                ` : ''}

                ${ex.equipment.optional.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">Optional Equipment</div>
                    <div style="font-size: 14px; color: var(--ios-gray);">${ex.equipment.optional.join(', ')}</div>
                </div>
                ` : ''}

                ${ex.guidance.external_cues.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üëÄ External Cues</div>
                    <ul style="font-size: 13px; color: var(--ios-gray); margin: 0; padding-left: 20px;">
                        ${ex.guidance.external_cues.map(cue => `<li style="margin-bottom: 6px;">${cue}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${ex.guidance.motor_cues.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üí™ Motor Cues</div>
                    <ul style="font-size: 13px; color: var(--ios-gray); margin: 0; padding-left: 20px;">
                        ${ex.guidance.motor_cues.map(cue => `<li style="margin-bottom: 6px;">${cue}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${ex.guidance.compensation_warnings.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--ios-orange);">‚ö†Ô∏è Compensation Warnings</div>
                    <ul style="font-size: 13px; color: var(--ios-gray); margin: 0; padding-left: 20px;">
                        ${ex.guidance.compensation_warnings.map(warning => `<li style="margin-bottom: 6px;">${warning}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${ex.guidance.safety_flags.length > 0 ? `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--ios-red);">üõë Safety Flags</div>
                    <ul style="font-size: 13px; color: var(--ios-red); margin: 0; padding-left: 20px;">
                        ${ex.guidance.safety_flags.map(flag => `<li style="margin-bottom: 6px;">${flag}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;

            document.getElementById('exercise-detail-content').innerHTML = detailContent;
            document.getElementById('library-browser-modal').classList.remove('active');
            document.getElementById('exercise-detail-modal').classList.add('active');
            haptic('medium');
        }

        function closeExerciseDetail() {
            document.getElementById('exercise-detail-modal').classList.remove('active');
            document.getElementById('library-browser-modal').classList.add('active');
            haptic('medium');
        }

        function importSeedExercise() {
            if (!selectedSeedExercise) return;

            const ex = selectedSeedExercise;

            // Check if already imported
            if (exerciseLibrary.find(e => e.id === ex.exercise_id)) {
                alert('This exercise is already in your library!');
                return;
            }

            // Show dosage prompt instead of using defaults
            showDosagePrompt(ex);
        }

        function bulkImportExercises() {
            if (selectedExercisesForImport.size === 0) {
                alert('No exercises selected');
                return;
            }

            let importedCount = 0;
            const defaultSets = 3;
            const defaultReps = 10;

            selectedExercisesForImport.forEach(exerciseId => {
                const ex = seedExercises.find(e => e.exercise_id === exerciseId);
                if (!ex) return;

                // Skip if already imported
                if (exerciseLibrary.find(e => e.id === ex.exercise_id)) return;

                const isHold = ex.pattern_modifiers && ex.pattern_modifiers.includes('hold_seconds');
                const isBilateral = ex.pattern === 'both';
                const sideOptions = ex.pattern === 'side' ? ['left', 'right'] : [];
                const simpleTags = ex.tags.functional || [];
                const equipmentList = ex.equipment.required || [];

                const newExercise = {
                    id: ex.exercise_id,
                    name: ex.canonical_name,
                    description: ex.description,
                    pt_category: ex.pt_category,
                    primary_muscles: ex.primary_muscles,
                    secondary_muscles: ex.secondary_muscles,
                    pattern: ex.pattern,
                    pattern_modifiers: ex.pattern_modifiers,
                    equipment: equipmentList,
                    equipmentOptional: ex.equipment.optional || [],
                    guidance: ex.guidance,
                    tags: simpleTags,
                    bilateral: isBilateral,
                    sideOptions: sideOptions,
                    primaryMuscles: ex.primary_muscles.join(', '),
                    anatomicRegions: ex.tags.heatmap ? ex.tags.heatmap.join(', ') : '',
                    difficulty: '',
                    supersedes: [],
                    atlasUrl: '',
                    current: {
                        type: isHold ? 'hold' : 'reps',
                        sets: defaultSets,
                        repsPerSet: defaultReps,
                        secondsPerRep: isHold ? 30 : 0
                    },
                    history: [
                        {
                            timestamp: new Date().toISOString(),
                            summary: `Imported from exercise library with default dosage`,
                            previous: {},
                            next: {
                                type: isHold ? 'hold' : 'reps',
                                sets: defaultSets,
                                repsPerSet: defaultReps,
                                secondsPerRep: isHold ? 30 : 0
                            },
                            supersedes: []
                        }
                    ],
                    favorite: false,
                    archived: false
                };

                exerciseLibrary.push(newExercise);
                importedCount++;
            });

            persistExerciseLibrary();
            selectedExercisesForImport.clear();
            closeLibraryBrowser();

            alert(`Successfully imported ${importedCount} exercise${importedCount !== 1 ? 's' : ''}!\n\n‚ö†Ô∏è Default dosage applied (3 sets √ó 10 reps).\nUpdate each exercise with your PT's prescription.`);
            haptic('success');
        }

        function closeLibraryBrowser() {
            document.getElementById('library-browser-modal').classList.remove('active');
            haptic('medium');
        }

        // Initialize
        loadPreferences(); // Load user preferences
        updateDisplay();
        updateStreakDisplay();
        updateQuickStartShortcuts();
        setTimeout(checkSessionRecovery, 500); // Check for recovery after UI loads

        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw-pt.js')
                    .then(registration => {
                        console.log('PT Tracker SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('PT Tracker SW registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
