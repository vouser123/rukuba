<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PT Editor</title>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDdFofqGJ0vRGHP8yjJJ9V6KwvMB3MiPkc",
            authDomain: "pwa-test-f3cc9.firebaseapp.com",
            projectId: "pwa-test-f3cc9",
            storageBucket: "pwa-test-f3cc9.firebasestorage.app",
            messagingSenderId: "710678875017",
            appId: "1:710678875017:web:f3cc9fc8bce3c85a7e4d97",
            measurementId: "G-Z8SLKX6QD9"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseApp = app;
        window.auth = getAuth(app);
        window.db = getFirestore(app);
    </script>

    <style>
        :root {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F7;
            --bg-tertiary: #E8E8ED;
            --text-primary: #000000;
            --text-secondary: #6E6E73;
            --border-color: #D1D1D6;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-green: #34C759;
            --ios-orange: #FF9500;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #1C1C1E;
                --bg-tertiary: #2C2C2E;
                --text-primary: #FFFFFF;
                --text-secondary: #98989D;
                --border-color: #38383A;
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            min-height: 44px;
            min-width: 44px;
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary {
            background: var(--ios-blue);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--ios-red);
            color: white;
        }

        .btn-primary:active, .btn-secondary:active, .btn-danger:active {
            opacity: 0.7;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--ios-blue);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            min-height: 44px;
            padding: 10px 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 88px;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        .exercise-list-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise-list-item-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .exercise-list-item-info p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .exercise-list-item-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            min-height: 44px;
            min-width: 44px;
            padding: 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .dynamic-field {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .dynamic-field input, .dynamic-field select {
            flex: 1;
        }

        .dynamic-field .remove-btn {
            min-height: 44px;
            min-width: 44px;
            padding: 10px;
            background: var(--ios-red);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        details {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        summary {
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            color: var(--ios-blue);
            margin-bottom: 12px;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::before {
            content: '‚ñ∂';
            display: inline-block;
            transition: transform 0.2s;
        }

        details[open] summary::before {
            transform: rotate(90deg);
        }

        .search-box {
            width: 100%;
            min-height: 44px;
            padding: 10px 16px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        #offline-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            padding-top: calc(12px + env(safe-area-inset-top));
            background: var(--ios-red);
            color: white;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            z-index: 9999;
        }

        #transaction-toast {
            display: none;
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            max-width: 80%;
            text-align: center;
        }

        #transaction-toast.show {
            display: block;
        }

        #transaction-toast button {
            margin-left: 10px;
            background: var(--ios-blue);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            min-height: 28px;
        }

        .help-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offline-indicator">
        üì¥ Offline - Changes saved locally (Queue: <span id="queue-count">0</span>)
    </div>

    <!-- Header -->
    <div class="header">
        <h1>PT Editor</h1>
        <button data-action="goBack" class="btn-secondary">‚Üê Back</button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Exercise Library Browser -->
        <div id="library-section" class="section">
            <h2 class="section-title">Exercise Library</h2>
            <input type="search" id="exercise-search" class="search-box" placeholder="Search exercises...">
            <div id="exercise-list"></div>
            <button data-action="addNewExercise" class="btn-primary" style="width: 100%; margin-top: 12px;">+ Add New Exercise</button>
        </div>

        <!-- Exercise Editor (hidden by default) -->
        <div id="editor-section" style="display: none;">
            <div class="section">
                <h2 class="section-title" id="editor-title">Add New Exercise</h2>

                <!-- Basic Information -->
                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="margin-bottom: 12px; font-size: 16px; color: var(--ios-blue);">üìù Basic Information</h4>

                    <div class="form-group">
                        <label class="form-label" for="ex-name-select">Canonical Name *</label>
                        <select id="ex-name-select" class="form-select">
                            <option value="">-- Select or choose Other --</option>
                        </select>
                        <input type="text" id="ex-name-custom" class="form-input" placeholder="Enter custom exercise name" style="display: none; margin-top: 8px;">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="ex-category">PT Category *</label>
                        <select id="ex-category" class="form-select">
                            <option value="">-- Select --</option>
                            <option value="back_sij">Back/SIJ</option>
                            <option value="knee">Knee</option>
                            <option value="ankle">Ankle</option>
                            <option value="hip">Hip</option>
                            <option value="vestibular">Vestibular</option>
                            <option value="foot">Foot</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="ex-desc">Description *</label>
                        <textarea id="ex-desc" class="form-textarea" placeholder="Clear description of how to perform the exercise"></textarea>
                    </div>
                </div>

                <!-- Muscles -->
                <details>
                    <summary>üí™ Muscles</summary>

                    <div class="form-group">
                        <label class="form-label">Primary Muscles</label>
                        <div id="primary-muscles-list"></div>
                        <button type="button" class="btn-secondary" data-action="addMuscle:primary" style="width: 100%; margin-top: 8px;">+ Add Primary Muscle</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Secondary Muscles</label>
                        <div id="secondary-muscles-list"></div>
                        <button type="button" class="btn-secondary" data-action="addMuscle:secondary" style="width: 100%; margin-top: 8px;">+ Add Secondary Muscle</button>
                    </div>
                </details>

                <!-- Movement Pattern -->
                <details>
                    <summary>üîÑ Movement Pattern</summary>

                    <div class="form-group">
                        <label class="form-label" for="ex-pattern">Pattern *</label>
                        <select id="ex-pattern" class="form-select">
                            <option value="">-- Select --</option>
                            <option value="side">Side (Unilateral)</option>
                            <option value="both">Both (Bilateral)</option>
                        </select>
                        <p class="help-text">side = unilateral, both = bilateral</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Pattern Modifiers</label>
                        <p class="help-text">Structural dosage changes (e.g., duration vs reps)</p>
                        <div id="pattern-modifiers-list">
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="duration_seconds"> duration_seconds
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="hold_seconds"> hold_seconds
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="AMRAP"> AMRAP (As Many Reps As Possible)
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="distance_feet"> distance_feet
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="alternating"> alternating
                            </label>
                        </div>
                    </div>
                </details>

                <!-- Equipment -->
                <details>
                    <summary>üèãÔ∏è Equipment</summary>

                    <div class="form-group">
                        <label class="form-label">Required Equipment</label>
                        <p class="help-text">Equipment intrinsic to the exercise</p>
                        <div id="equipment-required-list"></div>
                        <button type="button" class="btn-secondary" data-action="addEquipment:required" style="width: 100%; margin-top: 8px;">+ Add Required</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Optional Equipment</label>
                        <p class="help-text">Equipment for comfort or modification</p>
                        <div id="equipment-optional-list"></div>
                        <button type="button" class="btn-secondary" data-action="addEquipment:optional" style="width: 100%; margin-top: 8px;">+ Add Optional</button>
                    </div>
                </details>

                <!-- Form Parameters -->
                <details>
                    <summary>üìä Form Parameters</summary>

                    <div class="form-group">
                        <label class="form-label">Form Parameters Required</label>
                        <p class="help-text">Parameters that vary per session (e.g., band color, weight)</p>
                        <div id="form-params-list">
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="eyes"> eyes
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="surface"> surface
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="band_resistance"> band_resistance
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="band_position"> band_position
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="slope"> slope
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="distance"> distance
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="weight"> weight
                            </label>
                            <label style="display: block; margin: 8px 0;">
                                <input type="checkbox" value="strap_position"> strap_position
                            </label>
                        </div>
                    </div>
                </details>

                <!-- Guidance & Cues -->
                <details>
                    <summary>üéØ Guidance & Cues</summary>

                    <div class="form-group">
                        <label class="form-label">External Cues</label>
                        <p class="help-text">Visual checks, setup instructions</p>
                        <div id="external-cues-list"></div>
                        <button type="button" class="btn-secondary" data-action="addCue:external" style="width: 100%; margin-top: 8px;">+ Add External Cue</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Motor Cues</label>
                        <p class="help-text">Internal movement cues, what to feel</p>
                        <div id="motor-cues-list"></div>
                        <button type="button" class="btn-secondary" data-action="addCue:motor" style="width: 100%; margin-top: 8px;">+ Add Motor Cue</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Compensation Warnings</label>
                        <p class="help-text">Common form breakdowns to watch for</p>
                        <div id="compensation-warnings-list"></div>
                        <button type="button" class="btn-secondary" data-action="addCue:compensation" style="width: 100%; margin-top: 8px;">+ Add Warning</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Safety Flags</label>
                        <p class="help-text">When to stop immediately</p>
                        <div id="safety-flags-list"></div>
                        <button type="button" class="btn-secondary" data-action="addCue:safety" style="width: 100%; margin-top: 8px;">+ Add Safety Flag</button>
                    </div>
                </details>

                <!-- Tags -->
                <details>
                    <summary>üè∑Ô∏è Tags</summary>

                    <div class="form-group">
                        <label class="form-label">Functional Tags</label>
                        <p class="help-text">e.g., balance, hip_strength, SIJ_control</p>
                        <div id="tags-functional-list"></div>
                        <button type="button" class="btn-secondary" data-action="addTag:functional" style="width: 100%; margin-top: 8px;">+ Add Functional Tag</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Format Tags</label>
                        <p class="help-text">e.g., standing, supine, sidelying</p>
                        <div id="tags-format-list"></div>
                        <button type="button" class="btn-secondary" data-action="addTag:format" style="width: 100%; margin-top: 8px;">+ Add Format Tag</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Heatmap Tags</label>
                        <p class="help-text">Body-region tags for heat-map visualization</p>
                        <div id="tags-heatmap-list"></div>
                        <button type="button" class="btn-secondary" data-action="addTag:heatmap" style="width: 100%; margin-top: 8px;">+ Add Heatmap Tag</button>
                    </div>
                </details>

                <!-- Lifecycle & Status -->
                <details>
                    <summary>üìÖ Lifecycle & Status</summary>

                    <div class="form-group">
                        <label class="form-label" for="ex-lifecycle-status">Status</label>
                        <select id="ex-lifecycle-status" class="form-select">
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="ex-lifecycle-start">Effective Start Date</label>
                        <input type="date" id="ex-lifecycle-start" class="form-input">
                        <p class="help-text">When this exercise became available</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="ex-lifecycle-end">Effective End Date</label>
                        <input type="date" id="ex-lifecycle-end" class="form-input">
                        <p class="help-text">When discontinued (blank if still active)</p>
                    </div>
                </details>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-secondary" data-action="cancelEdit" style="flex: 1;">Cancel</button>
                    <button class="btn-primary" data-action="saveExercise" style="flex: 2;">üíæ Save Exercise</button>
                </div>
            </div>

            <!-- Role Management -->
            <div class="section">
                <h2 class="section-title">Assign Roles</h2>
                <p class="help-text" style="margin-bottom: 16px;">Define how this exercise contributes to movement capacities in body regions.</p>

                <div class="form-group">
                    <label class="form-label" for="role-exercise-select">Select Exercise *</label>
                    <select id="role-exercise-select" class="form-select">
                        <option value="">-- Choose an exercise --</option>
                    </select>
                </div>

                <div id="current-roles" style="margin: 15px 0;"></div>

                <div id="add-role-form" style="display: none; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px; font-size: 16px;">Add New Role</h4>

                    <div class="form-group">
                        <label class="form-label" for="new-role-region">Region *</label>
                        <select id="new-role-region" class="form-select">
                            <option value="">-- Select region --</option>
                            <option value="core">Core</option>
                            <option value="back">Back</option>
                            <option value="hip">Hip</option>
                            <option value="knee">Knee</option>
                            <option value="ankle">Ankle</option>
                            <option value="foot">Foot</option>
                            <option value="vestibular">Vestibular</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="new-role-capacity">Capacity *</label>
                        <select id="new-role-capacity" class="form-select">
                            <option value="">-- Select capacity --</option>
                            <option value="strength">Strength</option>
                            <option value="control">Control</option>
                            <option value="stability">Stability</option>
                            <option value="tolerance">Tolerance</option>
                            <option value="mobility">Mobility</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="new-role-focus">Focus (optional)</label>
                        <input type="text" id="new-role-focus" class="form-input" placeholder="e.g., extension, abduction">
                        <p class="help-text">Specific focus within the capacity</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="new-role-contribution">Contribution *</label>
                        <select id="new-role-contribution" class="form-select">
                            <option value="">-- Select --</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>

                    <button class="btn-primary" data-action="addRole" style="width: 100%;">‚ûï Add Role</button>
                </div>
            </div>

            <!-- Vocabulary Editor -->
            <!-- COMMENTED OUT - User will consider further
            <div class="section">
                <h2 class="section-title">Update Vocabulary Definitions</h2>

                <div class="form-group">
                    <label class="form-label" for="vocab-category">Category *</label>
                    <select id="vocab-category" class="form-select">
                        <option value="">-- Choose category --</option>
                        <option value="pattern_modifiers">Pattern Modifiers</option>
                        <option value="form_parameters">Form Parameters</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="vocab-term">Term *</label>
                    <select id="vocab-term" class="form-select">
                        <option value="">-- Choose term --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="vocab-definition">Definition *</label>
                    <textarea id="vocab-definition" class="form-textarea" placeholder="Enter the definition"></textarea>
                </div>

                <button class="btn-primary" data-action="updateVocabulary" style="width: 100%;">üíæ Update Definition</button>
            </div>
            -->

            <!-- Dosage Management -->
            <div class="section">
                <h2 class="section-title">Manage Patient Dosages</h2>
                <p class="help-text" style="margin-bottom: 16px;">Set prescribed sets, reps, and parameters for each exercise. Fields adapt to exercise pattern modifiers.</p>

                <div class="form-group">
                    <label class="form-label" for="dosage-exercise-select">Select Exercise *</label>
                    <select id="dosage-exercise-select" class="form-select">
                        <option value="">-- Choose an exercise --</option>
                    </select>
                </div>

                <div id="current-dosage-display" style="margin: 15px 0; display: none;"></div>

                <div id="edit-dosage-form" style="display: none; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px; font-size: 16px;">Update Dosage</h4>

                    <div class="form-group">
                        <label class="form-label" for="dosage-sets">Sets *</label>
                        <input type="number" id="dosage-sets" class="form-input" placeholder="e.g., 3" min="1">
                    </div>

                    <div class="form-group" id="dosage-reps-group">
                        <label class="form-label" for="dosage-reps">Reps (per set) *</label>
                        <input type="number" id="dosage-reps" class="form-input" placeholder="e.g., 10" min="1">
                    </div>

                    <div class="form-group" id="dosage-duration-group" style="display: none;">
                        <label class="form-label" for="dosage-duration">Duration (seconds per set)</label>
                        <input type="number" id="dosage-duration" class="form-input" placeholder="e.g., 30" min="1">
                        <p class="help-text">For exercises with duration_seconds modifier</p>
                    </div>

                    <div class="form-group" id="dosage-hold-group" style="display: none;">
                        <label class="form-label" for="dosage-hold">Hold (seconds per rep)</label>
                        <input type="number" id="dosage-hold" class="form-input" placeholder="e.g., 5" min="1">
                        <p class="help-text">For exercises with hold_seconds modifier</p>
                    </div>

                    <div class="form-group" id="dosage-distance-group" style="display: none;">
                        <label class="form-label" for="dosage-distance">Distance (feet)</label>
                        <input type="number" id="dosage-distance" class="form-input" placeholder="e.g., 100" min="1">
                        <p class="help-text">For exercises with distance_feet modifier</p>
                    </div>

                    <button class="btn-primary" data-action="updateDosage" style="width: 100%;">üíä Update Dosage</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Toast -->
    <div id="transaction-toast">
        <span id="transaction-message">Saved:</span> <span id="transaction-id"></span>
        <button data-action="copyTransactionId">Copy</button>
    </div>

    <!-- Main Script -->
    <script type="module">
        import { doc, getDoc, setDoc, collection, query, where, orderBy, limit as firestoreLimit, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';
        import {
            createExercise,
            updateExercise,
            archiveExercise,
            createRole,
            deleteRole,
            updateVocabulary
        } from './shared/pt_data_api.js';
        import { loadExerciseLibraryShared } from './shared/firestore_shared_data.js';
        import { bindActionHandlers, showTransactionToast, copyTransactionId } from './shared/pt_event_handlers.js';
        import * as ptDataAPI from './shared/pt_data_api.js';
        import { replayQueue } from './shared/offline_queue.js';
        import { ulid } from 'https://cdn.jsdelivr.net/npm/ulid@2.3.0/dist/index.esm.js';

        let exercises = [];
        let currentExercise = null;
        let exerciseRoles = {};

        // Initialize on load
        window.addEventListener('load', async () => {
            // Wait for auth
            window.auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'pt_view.html';
                    return;
                }

                console.log('[PT Editor] User authenticated:', user.uid);

                // Load exercise library
                const library = await loadExerciseLibraryShared();
                exercises = library.exercises || [];
                exerciseRoles = library.exerciseRoles || {};

                console.log('[PT Editor] Loaded', exercises.length, 'exercises');

                // Extract all unique equipment from exercises
                extractAllEquipment();

                // Populate library list
                renderExerciseList();

                // Populate exercise selector for roles
                populateExerciseSelector();

                // Populate exercise selector for dosage
                populateDosageExerciseSelector();
            });
        });

        // Auto-replay offline queue when connection restored
        window.addEventListener('offlinequeue:online', async () => {
            await replayQueue(ptDataAPI);
        });

        // Render exercise list
        function renderExerciseList() {
            const list = document.getElementById('exercise-list');
            const search = document.getElementById('exercise-search').value.toLowerCase();

            const filtered = exercises.filter(ex =>
                ex.canonical_name.toLowerCase().includes(search) ||
                (ex.description && ex.description.toLowerCase().includes(search))
            );

            list.innerHTML = filtered.map(ex => `
                <div class="exercise-list-item">
                    <div class="exercise-list-item-info">
                        <h3>${ex.canonical_name}</h3>
                        <p>${ex.pt_category || ''} ‚Ä¢ ${ex.pattern || ''}</p>
                    </div>
                    <div class="exercise-list-item-actions">
                        <button class="icon-btn" data-action="editExercise:${ex.id}">‚úèÔ∏è</button>
                        <button class="icon-btn" data-action="deleteExercise:${ex.id}">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            // Re-bind action handlers for new elements
            bindActionHandlers(list, actionHandlers);
        }

        // Search handler
        document.getElementById('exercise-search').addEventListener('input', renderExerciseList);

        // Populate exercise selector for roles
        function populateExerciseSelector() {
            const select = document.getElementById('role-exercise-select');
            select.innerHTML = '<option value="">-- Choose an exercise --</option>' +
                exercises.map(ex => `<option value="${ex.id}">${ex.canonical_name}</option>`).join('');

            select.addEventListener('change', loadExerciseRoles);
        }

        // Load roles for selected exercise
        async function loadExerciseRoles() {
            const select = document.getElementById('role-exercise-select');
            const exerciseId = select.value;

            if (!exerciseId) {
                document.getElementById('current-roles').innerHTML = '';
                document.getElementById('add-role-form').style.display = 'none';
                return;
            }

            const roles = exerciseRoles[exerciseId] || [];

            const rolesHtml = roles.length > 0
                ? roles.map((role, idx) => `
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${role.region}</strong> ‚Ä¢ ${role.capacity}${role.focus ? ` (${role.focus})` : ''} ‚Ä¢ <em>${role.contribution}</em>
                        </div>
                        <button class="icon-btn" data-action="deleteRole:${exerciseId}:${idx}" style="background: var(--ios-red); color: white;">üóëÔ∏è</button>
                    </div>
                `).join('')
                : '<p style="color: var(--text-secondary); font-size: 14px;">No roles assigned yet.</p>';

            document.getElementById('current-roles').innerHTML = rolesHtml;
            document.getElementById('add-role-form').style.display = 'block';

            // Re-bind action handlers
            bindActionHandlers(document.getElementById('current-roles'), actionHandlers);
        }

        // Populate exercise selector for dosage
        function populateDosageExerciseSelector() {
            const select = document.getElementById('dosage-exercise-select');
            select.innerHTML = '<option value="">-- Choose an exercise --</option>' +
                exercises.map(ex => `<option value="${ex.id}">${ex.canonical_name}</option>`).join('');

            select.addEventListener('change', loadExerciseDosage);
        }

        // Load dosage for selected exercise
        async function loadExerciseDosage() {
            const select = document.getElementById('dosage-exercise-select');
            const exerciseId = select.value;

            if (!exerciseId) {
                document.getElementById('current-dosage-display').style.display = 'none';
                document.getElementById('edit-dosage-form').style.display = 'none';
                return;
            }

            // Find the exercise to get pattern_modifiers
            const exercise = exercises.find(ex => ex.id === exerciseId);
            if (!exercise) return;

            // Show/hide dosage fields based on pattern_modifiers
            const modifiers = exercise.pattern_modifiers || [];
            const hasDuration = modifiers.includes('duration_seconds');
            const hasHold = modifiers.includes('hold_seconds');
            const hasDistance = modifiers.includes('distance_feet');
            const hasAMRAP = modifiers.includes('AMRAP');

            // Always show sets
            // Show reps by default (hide if special modifiers take precedence)
            document.getElementById('dosage-reps-group').style.display = (!hasDuration && !hasAMRAP) ? 'block' : 'none';
            document.getElementById('dosage-duration-group').style.display = hasDuration ? 'block' : 'none';
            document.getElementById('dosage-hold-group').style.display = hasHold ? 'block' : 'none';
            document.getElementById('dosage-distance-group').style.display = hasDistance ? 'block' : 'none';

            // Fetch dosage from Firestore (separate collection with versions for history)
            try {
                const db = window.db;
                const user = window.auth.currentUser;
                if (!user) return;

                // Query for latest version (orderBy timestamp desc, limit 1)
                const versionsRef = collection(db, `users/${user.uid}/dosages/${exerciseId}/versions`);
                const latestQuery = query(versionsRef, orderBy('timestamp', 'desc'), firestoreLimit(1));
                const querySnapshot = await getDocs(latestQuery);

                let dosageData = null;
                if (!querySnapshot.empty) {
                    dosageData = querySnapshot.docs[0].data();
                }

                // Populate form
                if (dosageData) {
                    document.getElementById('dosage-sets').value = dosageData.sets || '';
                    document.getElementById('dosage-reps').value = dosageData.reps || '';
                    document.getElementById('dosage-duration').value = dosageData.duration_seconds || '';
                    document.getElementById('dosage-hold').value = dosageData.hold_seconds || '';
                    document.getElementById('dosage-distance').value = dosageData.distance_feet || '';

                    document.getElementById('current-dosage-display').innerHTML = `
                        <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px;">
                            <strong>Current Dosage:</strong> ${dosageData.sets} sets
                            ${dosageData.reps ? `, ${dosageData.reps} reps` : ''}
                            ${dosageData.duration_seconds ? `, ${dosageData.duration_seconds}s duration` : ''}
                            ${dosageData.hold_seconds ? `, ${dosageData.hold_seconds}s hold` : ''}
                            ${dosageData.distance_feet ? `, ${dosageData.distance_feet}ft distance` : ''}
                        </div>
                    `;
                    document.getElementById('current-dosage-display').style.display = 'block';
                } else {
                    document.getElementById('dosage-sets').value = '';
                    document.getElementById('dosage-reps').value = '';
                    document.getElementById('dosage-duration').value = '';
                    document.getElementById('dosage-hold').value = '';
                    document.getElementById('dosage-distance').value = '';

                    document.getElementById('current-dosage-display').innerHTML = `
                        <p style="color: var(--text-secondary); font-size: 14px;">No dosage set yet.</p>
                    `;
                    document.getElementById('current-dosage-display').style.display = 'block';
                }

                document.getElementById('edit-dosage-form').style.display = 'block';

            } catch (error) {
                console.error('[Load Dosage] Error:', error);
                alert('Failed to load dosage: ' + error.message);
            }
        }

        // Populate exercise name dropdown with "Other" option
        function populateExerciseNameDropdown() {
            const select = document.getElementById('ex-name-select');
            const uniqueNames = [...new Set(exercises.map(ex => ex.canonical_name))].sort();

            select.innerHTML = '<option value="">-- Select or choose Other --</option>' +
                uniqueNames.map(name => `<option value="${name}">${name}</option>`).join('') +
                '<option value="__other__">Other (custom name)</option>';

            // Add change handler
            select.addEventListener('change', () => {
                const customInput = document.getElementById('ex-name-custom');
                if (select.value === '__other__') {
                    customInput.style.display = 'block';
                    customInput.focus();
                } else {
                    customInput.style.display = 'none';
                }
            });
        }

        // Global equipment options (union from all exercises)
        let allEquipmentOptions = [];

        // Extract all unique equipment from exercises
        function extractAllEquipment() {
            const equipmentSet = new Set();
            exercises.forEach(ex => {
                if (ex.equipment?.required) {
                    ex.equipment.required.forEach(item => equipmentSet.add(item));
                }
                if (ex.equipment?.optional) {
                    ex.equipment.optional.forEach(item => equipmentSet.add(item));
                }
            });
            allEquipmentOptions = Array.from(equipmentSet).sort();
            console.log('[Equipment] Extracted unique equipment:', allEquipmentOptions.length, 'items');
        }

        // Add dynamic field functions
        function addDynamicField(listId, placeholder = '', options = []) {
            const list = document.getElementById(listId);
            const field = document.createElement('div');
            field.className = 'dynamic-field';

            // If options provided, create datalist for autocomplete
            const datalistId = options.length > 0 ? `datalist-${Math.random().toString(36).substr(2, 9)}` : '';
            const datalistHtml = options.length > 0 ? `
                <datalist id="${datalistId}">
                    ${options.map(opt => `<option value="${opt}">`).join('')}
                </datalist>
            ` : '';

            field.innerHTML = `
                <input type="text" class="form-input" placeholder="${placeholder}" ${datalistId ? `list="${datalistId}"` : ''} style="flex: 1;">
                ${datalistHtml}
                <button class="remove-btn" data-action="removeDynamicField">‚úï</button>
            `;
            list.appendChild(field);
            bindActionHandlers(field, actionHandlers);
        }

        // Action handlers
        const actionHandlers = {
            goBack: () => {
                window.location.href = 'pt_view.html';
            },

            addNewExercise: () => {
                currentExercise = null;
                document.getElementById('library-section').style.display = 'none';
                document.getElementById('editor-section').style.display = 'block';
                document.getElementById('editor-title').textContent = 'Add New Exercise';

                // Populate exercise name dropdown
                populateExerciseNameDropdown();

                clearExerciseForm();
            },

            editExercise: (e) => {
                const id = e.target.dataset.action.split(':')[1];
                currentExercise = exercises.find(ex => ex.id === id);
                if (!currentExercise) return;

                document.getElementById('library-section').style.display = 'none';
                document.getElementById('editor-section').style.display = 'block';
                document.getElementById('editor-title').textContent = 'Edit Exercise';
                loadExerciseIntoForm(currentExercise);
            },

            cancelEdit: () => {
                document.getElementById('library-section').style.display = 'block';
                document.getElementById('editor-section').style.display = 'none';
                currentExercise = null;
            },

            saveExercise: async () => {
                const exerciseData = collectExerciseData();

                try {
                    let txId;
                    if (currentExercise) {
                        txId = await updateExercise(currentExercise.id, exerciseData);
                    } else {
                        txId = await createExercise(exerciseData);
                    }

                    showTransactionToast(txId, { message: currentExercise ? 'Updated:' : 'Created:' });

                    // Reload library and return to list
                    const library = await loadExerciseLibraryShared();
                    exercises = library.exercises || [];
                    renderExerciseList();
                    populateExerciseSelector();

                    document.getElementById('library-section').style.display = 'block';
                    document.getElementById('editor-section').style.display = 'none';
                    currentExercise = null;
                } catch (error) {
                    console.error('[Save Exercise] Error:', error);
                    alert('Failed to save exercise: ' + error.message);
                }
            },

            deleteExercise: async (e) => {
                const id = e.target.dataset.action.split(':')[1];
                const ex = exercises.find(ex => ex.id === id);
                if (!ex) return;

                if (!confirm(`Archive exercise "${ex.canonical_name}"?`)) return;

                try {
                    const txId = await archiveExercise(id);
                    showTransactionToast(txId, { message: 'Archived:' });

                    // Reload library
                    const library = await loadExerciseLibraryShared();
                    exercises = library.exercises || [];
                    renderExerciseList();
                } catch (error) {
                    console.error('[Delete Exercise] Error:', error);
                    alert('Failed to archive exercise: ' + error.message);
                }
            },

            'addMuscle:primary': () => addDynamicField('primary-muscles-list', 'e.g., gluteus maximus'),
            'addMuscle:secondary': () => addDynamicField('secondary-muscles-list', 'e.g., hamstrings'),
            'addEquipment:required': () => addDynamicField('equipment-required-list', 'e.g., resistance band', allEquipmentOptions),
            'addEquipment:optional': () => addDynamicField('equipment-optional-list', 'e.g., yoga block', allEquipmentOptions),
            'addCue:external': () => addDynamicField('external-cues-list', 'e.g., Look straight ahead'),
            'addCue:motor': () => addDynamicField('motor-cues-list', 'e.g., Squeeze glutes at top'),
            'addCue:compensation': () => addDynamicField('compensation-warnings-list', 'e.g., Avoid arching lower back'),
            'addCue:safety': () => addDynamicField('safety-flags-list', 'e.g., Stop if sharp pain occurs'),
            'addTag:functional': () => addDynamicField('tags-functional-list', 'e.g., balance'),
            'addTag:format': () => addDynamicField('tags-format-list', 'e.g., standing'),
            'addTag:heatmap': () => addDynamicField('tags-heatmap-list', 'e.g., hip'),

            removeDynamicField: (e) => {
                e.target.closest('.dynamic-field').remove();
            },

            addRole: async () => {
                const exerciseId = document.getElementById('role-exercise-select').value;
                if (!exerciseId) {
                    alert('Please select an exercise first');
                    return;
                }

                const region = document.getElementById('new-role-region').value;
                const capacity = document.getElementById('new-role-capacity').value;
                const focus = document.getElementById('new-role-focus').value.trim();
                const contribution = document.getElementById('new-role-contribution').value;

                if (!region || !capacity || !contribution) {
                    alert('Please fill in region, capacity, and contribution');
                    return;
                }

                try {
                    const txId = await createRole(exerciseId, {
                        region,
                        capacity,
                        focus: focus || null,
                        contribution
                    });

                    showTransactionToast(txId, { message: 'Role added:' });

                    // Reload roles
                    const library = await loadExerciseLibraryShared();
                    exerciseRoles = library.exerciseRoles || {};
                    loadExerciseRoles();

                    // Clear form
                    document.getElementById('new-role-region').value = '';
                    document.getElementById('new-role-capacity').value = '';
                    document.getElementById('new-role-focus').value = '';
                    document.getElementById('new-role-contribution').value = '';
                } catch (error) {
                    console.error('[Add Role] Error:', error);
                    alert('Failed to add role: ' + error.message);
                }
            },

            deleteRole: async (e) => {
                const parts = e.target.dataset.action.split(':');
                const exerciseId = parts[1];
                const roleIndex = parseInt(parts[2]);

                if (!confirm('Delete this role?')) return;

                try {
                    const txId = await deleteRole(exerciseId, roleIndex);
                    showTransactionToast(txId, { message: 'Role deleted:' });

                    // Reload roles
                    const library = await loadExerciseLibraryShared();
                    exerciseRoles = library.exerciseRoles || {};
                    loadExerciseRoles();
                } catch (error) {
                    console.error('[Delete Role] Error:', error);
                    alert('Failed to delete role: ' + error.message);
                }
            },

            updateVocabulary: async () => {
                const category = document.getElementById('vocab-category').value;
                const term = document.getElementById('vocab-term').value;
                const definition = document.getElementById('vocab-definition').value.trim();

                if (!category || !term || !definition) {
                    alert('Please fill in all fields');
                    return;
                }

                try {
                    const txId = await updateVocabulary(category, term, definition);
                    showTransactionToast(txId, { message: 'Vocabulary updated:' });

                    // Clear form
                    document.getElementById('vocab-definition').value = '';
                } catch (error) {
                    console.error('[Update Vocabulary] Error:', error);
                    alert('Failed to update vocabulary: ' + error.message);
                }
            },

            updateDosage: async () => {
                const exerciseId = document.getElementById('dosage-exercise-select').value;
                if (!exerciseId) {
                    alert('Please select an exercise first');
                    return;
                }

                const exercise = exercises.find(ex => ex.id === exerciseId);
                if (!exercise) return;

                const sets = parseInt(document.getElementById('dosage-sets').value);
                if (!sets || sets < 1) {
                    alert('Please enter a valid number of sets');
                    return;
                }

                // Collect dosage data based on visible fields (pattern modifiers)
                const modifiers = exercise.pattern_modifiers || [];
                const dosageData = {
                    sets,
                    timestamp: serverTimestamp(),
                    version: 1
                };

                // Add conditional fields based on pattern modifiers
                const reps = parseInt(document.getElementById('dosage-reps').value);
                const duration = parseInt(document.getElementById('dosage-duration').value);
                const hold = parseInt(document.getElementById('dosage-hold').value);
                const distance = parseInt(document.getElementById('dosage-distance').value);

                if (modifiers.includes('duration_seconds') && duration) {
                    dosageData.duration_seconds = duration;
                } else if (!modifiers.includes('AMRAP') && reps) {
                    dosageData.reps = reps;
                }

                if (modifiers.includes('hold_seconds') && hold) {
                    dosageData.hold_seconds = hold;
                }

                if (modifiers.includes('distance_feet') && distance) {
                    dosageData.distance_feet = distance;
                }

                try {
                    const db = window.db;
                    const user = window.auth.currentUser;
                    if (!user) {
                        alert('User not authenticated');
                        return;
                    }

                    // Create new version (append-only, preserves history)
                    const versionULID = ulid();
                    const dosageRef = doc(db, `users/${user.uid}/dosages/${exerciseId}/versions/${versionULID}`);

                    await setDoc(dosageRef, dosageData);

                    showTransactionToast(versionULID, { message: 'Dosage updated:' });

                    // Reload dosage to show updated version
                    await loadExerciseDosage();

                } catch (error) {
                    console.error('[Update Dosage] Error:', error);
                    alert('Failed to update dosage: ' + error.message);
                }
            },

            copyTransactionId: copyTransactionId
        };

        // Bind action handlers
        bindActionHandlers(document.body, actionHandlers);

        // Collect exercise data from form
        function collectExerciseData() {
            const getCheckedValues = (selector) => {
                return Array.from(document.querySelectorAll(selector + ' input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
            };

            const getDynamicFieldValues = (listId) => {
                return Array.from(document.querySelectorAll(`#${listId} input`))
                    .map(input => input.value.trim())
                    .filter(val => val !== '');
            };

            // Get canonical name from dropdown or custom input
            const nameSelect = document.getElementById('ex-name-select');
            const nameCustom = document.getElementById('ex-name-custom');
            const canonical_name = nameSelect.value === '__other__'
                ? nameCustom.value.trim()
                : nameSelect.value;

            return {
                canonical_name,
                pt_category: document.getElementById('ex-category').value,
                description: document.getElementById('ex-desc').value.trim(),
                primary_muscles: getDynamicFieldValues('primary-muscles-list'),
                secondary_muscles: getDynamicFieldValues('secondary-muscles-list'),
                pattern: document.getElementById('ex-pattern').value,
                pattern_modifiers: getCheckedValues('#pattern-modifiers-list'),
                equipment: {
                    required: getDynamicFieldValues('equipment-required-list'),
                    optional: getDynamicFieldValues('equipment-optional-list')
                },
                form_parameters_required: getCheckedValues('#form-params-list'),
                tags: {
                    functional: getDynamicFieldValues('tags-functional-list'),
                    format: getDynamicFieldValues('tags-format-list'),
                    heatmap: getDynamicFieldValues('tags-heatmap-list')
                },
                guidance: {
                    external_cues: getDynamicFieldValues('external-cues-list'),
                    motor_cues: getDynamicFieldValues('motor-cues-list'),
                    compensation_warnings: getDynamicFieldValues('compensation-warnings-list'),
                    safety_flags: getDynamicFieldValues('safety-flags-list')
                },
                lifecycle: {
                    status: document.getElementById('ex-lifecycle-status').value,
                    effective_start_date: document.getElementById('ex-lifecycle-start').value || null,
                    effective_end_date: document.getElementById('ex-lifecycle-end').value || null
                },
                added_date: currentExercise ? currentExercise.added_date : new Date().toISOString().split('T')[0],
                updated_date: new Date().toISOString().split('T')[0]
            };
        }

        // Clear exercise form
        function clearExerciseForm() {
            document.getElementById('ex-name-select').value = '';
            document.getElementById('ex-name-custom').value = '';
            document.getElementById('ex-name-custom').style.display = 'none';
            document.getElementById('ex-category').value = '';
            document.getElementById('ex-desc').value = '';
            document.getElementById('ex-pattern').value = '';
            document.getElementById('ex-lifecycle-status').value = 'active';
            document.getElementById('ex-lifecycle-start').value = '';
            document.getElementById('ex-lifecycle-end').value = '';

            // Clear checkboxes
            document.querySelectorAll('#pattern-modifiers-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#form-params-list input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Clear dynamic lists
            document.getElementById('primary-muscles-list').innerHTML = '';
            document.getElementById('secondary-muscles-list').innerHTML = '';
            document.getElementById('equipment-required-list').innerHTML = '';
            document.getElementById('equipment-optional-list').innerHTML = '';
            document.getElementById('external-cues-list').innerHTML = '';
            document.getElementById('motor-cues-list').innerHTML = '';
            document.getElementById('compensation-warnings-list').innerHTML = '';
            document.getElementById('safety-flags-list').innerHTML = '';
            document.getElementById('tags-functional-list').innerHTML = '';
            document.getElementById('tags-format-list').innerHTML = '';
            document.getElementById('tags-heatmap-list').innerHTML = '';
        }

        // Load exercise into form
        function loadExerciseIntoForm(exercise) {
            // Populate exercise name dropdown if not already populated
            if (!document.getElementById('ex-name-select').options.length || document.getElementById('ex-name-select').options.length <= 1) {
                populateExerciseNameDropdown();
            }

            // Set exercise name (select from dropdown or use "Other" + custom input)
            const nameSelect = document.getElementById('ex-name-select');
            const nameCustom = document.getElementById('ex-name-custom');
            const nameOption = Array.from(nameSelect.options).find(opt => opt.value === exercise.canonical_name);

            if (nameOption) {
                nameSelect.value = exercise.canonical_name;
                nameCustom.style.display = 'none';
            } else {
                nameSelect.value = '__other__';
                nameCustom.value = exercise.canonical_name || '';
                nameCustom.style.display = 'block';
            }

            document.getElementById('ex-category').value = exercise.pt_category || '';
            document.getElementById('ex-desc').value = exercise.description || '';
            document.getElementById('ex-pattern').value = exercise.pattern || '';
            document.getElementById('ex-lifecycle-status').value = exercise.lifecycle?.status || 'active';
            document.getElementById('ex-lifecycle-start').value = exercise.lifecycle?.effective_start_date || '';
            document.getElementById('ex-lifecycle-end').value = exercise.lifecycle?.effective_end_date || '';

            // Set pattern modifiers checkboxes
            (exercise.pattern_modifiers || []).forEach(mod => {
                const checkbox = document.querySelector(`#pattern-modifiers-list input[value="${mod}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Set form params checkboxes
            (exercise.form_parameters_required || []).forEach(param => {
                const checkbox = document.querySelector(`#form-params-list input[value="${param}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Load dynamic lists
            const loadDynamicList = (listId, values) => {
                const list = document.getElementById(listId);
                list.innerHTML = '';
                (values || []).forEach(value => {
                    const field = document.createElement('div');
                    field.className = 'dynamic-field';
                    field.innerHTML = `
                        <input type="text" class="form-input" value="${value}" style="flex: 1;">
                        <button class="remove-btn" data-action="removeDynamicField">‚úï</button>
                    `;
                    list.appendChild(field);
                    bindActionHandlers(field, actionHandlers);
                });
            };

            loadDynamicList('primary-muscles-list', exercise.primary_muscles);
            loadDynamicList('secondary-muscles-list', exercise.secondary_muscles);
            loadDynamicList('equipment-required-list', exercise.equipment?.required);
            loadDynamicList('equipment-optional-list', exercise.equipment?.optional);
            loadDynamicList('external-cues-list', exercise.guidance?.external_cues);
            loadDynamicList('motor-cues-list', exercise.guidance?.motor_cues);
            loadDynamicList('compensation-warnings-list', exercise.guidance?.compensation_warnings);
            loadDynamicList('safety-flags-list', exercise.guidance?.safety_flags);
            loadDynamicList('tags-functional-list', exercise.tags?.functional);
            loadDynamicList('tags-format-list', exercise.tags?.format);
            loadDynamicList('tags-heatmap-list', exercise.tags?.heatmap);
        }
    </script>
</body>
</html>
